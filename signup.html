<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mie - Sign Up</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: calc(100vh - 30px);
      margin: 0;
      padding: 20px 10px;
      box-sizing: border-box;
    }
    .container {
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .logo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 8px;
    }
    .welcome {
      font-family: 'Montserrat', sans-serif;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #222;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #555;
      font-size: 16px;
      font-weight: normal;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      background: #fff;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled { background: #aaa; cursor: not-allowed; }

    .message {
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
      display: none;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
    }
    .error   { color: #D8000C; background: #FFD2D2; border: 1px solid #D8000C; }
    .success { color: #4F8A10; background: #DFF2BF; border: 1px solid #4F8A10; }
    .warning { color: #9F6000; background: #FEEFB3; border: 1px solid #9F6000; }

    .link { margin-top: 12px; font-size: 14px; }
    .link a { color: #4CAF50; text-decoration: none; font-weight: bold; }

    @media (max-width: 480px) { body { padding: 10px 10px; } }
  </style>
</head>
<body>
  <div class="container">
    <a href="dashboard.html" class="logo-link">
      <img src="https://github.com/rylhong/mie-pages/blob/main/logo_white_70x70.png?raw=true" alt="Mie Logo" class="logo">
    </a>
    <h1 class="welcome">Hey, it's Mie.</h1>
    <h2>Welcome</h2>

    <form id="signupForm">
      <input type="text" id="fullName" placeholder="Full Name (e.g., John Doe)" required />
      <input type="email" id="emailAddress" placeholder="Gmail Account (e.g., johndoe@gmail.com)" required />
      <input type="tel" id="phoneNumber" placeholder="Cell Phone Number (e.g., 16509009000)" required />

      <!-- PIN removed; Event Color select -->
      <select id="eventColor" required>
        <option value="" disabled selected>Select Calendar Event Color</option>
        <option value="1">Lavender</option>
        <option value="2">Sage</option>
        <option value="3">Grape</option>
        <option value="4">Flamingo</option>
        <option value="5">Banana</option>
        <option value="6">Tangerine</option>
        <option value="7">Peacock</option>
        <option value="8">Graphite</option>
        <option value="9">Blueberry</option>
        <option value="10">Basil</option>
        <option value="11">Tomato</option>
      </select>

      <div class="message error"   id="errorMsg"></div>
      <div class="message success" id="successMsg"></div>
      <div class="message warning" id="warningMsg"></div>

      <button type="submit" id="submitButton">Sign Up</button>
    </form>

    <div class="link">
      Already have an account? <a href="dashboard.html">Sign In</a>
    </div>
  </div>

  <script>
    // IMPORTANT:
    // After you redeploy the Apps Script web app (NEW VERSION), update this URL.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylIIP2toW0MugikZ-IPxReCMwHDCCdukM43DgLXrEZTc-b-bzbVwFOaOWk0Xb5Z5po/exec";

    const form              = document.getElementById("signupForm");
    const fullNameInput     = document.getElementById("fullName");
    const emailInput        = document.getElementById("emailAddress");
    const phoneInput        = document.getElementById("phoneNumber");
    const eventColorSelect  = document.getElementById("eventColor");

    const errorMsg          = document.getElementById("errorMsg");
    const successMsg        = document.getElementById("successMsg");
    const warningMsg        = document.getElementById("warningMsg");
    const submitButton      = document.getElementById("submitButton");

    // AUTO PIN
    const AUTO_PIN = "4664";

    function hideAllMessages(){ errorMsg.style.display=successMsg.style.display=warningMsg.style.display="none"; }
    function showError(m){ hideAllMessages(); errorMsg.innerHTML=m; errorMsg.style.display="block"; }
    function showSuccess(m){ hideAllMessages(); successMsg.innerHTML=m; successMsg.style.display="block"; }
    function showWarning(m){ hideAllMessages(); warningMsg.innerHTML=m; warningMsg.style.display="block"; }

    async function pingHealth(){
      try{
        const r = await fetch(SCRIPT_URL, { method: "GET", cache: "no-store" });
        return r.ok;
      }catch(_){ return false; }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideAllMessages();

      const errs = [];
      if (!/^[A-Za-z]+ [A-Za-z]+$/.test(fullNameInput.value.trim())) errs.push("Full Name must include FIRST and LAST name (letters only).");
      if (!/^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(emailInput.value.trim())) errs.push("A valid @gmail.com address is required.");
      if (!/^1\d{10}$/.test(phoneInput.value.trim())) errs.push("Phone number must start with '1' and be 11 digits (e.g., 16509009000).");
      if (!eventColorSelect.value) errs.push("Please select a Calendar Event Color.");
      if (errs.length){ showError(errs.join("<br>")); return; }

      submitButton.disabled = true;
      submitButton.textContent = "Signing Up...";

      // FIX:
      // Send the OPTION TEXT (e.g., "Sage") so tracker Column O stores a readable value.
      const selectedEventColorName =
        eventColorSelect.options[eventColorSelect.selectedIndex].text.trim();

      const payload = {
        fullName:     fullNameInput.value.trim(),
        emailAddress: emailInput.value.trim(),
        phoneNumber:  phoneInput.value.trim(),
        pin:          AUTO_PIN,
        eventColor:   selectedEventColorName,
        timestamp:    new Date().toISOString()
      };

      try {
        const okHealth = await pingHealth();
        if(!okHealth){
          throw new Error("Web app not reachable. Verify deployment URL and access: Execute as 'Me', Who has access = 'Anyone'.");
        }

        const resp = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const t = await resp.text().catch(() => "");
          throw new Error(`HTTP ${resp.status} ${resp.statusText}${t ? " — " + t : ""}`);
        }

        const data = await resp.json().catch(() => null);
        if (!data) throw new Error("Invalid JSON response from server.");

        handleResponse(data);
        form.reset();

      } catch (err) {
        console.error(err);
        showError("❌ Submission failed. " + (err && err.message ? err.message : "Please retry or contact support."));
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Sign Up";
      }
    });

    function handleResponse(data){
      if (data.status !== "success") {
        showError("❌ " + (data.message || "Unexpected server response."));
        return;
      }
      if (!data.approved) {
        showWarning("⚠️ PIN invalid or approval failed. Your application is pending.");
        return;
      }
      if (data.approved && !data.emailSent) {
        showWarning("✅ Approved, but welcome email failed. We'll follow up.");
        return;
      }
      if (data.provisioned) {
        showSuccess("✅ Welcome to Mie! Your account is approved and a welcome email has been sent to your inbox.");
      } else {
        const reason = (data.details && (data.details.error || data.details.message))
          ? ` Reason: ${data.details.error || data.details.message}`
          : "";
        showWarning("✅ Email sent, but provisioning hit a snag." + reason);
      }
    }
  </script>
</body>
</html>
