// ============================================================================
// MIE SIGNUP WEB APP + INLINE PROVISIONING
// Version: v4.8 (deployment-verifiable)
// ============================================================================

const CONFIG = {
  VALID_PIN: "4664",
  REQUIRE_PIN: true,
  FROM_NAME: "Mie Team",
  DASHBOARD_URL: "https://www.mie.today/dashboard",

  SPREADSHEET_ID: "1T9qiDQa1DUwMF06V6M_TBO0Nc-36IKeTuIWkpdxh40U",
  SHEET_NAME: "Sheet1",

  TEMPLATE_SPREADSHEET_ID: "10VEAzvqwiiVtOyzDAZgQefI7-7I4F6k_wOU3SoSBwsE",
  MASTER_FOLDER_ID: "1NHmZddWC6vSMS49VzvODhwjpiN6-nGZK",

  PARENT_LABEL: "Mie_users",
  LABEL_PREFIX: "",

  // Tracker columns (1-based)
  COL_EMAIL_SENT: 7,          // G
  COL_LABEL_NAME: 8,          // H
  COL_FOLDER_NAME: 9,         // I
  COL_SPREADSHEET_LINK: 10,   // J
  COL_FULL_LABEL_NAME: 11,    // K
  COL_FOLDER_ID: 12,          // L
  COL_SPREADSHEET_ID: 13,     // M
  COL_EVENT_COLOR: 15         // O
};

const OPTIONAL_SCRIPT_HEADERS = {
  SCRIPT_ID:   "Script ID",
  SCRIPT_LINK: "Script Link"
};

function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({
      status: "success",
      message: "Mie signup web app running",
      version: "v4.8",
      timestamp: new Date().toISOString()
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const requestId = Date.now();
  try {
    const data = JSON.parse(e.postData.contents || "{}");
    if (!data.fullName || !data.emailAddress) throw new Error("Missing required fields: fullName or emailAddress");

    const result = processSignup(data, requestId);
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "error",
      message: String(err && err.message ? err.message : err),
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function processSignup(userData, requestId) {
  const isApproved = validatePIN(userData.pin);

  // Always write the row first (A–G) and Event Color (O).
  const rowNumber = saveToSpreadsheet_(userData, isApproved);

  let emailSent = false;
  let provisioned = false;
  let details = {};

  if (isApproved) {
    emailSent = sendWelcomeEmail_(userData.emailAddress, userData.fullName);
    updateEmailStatus_(rowNumber, emailSent ? "Yes" : "Failed");

    if (emailSent) {
      try {
        const sheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEET_NAME);
        const optCols = findOptionalScriptColumns_(sheet);

        const res = provisionRow_(
          rowNumber,
          String(userData.fullName || ""),
          String(userData.emailAddress || ""),
          String(userData.phoneNumber || ""),
          sheet,
          optCols
        );

        provisioned = !!res.success;
        details = res.success ? { message: "Provisioned" } : { error: res.error || "Provisioning failed" };

      } catch (pErr) {
        provisioned = false;
        details = { error: String(pErr && pErr.message ? pErr.message : pErr) };
      }
    }
  } else {
    updateEmailStatus_(rowNumber, "Not approved");
  }

  return {
    status: "success",
    approved: isApproved,
    emailSent,
    provisioned,
    details,
    rowNumber,
    requestId,
    timestamp: new Date().toISOString()
  };
}

function validatePIN(userPin) {
  if (!CONFIG.REQUIRE_PIN) return true;
  return String(userPin || "").trim() === String(CONFIG.VALID_PIN).trim();
}

function saveToSpreadsheet_(userData, isApproved) {
  const sheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEET_NAME);
  if (!sheet) throw new Error(`Sheet "${CONFIG.SHEET_NAME}" not found`);

  const rowData = [
    new Date(),                  // A Timestamp
    userData.fullName || "",     // B
    userData.emailAddress || "", // C
    userData.phoneNumber || "",  // D
    userData.pin || "",          // E
    isApproved ? "Yes" : "No",   // F
    ""                           // G Email Sent
  ];

  sheet.appendRow(rowData);
  const rowNumber = sheet.getLastRow();

  // Event Color -> Column O (stores readable name like "Sage")
  const eventColor = String(userData.eventColor || "").trim();
  sheet.getRange(rowNumber, CONFIG.COL_EVENT_COLOR).setValue(eventColor);

  return rowNumber;
}

function updateEmailStatus_(rowNumber, status) {
  const sheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID).getSheetByName(CONFIG.SHEET_NAME);
  sheet.getRange(rowNumber, CONFIG.COL_EMAIL_SENT).setValue(status);
}

function sendWelcomeEmail_(emailAddress, fullName) {
  try {
    const first = (String(fullName || "").trim().split(/\s+/)[0]) || "there";
    const subject = "Welcome to Mie - Access Granted!";
    const htmlBody = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: #4CAF50; color: white; padding: 20px; text-align: center;">
          <h1>Welcome to Mie!</h1>
        </div>
        <div style="padding: 20px; background: #f9f9f9;">
          <p>Hi ${first},</p>
          <p>Welcome to Mie! Your account has been approved and you now have access to your dashboard.</p>
          <div style="margin: 20px 0; text-align: center;">
            <a href="${CONFIG.DASHBOARD_URL}" style="background: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">Access Your Dashboard</a>
          </div>
          <p style="color: #666; font-size: 14px;">This is an automated message from the Mie system. Please do not reply to this email.</p>
        </div>
      </div>`;
    const textBody = `Hi ${first},

Welcome to Mie! Your account has been approved and you now have access to your dashboard.

Access your dashboard here: ${CONFIG.DASHBOARD_URL}

Best regards,
The Mie Team`;

    GmailApp.sendEmail(emailAddress, subject, textBody, { htmlBody, name: CONFIG.FROM_NAME });
    return true;
  } catch (e) {
    return false;
  }
}

function provisionRow_(rowNumber, fullName, email, phone, sheet, optCols) {
  const nameNoSpaces = String(fullName || "").replace(/\s+/g, "");
  const last4 = String(phone || "").replace(/\D/g, "").slice(-4) || "XXXX";

  const baseName = `${nameNoSpaces}_${last4}`;
  const shortLabel = baseName;
  const fullLabel = `${CONFIG.PARENT_LABEL}/${shortLabel}`;

  try {
    // Gmail label + filter
    ensureLabelPath_(fullLabel);
    createGmailFilterForUser_(email, fullLabel);
    backfillThreads_(email, fullLabel);

    // Folder
    const userFolder = ensureUserFolder_(baseName);
    const folderId = userFolder.getId();
    const folderUrl = userFolder.getUrl();

    // Spreadsheet copy ONLY (bound script comes with it)
    const copied = DriveApp.getFileById(CONFIG.TEMPLATE_SPREADSHEET_ID).makeCopy(baseName, userFolder);
    const spreadsheetId = copied.getId();
    const spreadsheetUrl = SpreadsheetApp.openById(spreadsheetId).getUrl();

    // Write tracker H–M BEFORE any optional sharing, so you don’t lose provisioning data.
    sheet.getRange(rowNumber, CONFIG.COL_LABEL_NAME).setValue(shortLabel); // H
    setHyperlinkFormula_(sheet, rowNumber, CONFIG.COL_FOLDER_NAME, baseName, folderUrl); // I
    setHyperlinkFormula_(sheet, rowNumber, CONFIG.COL_SPREADSHEET_LINK, "Open Spreadsheet", spreadsheetUrl); // J
    sheet.getRange(rowNumber, CONFIG.COL_FULL_LABEL_NAME).setValue(fullLabel); // K
    sheet.getRange(rowNumber, CONFIG.COL_FOLDER_ID).setValue(folderId); // L
    sheet.getRange(rowNumber, CONFIG.COL_SPREADSHEET_ID).setValue(spreadsheetId); // M

    // Folder share (viewer, no notify) MUST NOT block provisioning.
    shareFolderViewerNoNotify_SAFE_(folderId, email);

    return { success: true };

  } catch (err) {
    return { success: false, error: err && err.message ? err.message : String(err) };
  }
}

// ----- Gmail helpers -----

function ensureLabelPath_(fullPath) {
  const parts = String(fullPath).split("/").map(s => s.trim()).filter(Boolean);
  let current = "";
  for (let i = 0; i < parts.length; i++) {
    current = (i === 0) ? parts[i] : current + "/" + parts[i];
    let lbl = GmailApp.getUserLabelByName(current);
    if (!lbl) GmailApp.createLabel(current);
  }
}

function createGmailFilterForUser_(fromEmail, labelName) {
  const userLabel = GmailApp.getUserLabelByName(labelName);
  if (!userLabel) throw new Error(`Label "${labelName}" not found`);

  const filter = {
    criteria: { from: fromEmail },
    action: { addLabelIds: [userLabel.getId()], neverSpam: true }
  };

  // Requires Advanced Gmail API enabled (Gmail)
  return Gmail.Users.Settings.Filters.create(filter, "me");
}

function backfillThreads_(fromEmail, labelName) {
  const label = GmailApp.getUserLabelByName(labelName);
  if (!label) return;

  const threads = GmailApp.search(`from:${fromEmail} -label:"${labelName}"`, 0, 100);
  threads.forEach(th => {
    th.addLabel(label);
    if (th.isInSpam() || th.isInTrash()) th.moveToInbox();
  });
}

// ----- Drive helpers -----

function ensureUserFolder_(folderName) {
  const master = DriveApp.getFolderById(CONFIG.MASTER_FOLDER_ID);
  const it = master.getFoldersByName(folderName);
  return it.hasNext() ? it.next() : master.createFolder(folderName);
}

/**
 * This function will NEVER throw.
 * It supports:
 * - Drive API v2: Drive.Permissions.insert
 * - Drive API v3: Drive.Permissions.create
 * - Fallback: DriveApp.addViewer (may send notification depending on Google)
 */
function shareFolderViewerNoNotify_SAFE_(folderId, userEmail) {
  try {
    const email = String(userEmail || "").trim();
    if (!folderId || !email) return;

    if (typeof Drive !== "undefined" && Drive && Drive.Permissions) {
      if (typeof Drive.Permissions.insert === "function") {
        Drive.Permissions.insert({ role: "reader", type: "user", value: email }, folderId, { sendNotificationEmails: false });
        return;
      }
      if (typeof Drive.Permissions.create === "function") {
        Drive.Permissions.create({ role: "reader", type: "user", emailAddress: email }, folderId, { sendNotificationEmails: false });
        return;
      }
    }

    DriveApp.getFolderById(folderId).addViewer(email);

  } catch (e) {
    // ignored by design
  }
}

// ----- Sheet utilities -----

function setHyperlinkFormula_(sheet, row, col, text, url) {
  if (!url) { sheet.getRange(row, col).setValue(text || ""); return; }
  const safeText = String(text || "").replace(/"/g, '""');
  const safeUrl = String(url || "").replace(/"/g, '""');
  sheet.getRange(row, col).setFormula(`=HYPERLINK("${safeUrl}","${safeText}")`);
}

function findOptionalScriptColumns_(sheet) {
  const lastCol = sheet.getLastColumn() || 1;
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(h => String(h || "").trim().toLowerCase());
  const idx = name => {
    const i = headers.indexOf(String(name).toLowerCase());
    return i >= 0 ? i + 1 : 0;
  };
  return {
    SCRIPT_ID_COL: idx(OPTIONAL_SCRIPT_HEADERS.SCRIPT_ID),
    SCRIPT_LINK_COL: idx(OPTIONAL_SCRIPT_HEADERS.SCRIPT_LINK)
  };
}
