<script>
(function() {
    const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
    const API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send';

    let tokenClient;
    let calendar; 

    // --- DOM Elements ---
    const authArea = document.getElementById('auth-area');
    const calendarContent = document.getElementById('calendar-content');
    const calendarContainer = document.getElementById('calendar-container');
    const messagingSection = document.getElementById('messaging-section');
    const signoutButton = document.getElementById('signout_button');
    const sendButton = document.getElementById('send-button');
    const messageLog = document.getElementById('message-log');
    const messageInput = document.getElementById('message-input');
    
    // --- Event Listeners ---
    signoutButton.addEventListener('click', handleSignOut);
    sendButton.addEventListener('click', sendEmail);
    messageInput.addEventListener('input', () => {
        const hasText = messageInput.value.trim() !== '';
        sendButton.disabled = !hasText;
        sendButton.classList.toggle('disabled', !hasText);
    });

    // --- Initialization ---
    function initializeGapiClient() {
        gapi.client.init({
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
                "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
            ],
        }).then(() => console.log("GAPI client initialized."))
          .catch(err => console.error("Error initializing GAPI client:", err));
    }
    gapi.load('client', initializeGapiClient);

    window.handleCredentialResponse = (response) => {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: API_SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    handleAuthSuccess();
                } else {
                    console.error('Failed to get access token.', tokenResponse);
                }
            },
        });
        tokenClient.requestAccessToken();
    };

    // --- Core Application Logic ---
    function handleAuthSuccess() {
        updateUIForSignIn();
        displayMonthlyCalendar();
    }

    function handleSignOut() {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                console.log('Access token revoked.');
                gapi.client.setToken(null);
                updateUIForSignOut();
            });
        }
        updateUIForSignOut();
    }

    function displayMonthlyCalendar() {
        if (calendar) {
            calendar.destroy();
        }
        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            },
            events: async (fetchInfo, successCallback, failureCallback) => {
                try {
                    const calendarListResponse = await gapi.client.calendar.calendarList.list();
                    const calendars = calendarListResponse.result.items;
                    
                    // --- DEBUGGING LINE ADDED ---
                    // This will show us exactly which calendars the API found.
                    console.log("Found these calendars in your list:", calendars);

                    const eventPromises = calendars.map(cal => {
                        return gapi.client.calendar.events.list({
                            'calendarId': cal.id,
                            'timeMin': fetchInfo.start.toISOString(),
                            'timeMax': fetchInfo.end.toISOString(),
                            'showDeleted': false,
                            'singleEvents': true,
                        }).then(response => {
                            return response.result.items.map(event => ({
                                ...event,
                                color: cal.backgroundColor 
                            }));
                        });
                    });

                    const allEventArrays = await Promise.all(eventPromises);
                    const allEvents = allEventArrays.flat().map(event => ({
                        title: event.summary,
                        start: event.start.dateTime || event.start.date,
                        end: event.end.dateTime || event.end.date,
                        url: event.htmlLink,
                        allDay: !event.start.dateTime,
                        backgroundColor: event.color,
                        borderColor: event.color
                    }));
                    
                    successCallback(allEvents);
                } catch (err) {
                    console.error('Error fetching calendar data:', err);
                    failureCallback(err);
                }
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) {
                    window.open(info.event.url, "_blank");
                }
            }
        });

        calendar.render();
    }
    
    async function sendEmail() {
        let userProfile;
        try {
            const profileResponse = await gapi.client.gmail.users.getProfile({ 'userId': 'me' });
            userProfile = profileResponse.result;
        } catch (err) {
            logMessage("Error: Could not retrieve your email address.", "error");
            return;
        }
        
        const messageText = messageInput.value;
        if (!messageText.trim()) return;

        const emailLines = [`To: ${userProfile.emailAddress}`, `From: ${userProfile.emailAddress}`, `Subject: Message from My Dashboard`, 'Content-Type: text/plain; charset=utf-8', '', messageText];
        const email = emailLines.join('\r\n');
        const base64EncodedEmail = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        logMessage("Sending email...", "info");
        sendButton.disabled = true;
        sendButton.classList.add('disabled');

        try {
            await gapi.client.gmail.users.messages.send({ 'userId': 'me', 'resource': { 'raw': base64EncodedEmail } });
            logMessage("Email sent successfully!", "success");
            messageInput.value = "";
        } catch (err) {
            console.error("Failed to send email:", err);
            logMessage(`Failed to send email: ${err.result?.error?.message || 'Unknown error'}.`, "error");
            sendButton.disabled = false;
            sendButton.classList.remove('disabled');
        }
    }

    // --- UI and Utilities ---
    function updateUIForSignIn() {
        authArea.classList.add('hidden');
        calendarContent.classList.remove('hidden');
        messagingSection.classList.remove('hidden');
    }

    function updateUIForSignOut() {
        authArea.classList.remove('hidden');
        calendarContent.classList.add('hidden');
        messagingSection.classList.add('hidden');
        calendarContainer.innerHTML = '';
        messageLog.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Your sent messages will appear here...</div>`;
        messageInput.value = "";
    }
    
    function logMessage(text, type = 'info') {
        if (messageLog.children.length === 1 && messageLog.firstChild.textContent.startsWith('Your sent messages')) {
            messageLog.innerHTML = '';
        }
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        const colors = { success: 'text-green-500', error: 'text-red-500', info: 'text-gray-900 dark:text-gray-200' };
        p.className = `text-sm mb-1 ${colors[type]}`;
        messageLog.appendChild(p);
        messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    updateUIForSignOut();
})();
</script>
