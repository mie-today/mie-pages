<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MIE Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100">
  <div class="oauth-app-container h-screen">
    <div class="dashboard-layout">
      <!-- Calendar -->
      <section id="calendar-section">
        <!-- Before login -->
        <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
          <h2 class="text-lg font-semibold text-center">Sign in to view your Google Calendar</h2>
          <div id="g_id_onload"
            data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
            data-context="signin"
            data-ux_mode="popup"
            data-callback="handleCredentialResponse"
            data-auto_prompt="false"></div>
          <div class="g_id_signin"
            data-type="standard"
            data-shape="pill"
            data-theme="dark"
            data-text="signin_with"
            data-size="large"
            data-logo_alignment="left"></div>
        </div>

        <!-- After login -->
        <div id="calendar-content" class="hidden flex flex-col flex-grow h-full">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Your Calendar</h2>
            <button id="signout_button"
              class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">
              Sign Out
            </button>
          </div>
          <div id="calendar-container" class="flex-grow overflow-y-auto"></div>
        </div>
      </section>

      <!-- Messaging -->
      <section id="messaging-section" class="hidden">
        <h2 class="text-lg font-semibold mb-4">Send a Message</h2>
        <div id="message-log" class="bg-gray-50 p-3 rounded mb-4 flex-grow overflow-y-auto">
          <div class="text-sm text-gray-500">Your sent messages will appear here...</div>
        </div>

        <textarea id="message-input" placeholder="Type your message..."
          class="rounded border px-3 py-2 min-h-[80px] flex-shrink-0"></textarea>

        <div class="flex items-center gap-2 mt-2 flex-shrink-0">
          <label for="file-input"
            class="cursor-pointer bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-full font-bold">Add Image</label>
          <input id="file-input" type="file" accept="image/*" class="hidden" />
        </div>

        <button id="send-button"
          class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full mt-4 disabled"
          disabled>Send</button>
      </section>
    </div>
  </div>

  <style>
    .dashboard-layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: 100%;
    }
    @media(min-width:1280px){
      .dashboard-layout {
        flex-direction: row;
      }
    }
    section {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      min-height: 0; /* critical to allow children scroll */
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
      padding: 1.25rem;
      overflow: hidden;
    }
    #calendar-container, #message-log {
      min-height: 0;
    }
  </style>

  <script>
    let accessToken = null;
    let userEmail = null;

    // Called when Google Identity Services returns credential
    async function handleCredentialResponse(response) {
      try {
        const client = google.accounts.oauth2.initTokenClient({
          client_id: "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com",
          scope: "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send email profile openid",
          callback: async (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            sessionStorage.setItem("googleAccessToken", accessToken);

            // Load user profile to fetch email
            await gapi.client.init({});
            gapi.client.setToken({ access_token: accessToken });
            const profileResp = await gapi.client.request({ path: "https://www.googleapis.com/oauth2/v2/userinfo" });
            userEmail = profileResp.result.email;

            document.getElementById("auth-area").classList.add("hidden");
            document.getElementById("calendar-content").classList.remove("hidden");
            document.getElementById("messaging-section").classList.remove("hidden");

            loadCalendar();
            enableMessaging();
          }
        });
        client.requestAccessToken();
      } catch (err) {
        console.error("Login failed", err);
      }
    }

    function signOut() {
      accessToken = null;
      userEmail = null;
      sessionStorage.removeItem("googleAccessToken");
      document.getElementById("calendar-container").innerHTML = "";
      document.getElementById("calendar-content").classList.add("hidden");
      document.getElementById("messaging-section").classList.add("hidden");
      document.getElementById("auth-area").classList.remove("hidden");
    }
    document.getElementById("signout_button").onclick = signOut;

    async function loadCalendar() {
      if (!accessToken) return;
      gapi.client.setToken({ access_token: accessToken });
      try {
        const now = new Date();
        const response = await gapi.client.calendar.events.list({
          calendarId: "primary",
          timeMin: new Date(now.getFullYear(), now.getMonth(), 1).toISOString(),
          timeMax: new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString(),
          showDeleted: false,
          singleEvents: true,
          orderBy: "startTime"
        });
        const events = response.result.items || [];
        const container = document.getElementById("calendar-container");
        container.innerHTML = "";
        if (!events.length) {
          container.innerHTML = "<p>No events found this month.</p>";
        } else {
          events.forEach(ev => {
            const div = document.createElement("div");
            div.className = "p-2 border-b";
            div.textContent = `${ev.start.dateTime || ev.start.date} â€” ${ev.summary}`;
            container.appendChild(div);
          });
        }
      } catch (err) {
        console.error("Calendar load error", err);
      }
    }

    function enableMessaging() {
      const sendButton = document.getElementById("send-button");
      const messageInput = document.getElementById("message-input");
      const fileInput = document.getElementById("file-input");
      const log = document.getElementById("message-log");

      sendButton.disabled = false;
      sendButton.classList.remove("disabled");

      sendButton.onclick = async () => {
        const msgText = messageInput.value.trim();
        if (!msgText) return;

        const subject = `Message received from ${userEmail || "unknown sender"}`;
        const raw = [
          `From: ${userEmail}`,
          "To: save@mie.today",
          `Subject: ${subject}`,
          "Content-Type: text/plain; charset=utf-8",
          "",
          msgText
        ].join("\n");

        try {
          const b64 = btoa(unescape(encodeURIComponent(raw))).replace(/\+/g, "-").replace(/\//g, "_");
          await gapi.client.gmail.users.messages.send({
            userId: "me",
            resource: { raw: b64 }
          });

          const entry = document.createElement("div");
          entry.className = "p-2 bg-green-100 rounded mb-2 text-sm";
          entry.textContent = `Sent: ${msgText}`;
          log.appendChild(entry);
          messageInput.value = "";
          fileInput.value = "";
        } catch (err) {
          console.error("Message send error", err);
          const entry = document.createElement("div");
          entry.className = "p-2 bg-red-100 rounded mb-2 text-sm";
          entry.textContent = `Error: ${err.message}`;
          log.appendChild(entry);
        }
      };
    }

    gapi.load("client", () => {});
  </script>
</body>
</html>
