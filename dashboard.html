<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    color: #1f2937;
  }
  .dark body {
    background-color: #111827;
    color: #f9fafb;
  }
  .oauth-app-container #message-log::-webkit-scrollbar, .oauth-app-container #event-list::-webkit-scrollbar { width:8px; height:8px; }
  .oauth-app-container #message-log::-webkit-scrollbar-track, .oauth-app-container #event-list::-webkit-scrollbar-track { background-color:#e5e7eb; border-radius:9999px; }
  .oauth-app-container #message-log::-webkit-scrollbar-thumb, .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color:#9ca3af; border-radius:9999px; }
  .dark .oauth-app-container #message-log::-webkit-scrollbar-track, .dark .oauth-app-container #event-list::-webkit-scrollbar-track { background-color:#374151; }
  .dark .oauth-app-container #message-log::-webkit-scrollbar-thumb, .dark .oauth-app-container #event-log::-webkit-scrollbar-thumb { background-color:#6b7280; }
  .oauth-app-container .flex-grow-scroll { overflow-y:auto; flex-grow:1; }
  .disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div class="oauth-app-container">
  <div class="flex flex-col p-4 md:p-8 space-y-4 w-full">

    <div id="calendar-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col w-full flex-grow min-h-[400px]">
      <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
        <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-center">Sign in to view your Google Calendar</h2>
        <div id="g_id_onload"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"
             data-auto_select="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="dark"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
      </div>
      <div id="calendar-content" class="hidden flex flex-col flex-grow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg md:text-xl lg:text-2xl font-semibold">Upcoming Events</h2>
          <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors">
            Sign Out
          </button>
        </div>
        <div id="event-list" class="space-y-4 pr-2 flex-grow-scroll"></div>
      </div>
    </div>

    <div id="messaging-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col w-full flex-grow min-h-[400px] hidden">
      <h2 class="text-lg md:text-xl lg:text-2xl font-semibold mb-4">Send a Message</h2>
      <div id="message-log" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg flex-grow-scroll mb-4 min-h-[100px]">
        <div class="text-sm text-gray-500 dark:text-gray-400">Your sent messages will appear here...</div>
      </div>
      <div class="flex flex-col space-y-4">
        <textarea id="message-input" placeholder="Type your message..." class="rounded-2xl border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 px-4 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white resize-y min-h-[80px]"></textarea>
        <div class="flex items-center space-x-2">
          <label for="file-input" class="cursor-pointer bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-full transition-colors">
            Add Image
          </label>
          <input id="file-input" type="file" class="hidden" accept="image/*">
          <div id="image-preview-container" class="flex items-center space-x-2"></div>
        </div>
        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full shadow transition-colors disabled:bg-blue-300 dark:disabled:bg-blue-900" disabled>Send</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
    const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
    const API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send';
    
    let accessToken = null;
    let userProfile = null; // Store user profile info for email "From" field

    // --- DOM Elements ---
    const authArea = document.getElementById('auth-area');
    const calendarContent = document.getElementById('calendar-content');
    const messagingSection = document.getElementById('messaging-section');
    const sendButton = document.getElementById('send-button');
    const messageLog = document.getElementById('message-log');
    const messageInput = document.getElementById('message-input');
    
    // Add a listener to the send button
    sendButton.addEventListener('click', sendEmail);

    // --- Sign-in Callback from Google ---
    window.handleCredentialResponse = (response) => {
        console.log("ID token received, now requesting access token...");
        const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: API_SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    accessToken = tokenResponse.access_token;
                    
                    // --- New: Load Gmail API and get user profile ---
                    gapi.client.load('gmail', 'v1', () => {
                      gapi.client.gmail.users.getProfile({ 'userId': 'me' }).then(profileResponse => {
                        userProfile = profileResponse.result;
                        console.log('User profile loaded:', userProfile);
                        console.log('Access token obtained. Initializing GAPI...');
                        gapi.client.init({
                            accessToken: accessToken,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
                        }).then(() => {
                            updateUIForSignIn();
                            listUpcomingEvents();
                        });
                      });
                    });
                } else {
                    console.error('Failed to get access token.');
                    updateUIForSignOut();
                }
            },
        });
        tokenClient.requestAccessToken();
    };

    // --- GAPI Initialization ---
    function initializeGapi(){
      gapi.load('client', () => {
        console.log('gapi client loaded.');
      });
    }

    // --- Calendar API Call ---
    async function listUpcomingEvents() {
        try {
            const response = await gapi.client.calendar.events.list({
                calendarId: "primary",
                timeMin: (new Date()).toISOString(),
                showDeleted: false,
                singleEvents: true,
                maxResults: 10,
                orderBy: "startTime"
            });
            
            const events = response.result.items;
            const eventList = document.getElementById("event-list");
            eventList.innerHTML = "";
            
            if (!events || events.length === 0) {
                eventList.innerHTML = "<p class='text-gray-500 dark:text-gray-400 text-center'>No upcoming events found.</p>";
                return;
            }
            
            events.forEach(ev => {
                const start = ev.start.dateTime || ev.start.date;
                const div = document.createElement("div");
                div.className = "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm";
                div.innerHTML = `<h3 class="font-semibold text-lg">${ev.summary || 'No Title'}</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${new Date(start).toLocaleString()}</p>`;
                eventList.appendChild(div);
            });
        } catch (e) {
            console.error('Calendar error:', e);
            updateUIForSignOut();
        }
    }
    
    // --- New: Email Sending Function ---
    async function sendEmail() {
      if (!accessToken || !userProfile) {
        logMessage("Error: Not signed in or profile not loaded.", "error");
        return;
      }
      
      const messageText = messageInput.value;
      if (!messageText.trim()) {
        logMessage("Message cannot be empty.", "error");
        return;
      }
      
      // We will send to a fixed email for this demo
      const recipient = userProfile.emailAddress;
      const subject = "Message from My Dashboard";
      const messageBody = `To: ${recipient}\nSubject: ${subject}\n\n${messageText}`;
      
      const base64EncodedEmail = base64url(messageBody);
      
      logMessage("Sending email...", "info");
      sendButton.disabled = true;

      try {
        const response = await gapi.client.gmail.users.messages.send({
          'userId': 'me',
          'resource': {
            'raw': base64EncodedEmail
          }
        });
        
        console.log("Email sent successfully:", response.result);
        logMessage("Email sent successfully!", "success");
        messageInput.value = ""; // Clear the input field
      } catch (e) {
        console.error("Failed to send email:", e);
        logMessage(`Failed to send email. Error: ${e.result.error.message}`, "error");
      } finally {
        sendButton.disabled = false;
      }
    }
    
    // --- New: Base64 Encoding Utility ---
    function base64url(str) {
      return btoa(str)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    // --- New: Message Log Utility ---
    function logMessage(text, type) {
      const p = document.createElement('p');
      p.textContent = text;
      p.className = 'text-sm mb-1';
      if (type === 'success') {
        p.classList.add('text-green-500');
      } else if (type === 'error') {
        p.classList.add('text-red-500');
      } else {
        p.classList.add('text-gray-900', 'dark:text-gray-200');
      }
      messageLog.appendChild(p);
      messageLog.scrollTop = messageLog.scrollHeight;
    }

    // --- UI State Management ---
    function updateUIForSignIn() {
        authArea.classList.add('hidden');
        calendarContent.classList.remove('hidden');
        messagingSection.classList.remove('hidden');
        sendButton.disabled = false;
        sendButton.classList.remove('disabled');
    }

    function updateUIForSignOut() {
        authArea.classList.remove('hidden');
        calendarContent.classList.add('hidden');
        messagingSection.classList.add('hidden');
        sendButton.disabled = true;
        sendButton.classList.add('disabled');
        userProfile = null;
    }
    
    // --- Sign Out Logic ---
    document.getElementById("signout_button").onclick = () => {
        google.accounts.id.revoke(accessToken, done => {
          console.log('revoked: ' + done);
          updateUIForSignOut();
        });
    };

    // Ensure initial UI state is correct
    updateUIForSignOut();
    initializeGapi();
})();
</script>
</body>
</html>
