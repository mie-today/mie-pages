<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIE Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

</head>
<body class="bg-gray-50">

<div class="flex flex-col p-4 md:p-8 space-y-6 w-full h-screen">

  <!-- Calendar Section -->
  <section id="calendar-section" class="bg-white rounded-xl shadow-lg p-6 flex flex-col w-full flex-1">
    <h2 class="text-xl font-semibold mb-4">Upcoming Events</h2>
    <div id="calendar" class="flex-1"></div>
  </section>

  <!-- Messaging Section -->
  <section class="bg-white rounded-xl shadow-lg p-6 flex flex-col w-full flex-1">
    <h2 class="text-xl font-semibold mb-4">Send a Message</h2>
    <div id="message-log" class="bg-gray-50 p-4 rounded-lg flex-1 mb-4 overflow-auto">
      <div class="text-sm text-gray-500">Your sent messages will appear here...</div>
    </div>
    <textarea id="message-input" placeholder="Type your message..." class="rounded-2xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 px-4 py-2 resize-y min-h-[80px] mb-2 w-full"></textarea>
    <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full inline-block mb-2">
      Add Image
    </label>
    <input id="file-input" type="file" class="hidden" accept="image/*">
    <div id="image-preview-container" class="flex items-center space-x-2 mb-2"></div>
    <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full shadow w-full">Send</button>
  </section>

</div>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>

<script>
(async function(){
  // Get token from sessionStorage
  let accessToken = sessionStorage.getItem("googleAccessToken");
  if(!accessToken){ alert("Missing token. Please login first."); return; }

  gapi.load("client", async ()=>{
    await gapi.client.init({
      discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
                     "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"]
    });
    gapi.client.setToken({ access_token: accessToken });

    // Fetch all user calendars
    const calendarListResp = await gapi.client.calendar.calendarList.list();
    const calendars = calendarListResp.result.items || [];

    async function fetchEvents(start,end){
      const events = [];
      for(const cal of calendars){
        const resp = await gapi.client.calendar.events.list({
          calendarId: cal.id,
          timeMin: start.toISOString(),
          timeMax: end.toISOString(),
          showDeleted:false,
          singleEvents:true,
          orderBy:"startTime"
        });
        resp.result.items.forEach(ev=>{
          events.push({
            title: ev.summary || "(No Title)",
            start: ev.start.dateTime || ev.start.date,
            end: ev.end.dateTime || ev.end.date,
            url: ev.htmlLink,
            backgroundColor: cal.backgroundColor || '#3788d8',
            borderColor: cal.backgroundColor || '#3788d8'
          });
        });
      }
      return events;
    }

    // FullCalendar init
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView:'dayGridMonth',
      headerToolbar:{ left:'prev,next today', center:'title', right:'' },
      height:'100%',
      events: async function(info,successCallback,failureCallback){
        try{
          const events = await fetchEvents(info.start,info.end);
          successCallback(events);
        }catch(e){ console.error(e); failureCallback(e); }
      },
      eventClick: function(info){
        info.jsEvent.preventDefault();
        window.open(info.event.url,'_blank');
      }
    });
    calendar.render();
  });

  // Messaging functionality
  const messageInput = document.getElementById("message-input");
  const messageLog = document.getElementById("message-log");
  const fileInput = document.getElementById("file-input");
  const imagePreviewContainer = document.getElementById("image-preview-container");
  const sendButton = document.getElementById("send-button");
  let imageData = null;

  fileInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(file && file.type.startsWith("image/")){
      const reader = new FileReader();
      reader.onload = ev=>{
        imageData = ev.target.result;
        imagePreviewContainer.innerHTML = `<img src="${imageData}" class="h-16 w-16 rounded-lg object-cover">`;
      };
      reader.readAsDataURL(file);
    }
  });

  sendButton.addEventListener("click", async ()=>{
    const msg = messageInput.value.trim();
    if(!msg && !imageData){ alert("Type a message or add an image."); return; }

    let email = `To: save@mie.today\r\nSubject: Dashboard Message\r\nContent-Type: text/html; charset=UTF-8\r\n\r\n`;
    email += msg;
    if(imageData) email += `<br><img src="${imageData}" style="max-width:300px;">`;

    const base64Email = btoa(unescape(encodeURIComponent(email))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    try{
      await gapi.client.request({
        path:"https://gmail.googleapis.com/gmail/v1/users/me/messages/send",
        method:"POST",
        body:{ raw: base64Email }
      });
      const div = document.createElement("div");
      div.className="bg-blue-50 text-gray-900 p-2 rounded mb-2";
      div.innerHTML = msg + (imageData?`<br><img src="${imageData}" class="h-16 w-16 object-cover rounded-lg">`:'');
      messageLog.appendChild(div);
      messageInput.value=""; imageData=null; imagePreviewContainer.innerHTML="";
    }catch(err){ console.error(err); alert("Failed to send: "+err.message); }
  });

})();
</script>

</body>
</html>
