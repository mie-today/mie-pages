<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MIE Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google APIs & Identity Services -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  body { font-family: 'Inter', sans-serif; background:#f3f4f6; color:#1f2937; margin:0; height:100vh; }
  .oauth-app-container { width:100%; max-width:1400px; margin:0 auto; padding:1rem; box-sizing:border-box; height:100%; }
  .flex-col { display:flex; flex-direction:column; gap:1rem; height:100%; }
  section { background:white; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.08); padding:1.25rem; display:flex; flex-direction:column; flex:1 1 0; min-height:320px; overflow:hidden; }
  #calendar-container { flex-grow:1; min-height:240px; }
  #message-log { max-height:220px; overflow-y:auto; }
  #file-preview { margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap; }
  #file-preview img { max-width:80px; max-height:80px; border-radius:8px; object-fit:cover; }
  .disabled { opacity:.5; cursor:not-allowed; }
</style>
</head>
<body>
<div class="oauth-app-container">
  <div class="flex-col">

    <!-- Calendar -->
    <section id="calendar-section">
      <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
        <h2 class="text-lg font-semibold text-center">Sign in to view your Google Calendar</h2>
        <div id="g_id_onload"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"></div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="dark"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left"></div>
      </div>

      <div id="calendar-content" class="hidden flex flex-col flex-grow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Your Calendar</h2>
          <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Sign Out</button>
        </div>
        <div id="calendar-container" class="flex-grow"></div>
      </div>
    </section>

    <!-- Messaging -->
    <section id="messaging-section" class="hidden">
      <h2 class="text-lg font-semibold mb-4">Send a Message</h2>
      <div id="message-log" class="bg-gray-50 p-3 rounded mb-4 min-h-[100px]">
        <div class="text-sm text-gray-500">Your sent messages will appear here...</div>
      </div>

      <textarea id="message-input" placeholder="Type your message..." class="rounded border px-3 py-2 min-h-[80px]"></textarea>

      <div class="flex items-center gap-2 mt-2">
        <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-full font-bold">Add Image</label>
        <input id="file-input" type="file" accept="image/*" class="hidden">
      </div>

      <!-- Inline preview -->
      <div id="file-preview"></div>

      <button id="send-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full mt-4 disabled" disabled>Send</button>
    </section>

  </div>
</div>

<script>
(function(){
  const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
  const API_SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send";

  let tokenClient = null;
  let calendar = null;
  let userEmail = null;

  const authArea = document.getElementById('auth-area');
  const calendarContent = document.getElementById('calendar-content');
  const calendarContainer = document.getElementById('calendar-container');
  const messagingSection = document.getElementById('messaging-section');
  const signoutButton = document.getElementById('signout_button');
  const sendButton = document.getElementById('send-button');
  const messageLog = document.getElementById('message-log');
  const messageInput = document.getElementById('message-input');
  const fileInput = document.getElementById('file-input');
  const filePreview = document.getElementById('file-preview');

  signoutButton.addEventListener('click', handleSignOut);
  sendButton.addEventListener('click', sendEmail);
  messageInput.addEventListener('input', toggleSendButton);
  fileInput.addEventListener('change', toggleSendButton);

  function toggleSendButton(){
    const hasText = messageInput.value.trim() !== "";
    const hasFile = fileInput.files && fileInput.files.length > 0;
    const enable = hasText || hasFile;
    sendButton.disabled = !enable;
    sendButton.classList.toggle('disabled', !enable);

    // Show inline previews
    filePreview.innerHTML = "";
    if(fileInput.files){
      Array.from(fileInput.files).forEach(file=>{
        if(file.type.startsWith('image/')){
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          filePreview.appendChild(img);
        }
      });
    }
  }

  let gapiInitResolve;
  const gapiInitPromise = new Promise((resolve) => { gapiInitResolve = resolve; });

  function initializeGapiClient(){
    gapi.client.init({
      discoveryDocs:[
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
      ]
    }).then(() => {
      console.log("GAPI client initialized.");
      gapiInitResolve();
    }).catch(err => {
      console.error("GAPI init error:", err);
      gapiInitResolve();
    });
  }
  gapi.load('client', initializeGapiClient);

  function parseJwt(token){
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      return JSON.parse(decodeURIComponent(atob(base64).split('').map(c=> '%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    } catch(e){
      return {};
    }
  }

  window.handleCredentialResponse = (response) => {
    if(!response || !response.credential) return;

    const info = parseJwt(response.credential);
    if(info && info.email) userEmail = info.email;

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: API_SCOPES,
      callback: async (tokenResponse) => {
        if(!tokenResponse || !tokenResponse.access_token) return;
        gapi.client.setToken(tokenResponse);
        await gapiInitPromise;
        await fetchUserEmail().catch(()=>{});
        handleAuthSuccess();
      }
    });

    tokenClient.requestAccessToken({prompt:'consent'});
  };

  async function fetchUserEmail(){
    if(userEmail) return userEmail;
    try{
      const resp = await gapi.client.gmail.users.getProfile({ userId:'me' });
      userEmail = resp.result.emailAddress;
      return userEmail;
    } catch(e){
      return null;
    }
  }

  function handleAuthSuccess(){
    authArea.classList.add('hidden');
    calendarContent.classList.remove('hidden');
    messagingSection.classList.remove('hidden');
    displayMonthlyCalendar();
  }

  function handleSignOut(){
    const tok = gapi.client.getToken();
    if(tok && tok.access_token){
      google.accounts.oauth2.revoke(tok.access_token, () => {
        gapi.client.setToken(null);
        resetUI();
      });
    } else resetUI();
  }

  async function displayMonthlyCalendar(){
    if(calendar) calendar.destroy();
    calendar = new FullCalendar.Calendar(calendarContainer,{
      initialView:'dayGridMonth',
      headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
      events: async (fetchInfo, successCallback, failureCallback)=>{
        try{
          const listResp = await gapi.client.calendar.calendarList.list();
          const calendars = listResp.result.items || [];
          const promises = calendars.map(cal => gapi.client.calendar.events.list({
            calendarId: cal.id,
            timeMin: fetchInfo.start.toISOString(),
            timeMax: fetchInfo.end.toISOString(),
            showDeleted:false,
            singleEvents:true
          }).then(r => (r.result.items || []).map(ev => ({...ev,color: cal.backgroundColor || '#3788d8'}))));
          const allArrays = await Promise.all(promises);
          const allEvents = allArrays.flat().map(ev => ({
            title: ev.summary||"(No Title)",
            start: ev.start.dateTime || ev.start.date,
            end: ev.end && (ev.end.dateTime||ev.end.date),
            url: ev.htmlLink,
            allDay: !ev.start.dateTime,
            backgroundColor: ev.color,
            borderColor: ev.color
          }));
          successCallback(allEvents);
        } catch(err){ failureCallback(err); }
      },
      eventClick: function(info){
        info.jsEvent.preventDefault();
        if(info.event.url) window.open(info.event.url,"_blank");
      }
    });
    calendar.render();
  }

  async function sendEmail(){
    const text = messageInput.value || "";
    const file = fileInput.files && fileInput.files[0];
    const subject = `Message received from ${userEmail || "unknown@mie.today"}`;

    let mimeParts = "";
    if(file){
      const boundary = "====boundary_" + Math.random().toString(36).slice(2,12);
      const fileBase64 = await fileToBase64(file);

      mimeParts =
        `To: save@mie.today\r\n` +
        `From: me\r\n` +
        `Subject: ${subject}\r\n` +
        `MIME-Version: 1.0\r\n` +
        `Content-Type: multipart/mixed; boundary="${boundary}"\r\n\r\n` +

        `--${boundary}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${text}\r\n\r\n` +

        `--${boundary}\r\n` +
        `Content-Type: ${file.type || 'application/octet-stream'}; name="${file.name}"\r\n` +
        `Content-Disposition: attachment; filename="${file.name}"\r\n` +
        `Content-Transfer-Encoding: base64\r\n\r\n` +
        `${fileBase64}\r\n\r\n` +

        `--${boundary}--`;
    } else {
      mimeParts =
        `To: save@mie.today\r\n` +
        `From: me\r\n` +
        `Subject: ${subject}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${text}`;
    }

    const encoded = btoa(unescape(encodeURIComponent(mimeParts))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

    logMessage("Sending email...", "info");
    sendButton.disabled = true;
    sendButton.classList.add('disabled');

    try{
      await gapi.client.gmail.users.messages.send({ userId:'me', resource:{raw:encoded} });
      logMessage("Email sent successfully!", "success");
      messageInput.value = "";
      fileInput.value = "";
      filePreview.innerHTML = "";
      toggleSendButton();
    } catch(err){
      logMessage(`Failed to send email: ${err.result?.error?.message||err.message}`, "error");
      sendButton.disabled = false;
      sendButton.classList.remove('disabled');
    }
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{ resolve(reader.result.split(',')[1]); };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function resetUI(){
    authArea.classList.remove('hidden');
    calendarContent.classList.add('hidden');
    messagingSection.classList.add('hidden');
    if(calendar){ calendar.destroy(); calendar = null; }
    messageLog.innerHTML = `<div class="text-sm text-gray-500">Your sent messages will appear here...</div>`;
    messageInput.value="";
    fileInput.value="";
    filePreview.innerHTML="";
    toggleSendButton();
  }

  function logMessage(text,type='info'){
    const p = document.createElement('div');
    p.className = "text-sm mb-1 " + (type==='success'?'text-green-600':type==='error'?'text-red-600':'text-gray-900');
    p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
    if(messageLog.children.length===1 && messageLog.firstChild.textContent.includes('Your sent messages')) messageLog.innerHTML='';
    messageLog.appendChild(p);
    messageLog.scrollTop = messageLog.scrollHeight;
  }

  resetUI();

})();
</script>
</body>
</html>
