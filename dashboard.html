<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard v2.8 - Mobile +# More Compact</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google API Client Library (no longer used for auth; safe to keep) -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400&family=Montserrat:wght@600&display=swap"
  rel="stylesheet"
/>

<style>
    /* ============================================================
     * NOTE
     * - This file is based on your current dashboard.html (v2.3)
     * - Changes are limited to the calendar toolbar + mobile layout
     *   and the monthly event limiting behavior (3 visible events).
     * - Messaging, auth flow, backend calls are unchanged.
     * ============================================================ */

    /* --- General Body and Layout --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Custom font classes */
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-lato { font-family: 'Lato', sans-serif; }

    /* --- Scrollbar Styling --- */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    /* Utility class for disabled elements */
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main container for the entire application */
    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* ============================================================
     * RESPONSIVE LAYOUT
     * ============================================================ */

    /* --- Responsive Styles for Mobile (up to 480px wide) --- */
    @media (max-width: 480px) {
        .oauth-app-container {
            width: 100% !important;
        }
        .mobile-container {
            padding: 4px !important;
            gap: 4px !important;
        }
        .calendar-section, .messaging-section {
            width: 100% !important;
            height: auto !important;
            padding: 8px !important;
        }
        .mobile-heading { font-size: 20px !important; line-height: 1.2 !important; }
        .mobile-text { font-size: 14px !important; line-height: 1.1 !important; }
        .mobile-small-btn { padding: 4px 8px !important; font-size: 12px !important; }
        .mobile-text-btn { font-size: 16px !important; }
        .mobile-textarea { height: 60px !important; padding: 4px 8px !important; }

        /* FullCalendar (mobile) fonts */
        .fc .fc-toolbar-title { font-size: 20px !important; line-height: 1.2 !important; }
        .fc .fc-button-primary { font-size: 12px !important; padding: 4px 6px !important; line-height: 1.2 !important; }
        .fc .fc-col-header-cell { font-size: 12px !important; }
        .fc .fc-daygrid-day-number { font-size: 12px !important; }
        .fc .fc-event { font-size: 10px !important; } /* EVENT FONT SIZE (MOBILE) */

        /* ============================================================
         * MOBILE TOOLBAR (NEW)
         * - Matches your requested layout:
         *   Left: "December 2025"
         *   Right: [<] [>] + [Daily/Weekly/Monthly â–¼]
         * - We hide FullCalendar's built-in header toolbar on mobile.
         * ============================================================ */
        .fc .fc-header-toolbar { display: none !important; }

        #mie-mobile-toolbar {
          display: flex !important;
        }

        /* Slightly reduce vertical padding above calendar grid */
        #calendar-container { margin-top: 6px !important; min-height: 520px !important; }
    
        /* Compact '+#' more indicator on mobile */
        .mie-more-events {
          font-size: 11px !important;
          padding: 2px 6px !important;
          line-height: 1.1 !important;
        }
}

    /* --- Responsive Styles for Tablet (481px to 768px) --- */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 720px; }  /* a bit taller to avoid scroll */
        .messaging-section { width: 481px; height: 316px; }
    }

    /* --- Responsive Styles for Desktop (769px and wider) --- */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 820px; }  /* tuned so no right scrollbar */
        .messaging-section { width: 800px; height: 360px; }
    }

    /* ============================================================
     * FULLCALENDAR LIGHT MODE CUSTOMIZATION (unchanged)
     * ============================================================ */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }

    /* Today's date with blue circle indicator */
    .fc-daygrid-day.fc-day-today { background-color: transparent !important; }
    .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
      background-color: #3b82f6 !important;
      color: white !important;
      border-radius: 50% !important;
      width: 28px !important;
      height: 28px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: 600 !important;
    }

    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }

    /* ============================================================
     * VIEW DROPDOWN STYLING (reused for desktop + mobile)
     * ============================================================ */
    .view-switcher {
      position: relative;
      display: inline-block;
    }

    /* Hide the placeholder button that creates the blue line (desktop toolbar custom button) */
    .fc-customViewSwitcher-button {
      display: none !important;
    }

    .view-switcher select {
      appearance: none;
      background-color: #3b82f6;
      color: white;
      border: 1px solid #2563eb;
      border-radius: 6px;
      padding: 4px 32px 4px 12px;
      font-size: 12px;  /* adjust Daily/Weekly/Monthly dropdown size */
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      line-height: 1.2;
    }

    .view-switcher select:hover {
      background-color: #2563eb;
    }

    .view-switcher::after {
      content: 'â–¼';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: white;
      font-size: 12px;
    }

    /* Hide FullCalendar's built-in dot so we only show our custom one */
    .fc-daygrid-event-dot { display: none !important; }

    /* Let JS handle background/border per calendar, but force text to black */
    .fc .fc-event {
      border-color: transparent;
      background-color: transparent;
      color: #000000 !important;
      font-size: 12px;          /* EVENT FONT SIZE (DESKTOP/TABLET) */
      line-height: 1.2;
    }

    /* Force ALL event text to stay inside the day cell (no spillover) */
    .fc-daygrid-event-harness,
    .fc-daygrid-event,
    .fc-daygrid-event .fc-event-main,
    .fc-daygrid-event .fc-event-title,
    .fc-daygrid-event .fc-event-title-container,
    .fc-daygrid-event .fc-event-main-frame {
      max-width: 100% !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      box-sizing: border-box !important;
    }

    /* Also force inner text wrappers to black, to override any defaults */
    .fc .fc-event .fc-event-main,
    .fc .fc-event .fc-event-title {
      color: #000000 !important;
    }

    .fc .fc-toolbar-title {
      color: #1f2937 !important;
      font-size: 19px !important;
      line-height: 1.2 !important;
      font-weight: 600;
    }

    /* Make Today + arrows match title height (desktop toolbar) */
    .fc .fc-toolbar .fc-button {
      font-size: 14px !important;
      line-height: 1.2 !important;
      padding: 2px 8px !important;
      height: auto !important;
      border-radius: 6px !important;
    }

    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* Bullet dot in timed events */
    .mie-event-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 9999px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    /* ============================================================
     * "+ X more events" indicator styling (unchanged)
     * ============================================================ */
    .mie-more-events {
      display: block;
      padding: 2px 6px;
      margin-top: 2px;
      font-size: 11px;
      font-weight: 600;
      color: #3b82f6;
      background-color: #eff6ff;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .mie-more-events:hover {
      background-color: #dbeafe;
      color: #2563eb;
    }

    /* ============================================================
     * MOBILE TOOLBAR STYLING (NEW)
     * - Not shown on desktop/tablet.
     * ============================================================ */
    #mie-mobile-toolbar {
      display: none; /* shown via mobile media query */
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 2px 4px 2px;
      flex-wrap: nowrap;
    }

    #mie-mobile-title {
      font-size: 26px;
      line-height: 1.05;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.02em;
      flex: 1 1 auto;
      min-width: 0;
    }

    .mie-mobile-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .mie-nav-pair {
      display: inline-flex;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #2563eb;
      background-color: #3b82f6;
    }

    .mie-nav-btn {
      width: 42px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 16px;
      line-height: 1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .mie-nav-btn:active {
      filter: brightness(0.92);
    }

    .mie-nav-btn + .mie-nav-btn {
      border-left: 1px solid rgba(255,255,255,0.45);
    }

    /* --- Event Modal Styling --- */
    .event-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .event-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
      color: #1f2937;
    }

    @media (max-width: 480px){
      .event-modal-content {
        max-width: 320px !important;
        padding: 16px !important;
      }
    }

    /* --- Day Events Modal Styling --- */
    .day-events-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .day-events-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      color: #1f2937;
    }

    .day-events-modal-content::-webkit-scrollbar { width: 8px; }
    .day-events-modal-content::-webkit-scrollbar-track { background-color: #f3f4f6; border-radius: 9999px; }
    .day-events-modal-content::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }
    .day-events-modal-content::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

    .day-event-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #3b82f6;
      background-color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day-event-item:hover {
      background-color: #f3f4f6;
      transform: translateX(2px);
    }

    .day-event-time {
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .day-event-title {
      color: #1f2937;
      font-size: 14px;
      font-weight: 500;
    }

    .day-event-location {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .day-events-modal-content {
        max-width: 340px !important;
        padding: 16px !important;
      }

      .day-event-item { padding: 10px !important; }
      .day-event-time { font-size: 12px !important; }
      .day-event-title { font-size: 13px !important; }
    }

    /* --- Access Denied Styling --- */
    .access-denied { color: #dc2626; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px; }
</style>
</head>

<body class="bg-white">

<!-- Main App Container -->
<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <!-- ===== Calendar Section ===== -->
        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">

            <!-- Authentication Area (signed out / pre-consent) -->
            <div id="auth-area" class="flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />

                <h1 class="font-montserrat text-2xl font-semibold text-gray-800" style="font-size: 18pt;">Mie</h1>
                <p class="font-lato text-base text-gray-600 mt-1 mb-6" style="font-size: 12pt;">Remember your life</p>

                <!-- Connect CTA -->
                <button
                    id="connect-google-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full px-5 py-2 text-sm flex items-center shadow"
                    style="min-width:200px; justify-content:center;"
                >
                    Connect Google
                </button>

                <div class="mt-6 text-sm text-gray-500">
                    or
                    <a href="signup.html"
                       class="font-semibold text-green-600 hover:text-green-700 hover:underline">
                    Create an account
                    </a>
                </div>
            </div>

            <!-- Access Verification Area -->
            <div id="access-check-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-gray-800 mb-4">Verifying Access...</h2>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-4">Checking if youryour account has access to Mie dashboard</p>
            </div>

            <!-- Access Denied Area -->
            <div id="access-denied-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-red-600 mb-4">Access Denied</h2>
                <div class="access-denied text-center max-w-md">
                    <p class="mb-3">Your Gmail account doesn't have access to the Mie dashboard.</p>
                    <p class="mb-4">To get access, please sign up with the correct PIN code.</p>
                    <div class="space-y-3">
                        <a href="signup.html" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Sign Up for Access</a>
                        <br />
                        <button id="try-different-account" class="text-blue-600 hover:text-blue-700 underline text-sm">
                            Try a Different Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (signed in + approved) -->
            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-between items-center mb-2">
                    <span id="welcome-message" class="text-sm text-gray-600"></span>
                </div>

                <!-- ============================================================
                     NEW: Mobile toolbar (only visible on <=480px)
                     - Left: month/year or month+range (no year for day/week)
                     - Right: nav arrows + view dropdown
                     ============================================================ -->
                <div id="mie-mobile-toolbar" aria-label="Calendar toolbar">
                    <div id="mie-mobile-title" class="font-montserrat"> </div>
                    <div class="mie-mobile-controls">
                        <div class="mie-nav-pair" role="group" aria-label="Navigate">
                            <button id="mie-mobile-prev" type="button" class="mie-nav-btn" aria-label="Previous">â€¹</button>
                            <button id="mie-mobile-next" type="button" class="mie-nav-btn" aria-label="Next">â€º</button>
                        </div>

                        <div class="view-switcher" aria-label="Change view">
                            <select id="mie-mobile-view-select">
                                <option value="dayGridDay">Daily</option>
                                <option value="dayGridWeek">Weekly</option>
                                <option value="dayGridMonth" selected>Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="calendar-container" class="flex-1 min-h-0 mt-1"></div>
            </div>
        </div>

        <!-- ===== Messaging Section ===== -->
        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 mobile-heading">Send a Message</h2>

            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2">
                <div class="text-sm mobile-text text-gray-500">Your sent messages will appear here...</div>
            </div>

            <textarea
                id="message-input"
                placeholder="Type your message..."
                class="rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"
            ></textarea>

            <div class="flex items-center space-x-2 mt-2">
                <label
                    for="file-input"
                    class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-sm py-1 px-3 rounded-full mobile-text"
                >
                    Attachment
                </label>
                <input id="file-input" type="file" class="hidden" accept="image/*" />
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-12 h-12 object-cover rounded border" alt="Preview" />
                    <button id="remove-file" class="text-red-500 text-sm mobile-text">Remove</button>
                </div>
            </div>

            <button
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2 mobile-text-btn"
                disabled
            >
                Send
            </button>

            <!-- Sign Out bottom-right with spacing -->
            <div class="mt-6 flex justify-end">
                <button
                    id="signout_button"
                    class="text-gray-500 text-xs font-semibold mobile-small-btn py-1 px-2 rounded-md"
                >
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Event Details Modal ===== -->
<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl font-semibold mobile-heading"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text"></p>
            <p id="event-description" class="text-gray-700 mobile-text"></p>
            <p id="event-location" class="text-gray-600 mobile-text"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a
                id="event-link"
                target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-btn"
            >
                Open in Google Calendar
            </a>
        </div>
    </div>
</div>

<!-- Day Events Modal -->
<div id="day-events-modal" class="day-events-modal hidden">
    <div class="day-events-modal-content">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 id="day-events-title" class="text-xl font-semibold mobile-heading text-gray-800"></h3>
                <p id="day-events-subtitle" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button id="close-day-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="day-events-list" class="space-y-2">
            <!-- Events will be dynamically inserted here -->
        </div>
    </div>
</div>

<script>
(function () {
    // ========================================
    // VERSION & DEBUG INFO
    // ========================================
    const VERSION = "2.8.0-MOBILE-MORE-INDICATOR-COMPACT";
    console.log("==========================================");
    console.log("ðŸš€ DASHBOARD VERSION:", VERSION);
    console.log("ðŸ“± Mobile toolbar: Custom title + arrows + dropdown");
    console.log("âœ… Monthly event limiting ACTIVE: 3 visible events/day (Monthly only)");
    console.log("ðŸ”„ View switcher: Daily/Weekly/Monthly (Desktop + Mobile)");
    console.log("ðŸ”µ Today indicator: Blue circle (unchanged)");
    console.log("==========================================");

    // ======== CONFIG =========
    const BACKEND_BASE_URL = "https://api.mie.today";

    /* ============================================================
     * CHANGE: Monthly visible events
     * - Per your requirement: show 3 events, rest becomes "+ N more"
     * ============================================================ */
    const MAX_VISIBLE_EVENTS = 3;

    /* ============================================================
     * MOBILE BREAKPOINT
     * - This matches the CSS media query (max-width: 480px)
     * ============================================================ */
    const MOBILE_MEDIA_QUERY = "(max-width: 480px)";

    // ======== STATE =========
    let calendar = null;
    let selectedFile = null;
    let userEmail = null;
    let userHasAccess = false;
    let eventsByDate = {}; // Store all events by date for modal
    let isMobile = window.matchMedia(MOBILE_MEDIA_QUERY).matches;

    // ======== DOM HOOKS =========
    const authArea = document.getElementById("auth-area");
    const accessCheckArea = document.getElementById("access-check-area");
    const accessDeniedArea = document.getElementById("access-denied-area");
    const calendarContent = document.getElementById("calendar-content");
    const calendarContainer = document.getElementById("calendar-container");
    const messagingSection = document.getElementById("messaging-section");
    const welcomeMessage = document.getElementById("welcome-message");
    const signoutButton = document.getElementById("signout_button");
    const tryDifferentAccountBtn = document.getElementById("try-different-account");
    const connectGoogleBtn = document.getElementById("connect-google-btn");

    const sendButton = document.getElementById("send-button");
    const messageLog = document.getElementById("message-log");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const removeFileButton = document.getElementById("remove-file");

    const eventModal = document.getElementById("event-modal");
    const closeModal = document.getElementById("close-modal");
    const eventTitle = document.getElementById("event-title");
    const eventTime = document.getElementById("event-time");
    const eventDescription = document.getElementById("event-description");
    const eventLocation = document.getElementById("event-location");
    const eventLink = document.getElementById("event-link");

    const dayEventsModal = document.getElementById("day-events-modal");
    const closeDayModal = document.getElementById("close-day-modal");
    const dayEventsTitle = document.getElementById("day-events-title");
    const dayEventsSubtitle = document.getElementById("day-events-subtitle");
    const dayEventsList = document.getElementById("day-events-list");

    /* ============================================================
     * MOBILE TOOLBAR DOM HOOKS (NEW)
     * ============================================================ */
    const mobileToolbar = document.getElementById("mie-mobile-toolbar");
    const mobileTitle = document.getElementById("mie-mobile-title");
    const mobilePrevBtn = document.getElementById("mie-mobile-prev");
    const mobileNextBtn = document.getElementById("mie-mobile-next");
    const mobileViewSelect = document.getElementById("mie-mobile-view-select");

    // ======== INIT ========
    document.addEventListener("DOMContentLoaded", () => {
        bindEventHandlers();
        initializeDashboard();

        // Rebuild calendar if viewport crosses the mobile breakpoint (rotation / resize)
        const mq = window.matchMedia(MOBILE_MEDIA_QUERY);
        if (mq && typeof mq.addEventListener === "function") {
            mq.addEventListener("change", () => {
                const nextIsMobile = window.matchMedia(MOBILE_MEDIA_QUERY).matches;
                if (nextIsMobile !== isMobile) {
                    isMobile = nextIsMobile;
                    if (calendarContent && !calendarContent.classList.contains("hidden")) {
                        displayCalendar(); // rebuild using the correct toolbar mode
                    }
                }
            });
        }
    });

    function bindEventHandlers() {
        if (connectGoogleBtn) {
            connectGoogleBtn.addEventListener("click", () => {
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (signoutButton) {
            signoutButton.addEventListener("click", () => handleSignOut(false));
        }

        if (tryDifferentAccountBtn) {
            tryDifferentAccountBtn.addEventListener("click", async () => {
                await handleSignOut(true);
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (sendButton) {
            sendButton.addEventListener("click", (e) => {
                e.preventDefault();
                sendMessage();
            });
        }

        if (messageInput) {
            messageInput.addEventListener("input", updateSendButton);
        }

        if (fileInput) {
            fileInput.addEventListener("change", handleFileSelect);
        }

        if (removeFileButton) {
            removeFileButton.addEventListener("click", (e) => {
                e.preventDefault();
                clearSelectedFile();
            });
        }

        if (closeModal) {
            closeModal.addEventListener("click", () => {
                eventModal.classList.add("hidden");
            });
        }
        if (eventModal) {
            eventModal.addEventListener("click", (e) => {
                if (e.target === eventModal) {
                    eventModal.classList.add("hidden");
                }
            });
        }

        if (closeDayModal) {
            closeDayModal.addEventListener("click", () => {
                dayEventsModal.classList.add("hidden");
            });
        }
        if (dayEventsModal) {
            dayEventsModal.addEventListener("click", (e) => {
                if (e.target === dayEventsModal) {
                    dayEventsModal.classList.add("hidden");
                }
            });
        }

        /* ============================================================
         * MOBILE TOOLBAR EVENT BINDINGS (NEW)
         * ============================================================ */
        if (mobilePrevBtn) {
            mobilePrevBtn.addEventListener("click", () => {
                if (!calendar) return;
                calendar.prev();
                syncMobileToolbar();
            });
        }

        if (mobileNextBtn) {
            mobileNextBtn.addEventListener("click", () => {
                if (!calendar) return;
                calendar.next();
                syncMobileToolbar();
            });
        }

        if (mobileViewSelect) {
            mobileViewSelect.addEventListener("change", (e) => {
                if (!calendar) return;
                const newView = e.target.value;
                calendar.changeView(newView);
                syncMobileToolbar();
            });
        }

        updateSendButton();
    }

    // ======== HIGH-LEVEL FLOW ========
    async function initializeDashboard() {
        showAccessCheck();
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/status", {
                method: "GET",
                credentials: "include",
            });

            if (!resp.ok) {
                console.warn("Status check failed with HTTP", resp.status);
                showAuthArea();
                return;
            }

            const data = await resp.json();

            if (data.connected) {
                userHasAccess = true;
                userEmail = data.userEmail || (data.user && (data.user.email || data.user.primaryEmail)) || "";

                if (welcomeMessage) {
                    const user = data.user || {};
                    let firstName = "";
                    if (user.given_name) {
                        firstName = user.given_name;
                    } else if (user.name) {
                        firstName = user.name.split(" ")[0];
                    }

                    const email = userEmail || "";
                    let label = "Welcome";
                    if (firstName || email) {
                        label += ", ";
                        if (firstName) label += firstName;
                        if (firstName && email) label += " ";
                        if (email) label += "&lt;" + email + "&gt;";
                    }
                    welcomeMessage.innerHTML = label;
                }

                showDashboard();
                displayCalendar();  // calendar init is now responsive
            } else {
                showAuthArea();
            }
        } catch (err) {
            console.error("Error during status check:", err);
            showAuthArea();
        }
    }

    // ======== UI STATE ========
    function showAuthArea() {
        authArea.classList.remove("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessCheck() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.remove("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessDenied() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.remove("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showDashboard() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.remove("hidden");
        messagingSection.classList.remove("hidden");
    }

    // ======== SIGN OUT (BACKEND SESSION) ========
    async function handleSignOut(silent) {
        try {
            await fetch(BACKEND_BASE_URL + "/auth/logout", {
                method: "POST",
                credentials: "include",
            });
        } catch (err) {
            console.error("Error during logout:", err);
        }

        if (!silent) {
            window.location.href = "dashboard.html";
        }
    }

    // ============================================================
    // CALENDAR (RESPONSIVE TOOLBAR)
    // ============================================================
    function displayCalendar() {
        if (!calendarContainer) return;

        // Re-evaluate in case of rotation / resize
        isMobile = window.matchMedia(MOBILE_MEDIA_QUERY).matches;

        if (calendar) {
            calendar.destroy();
            calendar = null;
        }

        console.log("ðŸ”§ Initializing calendar. isMobile =", isMobile);

        const commonOptions = {
            initialView: "dayGridMonth",
            fixedWeekCount: false,
            showNonCurrentDates: false,
            height: (isMobile ? "auto" : "100%"),
            nextDayThreshold: "01:00:00",
            events: fetchCalendarEvents,

            /* ============================================================
             * BUGFIX: Reset per-cell counters when the visible date range changes.
             * - Prevents stale _eventCount state from carrying across navigations.
             * ============================================================ */
            datesSet: function() {
                clearDayCellEventCounters();

                // If the current view is monthly, re-add "+ more" indicators.
                // (monthly hiding happens in eventDidMount)
                if (calendar && calendar.view && calendar.view.type === "dayGridMonth") {
                    // Small async to let FullCalendar paint the grid first.
                    setTimeout(() => addMoreEventsIndicators(), 0);
                }

                // Keep mobile title in sync (month/day/week formatting rules)
                syncMobileToolbar();
            },

            /* ============================================================
             * MONTHLY EVENT LIMITING (3 visible events)
             * - Applies ONLY in Monthly view (dayGridMonth).
             * - Daily/Weekly show all events.
             * ============================================================ */
            eventDidMount: function(info) {
                const el = info.el;
                const dayCell = el.closest('.fc-daygrid-day');
                if (!dayCell) return;

                const currentView = calendar.view.type;

                // Only enforce hiding in month view.
                if (currentView !== "dayGridMonth") {
                    return;
                }

                // Track event count per day cell
                if (!dayCell._eventCount) {
                    dayCell._eventCount = 0;
                }

                const currentIndex = dayCell._eventCount;
                dayCell._eventCount++;

                // Hide if beyond limit
                if (currentIndex >= MAX_VISIBLE_EVENTS) {
                    el.style.display = "none";
                }
            },

            // Add indicators after events loaded
            eventsSet: function() {
                // Indicators only for month view
                if (calendar.view.type === "dayGridMonth") {
                    setTimeout(() => addMoreEventsIndicators(), 0);
                }
            },

            eventContent: function(arg) {
                const event = arg.event;
                const isAllDay = event.allDay;

                const color =
                    (event.extendedProps && event.extendedProps.calendarColor) ||
                    arg.backgroundColor ||
                    arg.borderColor ||
                    "#3b82f6";

                const container = document.createElement("div");
                container.className = "flex items-center";
                container.style.maxWidth = "100%";
                container.style.overflow = "hidden";
                container.style.textOverflow = "ellipsis";
                container.style.whiteSpace = "nowrap";
                container.style.boxSizing = "border-box";

                if (isAllDay) {
                    container.textContent = event.title || "";
                    container.style.backgroundColor = color;
                    container.style.borderRadius = "4px";
                    container.style.padding = "0 4px";
                    container.style.display = "block";
                    container.style.color = "#000000";
                    return { domNodes: [container] };
                }

                const dot = document.createElement("span");
                dot.className = "mie-event-dot";
                dot.style.backgroundColor = color;
                container.appendChild(dot);

                const timeSpan = document.createElement("span");
                timeSpan.className = "mie-event-time font-semibold mr-1";
                timeSpan.textContent = arg.timeText || "";
                timeSpan.style.flexShrink = "0";
                container.appendChild(timeSpan);

                const titleSpan = document.createElement("span");
                titleSpan.className = "mie-event-title";
                titleSpan.textContent = event.title || "";
                titleSpan.style.minWidth = "0";
                titleSpan.style.flexShrink = "1";
                titleSpan.style.overflow = "hidden";
                titleSpan.style.textOverflow = "ellipsis";
                titleSpan.style.whiteSpace = "nowrap";
                container.appendChild(titleSpan);

                return { domNodes: [container] };
            },

            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showEventDetails(info.event);
            },
        };

        /* ============================================================
         * DESKTOP/TABLET TOOLBAR
         * - Keep your existing toolbar on non-mobile (unchanged behavior).
         * ============================================================ */
        const desktopToolbarOptions = {
            headerToolbar: {
                left: "today prev,next",
                center: "title",
                right: "customViewSwitcher",
            },
            customButtons: {
                customViewSwitcher: {
                    text: "",
                    click: function() {
                        // Click handled by the select element
                    }
                }
            },
        };

        /* ============================================================
         * MOBILE TOOLBAR
         * - FullCalendar headerToolbar is disabled (CSS also hides it).
         * - We render + manage the toolbar ourselves.
         * ============================================================ */
        const mobileToolbarOptions = {
            headerToolbar: false,
        };

        calendar = new FullCalendar.Calendar(
            calendarContainer,
            Object.assign({}, commonOptions, isMobile ? mobileToolbarOptions : desktopToolbarOptions)
        );

        calendar.render();

        // Desktop: replace placeholder with dropdown (your existing approach)
        if (!isMobile) {
            createDesktopViewSwitcher();
        }

        // Mobile: ensure toolbar is visible and synced
        if (isMobile) {
            if (mobileToolbar) mobileToolbar.style.display = "flex";
            syncMobileToolbar();
        } else {
            if (mobileToolbar) mobileToolbar.style.display = "none";
        }

        console.log("âœ… Calendar rendered");
    }

    /* ============================================================
     * DESKTOP VIEW SWITCHER (existing behavior)
     * - Converts the placeholder custom button into a <select>.
     * ============================================================ */
    function createDesktopViewSwitcher() {
        const customButton = document.querySelector(".fc-customViewSwitcher-button");
        if (!customButton) return;

        const switcherContainer = document.createElement("div");
        switcherContainer.className = "view-switcher";

        const select = document.createElement("select");
        select.id = "view-switcher-select";

        const views = [
            { value: "dayGridDay", label: "Daily" },
            { value: "dayGridWeek", label: "Weekly" },
            { value: "dayGridMonth", label: "Monthly" }
        ];

        views.forEach(view => {
            const option = document.createElement("option");
            option.value = view.value;
            option.textContent = view.label;
            if (view.value === "dayGridMonth") option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener("change", (e) => {
            const newView = e.target.value;
            calendar.changeView(newView);

            // Monthly indicators should re-attach after view switches
            if (calendar.view.type === "dayGridMonth") {
                setTimeout(() => addMoreEventsIndicators(), 0);
            } else {
                document.querySelectorAll(".mie-more-events").forEach(el => el.remove());
            }
        });

        switcherContainer.appendChild(select);
        customButton.parentNode.replaceChild(switcherContainer, customButton);
    }

    /* ============================================================
     * MOBILE TOOLBAR SYNC (NEW)
     * - Title rules per your request:
     *   - Month view: "December 2025" (month + year)
     *   - Week view:  "Dec 14 â€“ 20"   (NO year)
     *   - Day view:   "December 6"    (NO year)
     * - Dropdown reflects current view.
     * ============================================================ */
    function syncMobileToolbar() {
        if (!isMobile) return;
        if (!calendar) return;

        if (mobileViewSelect) {
            const viewType = calendar.view.type;
            // Keep dropdown aligned with current view
            if (mobileViewSelect.value !== viewType) {
                mobileViewSelect.value = viewType;
            }
        }

        if (mobileTitle) {
            mobileTitle.textContent = formatMobileTitle(calendar.view);
        }
    }

    function formatMobileTitle(view) {
        // Month title formats (locale-aware)
        const monthLong = new Intl.DateTimeFormat("en-US", { month: "long" });
        const monthYear = new Intl.DateTimeFormat("en-US", { month: "long", year: "numeric" });
        const monthShort = new Intl.DateTimeFormat("en-US", { month: "short" });
        const dayNum = new Intl.DateTimeFormat("en-US", { day: "numeric" });

        if (view.type === "dayGridMonth") {
            return monthYear.format(calendar.getDate()); // e.g., "December 2025"
        }

        if (view.type === "dayGridDay") {
            const d = calendar.getDate();
            return monthLong.format(d) + " " + dayNum.format(d); // e.g., "December 6"
        }

        if (view.type === "dayGridWeek") {
            // currentStart is inclusive, currentEnd is exclusive in FullCalendar
            const start = view.currentStart;
            const endExclusive = view.currentEnd;
            const end = new Date(endExclusive.getTime());
            end.setDate(end.getDate() - 1);

            const startMonth = monthShort.format(start);
            const endMonth = monthShort.format(end);

            const startDay = dayNum.format(start);
            const endDay = dayNum.format(end);

            // Same month: "Dec 14 â€“ 20"
            if (startMonth === endMonth) {
                return `${startMonth} ${startDay} \u2013 ${endDay}`;
            }

            // Cross-month: "Dec 30 â€“ Jan 5"
            return `${startMonth} ${startDay} \u2013 ${endMonth} ${endDay}`;
        }

        // Fallback
        return view.title || "";
    }

    /* ============================================================
     * Reset per-day event counters
     * ============================================================ */
    function clearDayCellEventCounters() {
        const dayCells = document.querySelectorAll(".fc-daygrid-day");
        dayCells.forEach(cell => {
            if (cell && cell._eventCount) {
                cell._eventCount = 0;
            }
        });
    }

    // ============================================================
    // "+ X more" indicators (Monthly only)
    // ============================================================
    function addMoreEventsIndicators() {
        if (!calendar) return;

        const currentView = calendar.view.type;
        if (currentView !== "dayGridMonth") return;

        // Remove old indicators
        document.querySelectorAll(".mie-more-events").forEach(el => el.remove());

        const dayCells = document.querySelectorAll(".fc-daygrid-day");
        dayCells.forEach(dayCell => {
            const dateStr = dayCell.getAttribute("data-date");
            if (!dateStr) return;

            const eventsForDay = eventsByDate[dateStr];
            if (!eventsForDay || eventsForDay.length <= MAX_VISIBLE_EVENTS) return;

            const hiddenCount = eventsForDay.length - MAX_VISIBLE_EVENTS;

            const indicator = document.createElement("div");
            indicator.className = "mie-more-events";
            indicator.textContent = isMobile
                ? `+ ${hiddenCount}`
                : `+ ${hiddenCount} more event${hiddenCount > 1 ? "s" : ""}`;
            indicator.setAttribute("data-date", dateStr);

            indicator.addEventListener("click", (e) => {
                e.stopPropagation();
                showDayEventsModal(dateStr, eventsForDay);
            });

            const dayBottom = dayCell.querySelector(".fc-daygrid-day-bottom");
            const eventsContainer = dayCell.querySelector(".fc-daygrid-day-events");

            if (dayBottom) {
                dayBottom.appendChild(indicator);
            } else if (eventsContainer) {
                eventsContainer.appendChild(indicator);
            }
        });
    }

    // ============================================================
    // Day events modal
    // ============================================================
    function showDayEventsModal(dateStr, events) {
        const date = new Date(dateStr + "T12:00:00");
        const formattedDate = date.toLocaleDateString("en-US", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric"
        });

        dayEventsTitle.textContent = formattedDate;
        dayEventsSubtitle.textContent = `${events.length} event${events.length > 1 ? "s" : ""}`;

        dayEventsList.innerHTML = "";

        const sortedEvents = [...events].sort((a, b) => {
            return new Date(a.start) - new Date(b.start);
        });

        sortedEvents.forEach(event => {
            const item = document.createElement("div");
            item.className = "day-event-item";

            const color = event.extendedProps?.calendarColor || "#3b82f6";
            item.style.borderLeftColor = color;

            let timeString = "";
            if (event.allDay) {
                timeString = "All-day";
            } else {
                const startDate = new Date(event.start);
                const endDate = event.end ? new Date(event.end) : null;
                timeString = startDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
                if (endDate) {
                    timeString += " - " + endDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
                }
            }

            const timeDiv = document.createElement("div");
            timeDiv.className = "day-event-time";
            timeDiv.textContent = timeString;

            const titleDiv = document.createElement("div");
            titleDiv.className = "day-event-title";
            titleDiv.textContent = event.title || "No Title";

            item.appendChild(timeDiv);
            item.appendChild(titleDiv);

            if (event.extendedProps?.location) {
                const locationDiv = document.createElement("div");
                locationDiv.className = "day-event-location";
                locationDiv.textContent = "ðŸ“ " + event.extendedProps.location;
                item.appendChild(locationDiv);
            }

            item.addEventListener("click", () => {
                dayEventsModal.classList.add("hidden");
                showEventDetails(event);
            });

            dayEventsList.appendChild(item);
        });

        dayEventsModal.classList.remove("hidden");
    }

    // ============================================================
    // Fetch events from backend (unchanged)
    // ============================================================
    async function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/events", {
                method: "GET",
                credentials: "include",
            });

            if (resp.status === 401) {
                showAuthArea();
                if (failureCallback) failureCallback(new Error("NOT_CONNECTED"));
                return;
            }

            if (!resp.ok) {
                if (failureCallback) failureCallback(new Error("HTTP " + resp.status));
                return;
            }

            const data = await resp.json();
            const items = Array.isArray(data.events) ? data.events : [];

            // Build eventsByDate map
            eventsByDate = {};

            const events = items.map((e) => {
                const start = (e.start && (e.start.dateTime || e.start.date)) || null;
                const end = (e.end && (e.end.dateTime || e.end.date)) || null;
                const allDay = !!(e.start && e.start.date && !e.start.dateTime);

                const calColor =
                    e.mieCalendarColor ||
                    e._mieCalendarColor ||
                    null;

                const eventObj = {
                    id: e.id,
                    title: e.summary || "No Title",
                    start,
                    end,
                    allDay,
                    url: e.htmlLink || "",
                    extendedProps: {
                        description: e.description || "",
                        location: e.location || "",
                        calendarColor: calColor
                    },
                };

                // Add to eventsByDate map (keyed by YYYY-MM-DD)
                if (start) {
                    let dateStr;
                    if (allDay) {
                        dateStr = start;
                    } else {
                        dateStr = start.split("T")[0];
                    }

                    if (!eventsByDate[dateStr]) {
                        eventsByDate[dateStr] = [];
                    }
                    eventsByDate[dateStr].push(eventObj);
                }

                return eventObj;
            });

            successCallback(events);
        } catch (err) {
            console.error("Error fetching events:", err);
            if (failureCallback) failureCallback(err);
        }
    }

    function showEventDetails(event) {
        eventTitle.textContent = event.title || "No Title";

        const startDate = event.start instanceof Date ? event.start : new Date(event.start);
        const endDate = event.end ? (event.end instanceof Date ? event.end : new Date(event.end)) : null;

        let timeString = "All-day";
        if (!event.allDay && startDate instanceof Date) {
            timeString = startDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            if (endDate) {
                timeString += " - " + endDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            }
        }

        eventTime.textContent =
            startDate.toLocaleDateString() + (event.allDay ? "" : " | " + timeString);

        eventDescription.textContent =
            (event.extendedProps && event.extendedProps.description) || "No description provided.";
        eventLocation.textContent =
            (event.extendedProps && event.extendedProps.location) || "No location provided.";

        if (event.url) {
            eventLink.href = event.url;
            eventLink.classList.remove("pointer-events-none", "opacity-50");
        } else {
            eventLink.href = "#";
            eventLink.classList.add("pointer-events-none", "opacity-50");
        }

        eventModal.classList.remove("hidden");
    }

    // ======== MESSAGING (unchanged) ========
    async function sendMessage() {
        if (!userHasAccess) {
            logMessage("Error: Not connected to Google.", "error");
            return;
        }

        const text = messageInput ? messageInput.value.trim() : "";
        if (!text && !selectedFile) return;

        let payloadText = text;
        if (selectedFile) {
            payloadText += (payloadText ? "\n\n" : "") + "[Attachment selected in UI: " + selectedFile.name + "]";
        }

        logMessage("Sending message...", "info");
        sendButton.disabled = true;

        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/message", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: payloadText }),
            });

            if (!resp.ok) {
                logMessage("Failed to send message. Please try again.", "error");
                return;
            }

            logMessage("Message sent.", "success");
            if (messageInput) messageInput.value = "";
            clearSelectedFile();
        } catch (err) {
            logMessage("Error sending message. Please try again.", "error");
        } finally {
            updateSendButton();
        }
    }

    function handleFileSelect(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) {
            clearSelectedFile();
            return;
        }

        selectedFile = file;

        if (filePreview && previewImage) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImage.src = ev.target.result;
                filePreview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }

        updateSendButton();
    }

    function clearSelectedFile() {
        selectedFile = null;
        if (fileInput) fileInput.value = "";
        if (filePreview) filePreview.classList.add("hidden");
        updateSendButton();
    }

    function updateSendButton() {
        if (!sendButton) return;
        const canSend = (messageInput && messageInput.value.trim() !== "") || selectedFile !== null;
        sendButton.disabled = !canSend;
    }

    function logMessage(msg, type) {
        if (!messageLog) return;
        const entry = document.createElement("div");
        entry.className = "text-sm mb-1";

        if (type === "error") {
            entry.classList.add("text-red-500");
        } else if (type === "success") {
            entry.classList.add("text-green-500");
        } else {
            entry.classList.add("text-gray-600");
        }

        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = "[" + timestamp + "] " + msg;

        const placeholder = messageLog.querySelector(".text-gray-500");
        if (placeholder) placeholder.remove();

        messageLog.appendChild(entry);
        messageLog.scrollTop = messageLog.scrollHeight;
    }
})();
</script>
</body>
</html>
