<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIE Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google APIs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<style>
  body { margin:0; font-family: 'Inter', sans-serif; background-color:#f3f4f6; color:#1f2937; }
  .dark body { background-color:#111827; color:#f9fafb; }
  .flex-grow-scroll { overflow-y:auto; flex-grow:1; }
  .thumbnail { height:50px; width:50px; object-fit:cover; border-radius:6px; }
  .disabled { opacity:0.5; cursor:not-allowed; }
</style>
</head>
<body class="h-screen">

<div class="oauth-app-container flex flex-col lg:flex-row h-full p-4 space-y-4 lg:space-y-0 lg:space-x-4">

  <!-- Calendar Section -->
  <div id="calendar-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col flex-1 min-h-0 p-4">
    <div id="auth-area" class="flex flex-col justify-center items-center flex-1 space-y-4">
      <h2 class="text-xl font-semibold text-center">Sign in to access your Google Calendar</h2>
      <div id="g_id_onload"
           data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-theme="dark" data-text="signin_with" data-size="large"></div>
    </div>

    <div id="calendar-content" class="hidden flex flex-col flex-1 min-h-0">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">Your Calendar</h2>
        <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Sign Out</button>
      </div>
      <div id="calendar-container" class="flex-1 min-h-0"></div>
    </div>
  </div>

  <!-- Messaging Section -->
  <div id="messaging-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col flex-1 min-h-0 p-4 hidden">
    <h2 class="text-xl font-semibold mb-2">Send a Message</h2>
    <div id="message-log" class="flex-grow-scroll bg-gray-50 dark:bg-gray-700 p-2 rounded mb-2 text-sm text-gray-500 dark:text-gray-400">Your sent messages will appear here...</div>

    <textarea id="message-input" placeholder="Type your message..." class="rounded-2xl border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 px-4 py-2 bg-white dark:bg-gray-900 text-gray-900 dark:text-white resize-y min-h-[80px] mb-2"></textarea>

    <div class="flex items-center space-x-2 mb-2">
      <label for="file-input" class="cursor-pointer bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-full">Add Image</label>
      <input id="file-input" type="file" class="hidden" accept="image/*">
      <div id="image-preview-container" class="flex space-x-2"></div>
    </div>

    <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full shadow disabled:bg-blue-300 dark:disabled:bg-blue-900 disabled">Send</button>
  </div>
</div>

<script>
(function(){
  const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
  const API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send';

  let tokenClient, calendar;
  const authArea = document.getElementById('auth-area');
  const calendarContent = document.getElementById('calendar-content');
  const calendarContainer = document.getElementById('calendar-container');
  const messagingSection = document.getElementById('messaging-section');
  const signoutButton = document.getElementById('signout_button');
  const sendButton = document.getElementById('send-button');
  const messageLog = document.getElementById('message-log');
  const messageInput = document.getElementById('message-input');
  const fileInput = document.getElementById('file-input');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  let attachmentData = null;

  signoutButton.addEventListener('click', handleSignOut);
  sendButton.addEventListener('click', sendEmail);

  messageInput.addEventListener('input', () => {
    const hasText = messageInput.value.trim() !== '';
    sendButton.disabled = !hasText;
    sendButton.classList.toggle('disabled', !hasText);
  });

  fileInput.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(file && file.type.startsWith("image/")){
      const reader = new FileReader();
      reader.onload = ev => {
        attachmentData = ev.target.result;
        imagePreviewContainer.innerHTML = `<img src="${attachmentData}" class="thumbnail">`;
      };
      reader.readAsDataURL(file);
    }
  });

  function initializeGapiClient() {
    gapi.client.init({
      discoveryDocs:[
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
      ]
    }).then(()=>console.log("GAPI client initialized."))
      .catch(err=>console.error(err));
  }
  gapi.load('client', initializeGapiClient);

  window.handleCredentialResponse = (response)=>{
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: API_SCOPES,
      callback: async (tokenResponse)=>{
        if(tokenResponse && tokenResponse.access_token){
          gapi.client.setToken(tokenResponse);
          handleAuthSuccess();
        } else console.error('Failed to get access token', tokenResponse);
      }
    });
    tokenClient.requestAccessToken();
  };

  function handleAuthSuccess(){
    authArea.classList.add('hidden');
    calendarContent.classList.remove('hidden');
    messagingSection.classList.remove('hidden');
    displayCalendar();
  }

  function handleSignOut(){
    const token = gapi.client.getToken();
    if(token){
      google.accounts.oauth2.revoke(token.access_token, ()=>gapi.client.setToken(null));
    }
    authArea.classList.remove('hidden');
    calendarContent.classList.add('hidden');
    messagingSection.classList.add('hidden');
    calendarContainer.innerHTML = '';
    messageLog.innerHTML = "Your sent messages will appear here...";
    messageInput.value = '';
    attachmentData = null;
    imagePreviewContainer.innerHTML = '';
  }

  function displayCalendar(){
    if(calendar) calendar.destroy();
    calendar = new FullCalendar.Calendar(calendarContainer, {
      initialView:'dayGridMonth',
      headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
      events: async (fetchInfo, successCallback, failureCallback)=>{
        try{
          const calListResp = await gapi.client.calendar.calendarList.list();
          const calendars = calListResp.result.items;
          const eventPromises = calendars.map(cal=>{
            return gapi.client.calendar.events.list({
              calendarId: cal.id,
              timeMin: fetchInfo.start.toISOString(),
              timeMax: fetchInfo.end.toISOString(),
              showDeleted:false,
              singleEvents:true
            }).then(resp=>{
              return resp.result.items.map(ev=>({
                ...ev,
                color: cal.backgroundColor
              }));
            });
          });
          const allEvents = (await Promise.all(eventPromises)).flat().map(ev=>({
            title: ev.summary || "(No title)",
            start: ev.start.dateTime || ev.start.date,
            end: ev.end.dateTime || ev.end.date,
            url: ev.htmlLink,
            backgroundColor: ev.color,
            borderColor: ev.color
          }));
          successCallback(allEvents);
        } catch(err){ console.error(err); failureCallback(err); }
      },
      eventClick: function(info){
        info.jsEvent.preventDefault();
        if(info.event.url) window.open(info.event.url,"_blank");
      }
    });
    calendar.render();
  }

  async function sendEmail(){
    let userProfile;
    try{
      const profileResp = await gapi.client.gmail.users.getProfile({userId:'me'});
      userProfile = profileResp.result;
    } catch(err){
      logMessage("Error: Could not retrieve your email address.","error");
      return;
    }

    if(!messageInput.value.trim() && !attachmentData) return;

    let subject = `Message received from ${userProfile.emailAddress}`;
    let body = messageInput.value;
    let emailParts = [
      `To: save@mie.today`,
      `From: ${userProfile.emailAddress}`,
      `Subject: ${subject}`,
      'MIME-Version: 1.0',
      'Content-Type: multipart/mixed; boundary="boundary_string"',
      '',
      '--boundary_string',
      'Content-Type: text/plain; charset="UTF-8"',
      '',
      body
    ];

    if(attachmentData){
      let base64Content = attachmentData.split(',')[1];
      emailParts.push(
        '--boundary_string',
        'Content-Type: image/png; name="attachment.png"',
        'Content-Transfer-Encoding: base64',
        'Content-Disposition: attachment; filename="attachment.png"',
        '',
        base64Content
      );
    }
    emailParts.push('--boundary_string--');

    const raw = btoa(unescape(encodeURIComponent(emailParts.join("\r\n")))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

    sendButton.disabled = true;
    sendButton.classList.add('disabled');

    try{
      await gapi.client.gmail.users.messages.send({userId:'me', resource:{raw}});
      logMessage("Email sent successfully!","success");
      messageInput.value = '';
      attachmentData = null;
      imagePreviewContainer.innerHTML = '';
    } catch(err){
      console.error(err);
      logMessage(`Failed to send email: ${err.result?.error?.message || 'Unknown error'}`,"error");
    } finally {
      sendButton.disabled = false;
      sendButton.classList.remove('disabled');
    }
  }

  function logMessage(text,type='info'){
    if(messageLog.innerHTML.includes('Your sent messages')) messageLog.innerHTML='';
    const p = document.createElement('p');
    const colors = {success:'text-green-500',error:'text-red-500',info:'text-gray-900 dark:text-gray-200'};
    p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
    p.className = `text-sm mb-1 ${colors[type]}`;
    messageLog.appendChild(p);
    messageLog.scrollTop = messageLog.scrollHeight;
  }

})();
</script>
</body>
</html>
