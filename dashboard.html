<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google API Client Library (no longer used for auth; safe to keep) -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400&family=Montserrat:wght@600&display=swap"
  rel="stylesheet"
/>

<style>
    /* --- General Body and Layout --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Custom font classes */
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-lato { font-family: 'Lato', sans-serif; }

    /* --- Scrollbar Styling --- */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    /* Utility class for disabled elements */
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main container for the entire application */
    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* --- Responsive Styles for Mobile (up to 480px wide) --- */
    @media (max-width: 480px) {
        .oauth-app-container {
            width: 100% !important;
        }
        .mobile-container {
            padding: 4px !important;
            gap: 4px !important;
        }
        .calendar-section, .messaging-section {
            width: 100% !important;
            height: auto !important;
            padding: 8px !important;
        }
        .mobile-heading { font-size: 20px !important; line-height: 1.2 !important; }
        .mobile-text { font-size: 14px !important; line-height: 1.1 !important; }
        .mobile-small-btn { padding: 4px 8px !important; font-size: 12px !important; }
        .mobile-text-btn { font-size: 16px !important; }
        .mobile-textarea { height: 60px !important; padding: 4px 8px !important; }
        .fc .fc-toolbar-title { font-size: 20px !important; }
        .fc .fc-button-primary { font-size: 12px !important; padding: 4px 6px !important; }
        .fc .fc-col-header-cell { font-size: 12px !important; }
        .fc .fc-daygrid-day-number { font-size: 12px !important; }
        .fc .fc-event { font-size: 10px !important; }
    }

    /* --- Responsive Styles for Tablet (481px to 768px) --- */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 632px; }
        .messaging-section { width: 481px; height: 316px; }
    }

    /* --- Responsive Styles for Desktop (769px and wider) --- */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 860px; }
        .messaging-section { width: 800px; height: 360px; }
    }

    /* --- FullCalendar Light Mode Customization --- */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }
    .fc-daygrid-day.fc-day-today { background-color: rgba(59,130,246,0.1) !important; }
    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }

    /* IMPORTANT: do NOT force one color for all events */
    .fc .fc-event {
        /* let JS set colors per calendar */
        border-color: transparent;
        background-color: transparent;
        color: inherit;
    }

    .fc .fc-toolbar-title { color: #1f2937 !important; }
    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* Bullet dot in timed events */
    .mie-event-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 9999px;
        margin-right: 4px;
        flex-shrink: 0;
    }

    /* --- Event Modal Styling --- */
    .event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .event-modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); color: #1f2937; }
    @media (max-width: 480px){ .event-modal-content { max-width: 320px !important; padding: 16px !important; } }

    /* --- Access Denied Styling --- */
    .access-denied { color: #dc2626; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px; }
</style>
</head>
<body class="bg-white">

<!-- Main App Container -->
<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <!-- ===== Calendar Section ===== -->
        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">

            <!-- Authentication Area (signed out / pre-consent) -->
            <div id="auth-area" class="flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />

                <h1 class="font-montserrat text-2xl font-semibold text-gray-800" style="font-size: 18pt;">Mie</h1>
                <p class="font-lato text-base text-gray-600 mt-1 mb-6" style="font-size: 12pt;">Remember your life</p>

                <!-- Connect CTA -->
                <button
                    id="connect-google-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full px-5 py-2 text-sm flex items-center shadow"
                    style="min-width:200px; justify-content:center;"
                >
                    Connect Google
                </button>

                <div class="mt-6 text-sm text-gray-500">
                    or
                    <a href="signup.html"
                       class="font-semibold text-green-600 hover:text-green-700 hover:underline">
                    Create an account
                    </a>
                </div>
            </div>

            <!-- Access Verification Area -->
            <div id="access-check-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-gray-800 mb-4">Verifying Access...</h2>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-4">Checking if your account has access to Mie dashboard</p>
            </div>

            <!-- Access Denied Area -->
            <div id="access-denied-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-red-600 mb-4">Access Denied</h2>
                <div class="access-denied text-center max-w-md">
                    <p class="mb-3">Your Gmail account doesn't have access to the Mie dashboard.</p>
                    <p class="mb-4">To get access, please sign up with the correct PIN code.</p>
                    <div class="space-y-3">
                        <a href="signup.html" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Sign Up for Access</a>
                        <br />
                        <button id="try-different-account" class="text-blue-600 hover:text-blue-700 underline text-sm">
                            Try a Different Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (signed in + approved) -->
            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-between items-center mb-2">
                    <span id="welcome-message" class="text-sm text-gray-600"></span>
                </div>
                <div id="calendar-container" class="flex-1 min-h-0 mt-1"></div>
            </div>
        </div>

        <!-- ===== Messaging Section ===== -->
        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 mobile-heading">Send a Message</h2>

            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2">
                <div class="text-sm mobile-text text-gray-500">Your sent messages will appear here...</div>
            </div>

            <textarea
                id="message-input"
                placeholder="Type your message..."
                class="rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"
            ></textarea>

            <div class="flex items-center space-x-2 mt-2">
                <label
                    for="file-input"
                    class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-sm py-1 px-3 rounded-full mobile-text"
                >
                    Attachment
                </label>
                <input id="file-input" type="file" class="hidden" accept="image/*" />
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-12 h-12 object-cover rounded border" alt="Preview" />
                    <button id="remove-file" class="text-red-500 text-sm mobile-text">Remove</button>
                </div>
            </div>

            <button
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2 mobile-text-btn"
                disabled
            >
                Send
            </button>

            <!-- Sign Out bottom-right with spacing -->
            <div class="mt-6 flex justify-end">
                <button
                    id="signout_button"
                    class="text-gray-500 text-xs font-semibold mobile-small-btn py-1 px-2 rounded-md"
                >
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Event Details Modal ===== -->
<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl font-semibold mobile-heading"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text"></p>
            <p id="event-description" class="text-gray-700 mobile-text"></p>
            <p id="event-location" class="text-gray-600 mobile-text"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a
                id="event-link"
                target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-btn"
            >
                Open in Google Calendar
            </a>
        </div>
    </div>
</div>

<script>
(function () {
    // ======== CONFIG =========
    const BACKEND_BASE_URL = "https://mie-backend-514922143683.us-central1.run.app";

    // ======== STATE =========
    let calendar = null;
    let selectedFile = null;
    let userEmail = null;
    let userHasAccess = false;

    // ======== DOM HOOKS =========
    const authArea = document.getElementById("auth-area");
    const accessCheckArea = document.getElementById("access-check-area");
    const accessDeniedArea = document.getElementById("access-denied-area");
    const calendarContent = document.getElementById("calendar-content");
    const calendarContainer = document.getElementById("calendar-container");
    const messagingSection = document.getElementById("messaging-section");
    const welcomeMessage = document.getElementById("welcome-message");
    const signoutButton = document.getElementById("signout_button");
    const tryDifferentAccountBtn = document.getElementById("try-different-account");
    const connectGoogleBtn = document.getElementById("connect-google-btn");

    const sendButton = document.getElementById("send-button");
    const messageLog = document.getElementById("message-log");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const removeFileButton = document.getElementById("remove-file");

    const eventModal = document.getElementById("event-modal");
    const closeModal = document.getElementById("close-modal");
    const eventTitle = document.getElementById("event-title");
    const eventTime = document.getElementById("event-time");
    const eventDescription = document.getElementById("event-description");
    const eventLocation = document.getElementById("event-location");
    const eventLink = document.getElementById("event-link");

    // ======== INIT ========
    document.addEventListener("DOMContentLoaded", () => {
        bindEventHandlers();
        initializeDashboard();
    });

    function bindEventHandlers() {
        if (connectGoogleBtn) {
            connectGoogleBtn.addEventListener("click", () => {
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (signoutButton) {
            signoutButton.addEventListener("click", () => handleSignOut(false));
        }

        if (tryDifferentAccountBtn) {
            tryDifferentAccountBtn.addEventListener("click", async () => {
                await handleSignOut(true);
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (sendButton) {
            sendButton.addEventListener("click", (e) => {
                e.preventDefault();
                sendMessage();
            });
        }

        if (messageInput) {
            messageInput.addEventListener("input", updateSendButton);
        }

        if (fileInput) {
            fileInput.addEventListener("change", handleFileSelect);
        }

        if (removeFileButton) {
            removeFileButton.addEventListener("click", (e) => {
                e.preventDefault();
                clearSelectedFile();
            });
        }

        if (closeModal) {
            closeModal.addEventListener("click", () => {
                eventModal.classList.add("hidden");
            });
        }
        if (eventModal) {
            eventModal.addEventListener("click", (e) => {
                if (e.target === eventModal) {
                    eventModal.classList.add("hidden");
                }
            });
        }

        updateSendButton();
    }

    // ======== HIGH-LEVEL FLOW ========
    async function initializeDashboard() {
        showAccessCheck();
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/status", {
                method: "GET",
                credentials: "include",
            });

            if (!resp.ok) {
                console.warn("Status check failed with HTTP", resp.status);
                showAuthArea();
                return;
            }

            const data = await resp.json();

            if (data.connected) {
                userHasAccess = true;
                userEmail = data.userEmail || (data.user && (data.user.email || data.user.primaryEmail)) || "";

                // Build friendly welcome: "Welcome, Jane <xyz@gmail.com>"
                if (welcomeMessage) {
                    const user = data.user || {};
                    let firstName = "";
                    if (user.given_name) {
                        firstName = user.given_name;
                    } else if (user.name) {
                        firstName = user.name.split(" ")[0];
                    }

                    const email = userEmail || "";
                    let label = "Welcome";
                    if (firstName || email) {
                        label += ", ";
                        if (firstName) label += firstName;
                        if (firstName && email) label += " ";
                        if (email) label += "&lt;" + email + "&gt;";
                    }
                    welcomeMessage.innerHTML = label;
                }

                showDashboard();
                displayMonthlyCalendar();
            } else {
                showAuthArea();
            }
        } catch (err) {
            console.error("Error during status check:", err);
            showAuthArea();
        }
    }

    // ======== UI STATE ========
    function showAuthArea() {
        authArea.classList.remove("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessCheck() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.remove("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessDenied() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.remove("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showDashboard() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.remove("hidden");
        messagingSection.classList.remove("hidden");
    }

    // ======== SIGN OUT (BACKEND SESSION) ========
    async function handleSignOut(silent) {
        try {
            await fetch(BACKEND_BASE_URL + "/auth/logout", {
                method: "POST",
                credentials: "include",
            });
        } catch (err) {
            console.error("Error during logout:", err);
        }

        if (!silent) {
            window.location.href = "/dashboard";
        }
    }

    // ======== CALENDAR ========
    function displayMonthlyCalendar() {
        if (!calendarContainer) return;
        if (calendar) {
            calendar.destroy();
            calendar = null;
        }

        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: "dayGridMonth",
            headerToolbar: {
                left: "today",
                center: "title",
                right: "prev,next",
            },
            fixedWeekCount: false,
            showNonCurrentDates: false,
            height: "auto",
            events: fetchCalendarEvents,
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showEventDetails(info.event);
            },
            eventDidMount: function(info) {
                // Per-calendar coloring
                const color =
                    (info.event.extendedProps && info.event.extendedProps.calendarColor) ||
                    "#2563eb";
                const el = info.el;

                if (info.event.allDay) {
                    // All-day events = solid block
                    el.style.backgroundColor = color;
                    el.style.borderColor = color;
                    el.style.color = "#ffffff";
                } else {
                    // Timed events = white bg, black text, colored bullet
                    el.style.backgroundColor = "#ffffff";
                    el.style.border = "1px solid #e5e7eb";
                    el.style.color = "#111827";

                    let dot = el.querySelector(".mie-event-dot");
                    if (!dot) {
                        dot = document.createElement("span");
                        dot.className = "mie-event-dot";
                        const titleEl = el.querySelector(".fc-event-title");
                        if (titleEl) {
                            titleEl.prepend(dot);
                        } else {
                            el.prepend(dot);
                        }
                    }
                    dot.style.backgroundColor = color;
                }
            }
        });

        calendar.render();
    }

    async function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/events", {
                method: "GET",
                credentials: "include",
            });

            if (resp.status === 401) {
                console.warn("Not connected when fetching events");
                showAuthArea();
                if (failureCallback) failureCallback(new Error("NOT_CONNECTED"));
                return;
            }

            if (!resp.ok) {
                console.error("Events fetch failed HTTP", resp.status);
                if (failureCallback) failureCallback(new Error("HTTP " + resp.status));
                return;
            }

            const data = await resp.json();
            const items = Array.isArray(data.events) ? data.events : [];

            const events = items.map((e) => {
                const start = (e.start && (e.start.dateTime || e.start.date)) || null;
                const end = (e.end && (e.end.dateTime || e.end.date)) || null;
                const allDay = !!(e.start && e.start.date && !e.start.dateTime);

                const calColor =
                    e.mieCalendarColor ||
                    e._mieCalendarColor ||
                    "#2563eb";

                return {
                    id: e.id,
                    title: e.summary || "No Title",
                    start,
                    end,
                    allDay,
                    url: e.htmlLink || "",
                    backgroundColor: allDay ? calColor : "#ffffff",
                    borderColor: allDay ? calColor : "#e5e7eb",
                    textColor: allDay ? "#ffffff" : "#111827",
                    extendedProps: {
                        description: e.description || "",
                        location: e.location || "",
                        calendarColor: calColor
                    },
                };
            });

            successCallback(events);
        } catch (err) {
            console.error("Error fetching events:", err);
            if (failureCallback) failureCallback(err);
        }
    }

    function showEventDetails(event) {
        eventTitle.textContent = event.title || "No Title";

        const startDate = event.start instanceof Date ? event.start : new Date(event.start);
        const endDate = event.end ? (event.end instanceof Date ? event.end : new Date(event.end)) : null;

        let timeString = "All-day";
        if (!event.allDay && startDate instanceof Date) {
            timeString = startDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            if (endDate) {
                timeString += " - " + endDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            }
        }

        eventTime.textContent =
            startDate.toLocaleDateString() + (event.allDay ? "" : " | " + timeString);

        eventDescription.textContent =
            (event.extendedProps && event.extendedProps.description) || "No description provided.";
        eventLocation.textContent =
            (event.extendedProps && event.extendedProps.location) || "No location provided.";

        if (event.url) {
            eventLink.href = event.url;
            eventLink.classList.remove("pointer-events-none", "opacity-50");
        } else {
            eventLink.href = "#";
            eventLink.classList.add("pointer-events-none", "opacity-50");
        }

        eventModal.classList.remove("hidden");
    }

    // ======== MESSAGING ========
    async function sendMessage() {
        if (!userHasAccess) {
            logMessage("Error: Not connected to Google.", "error");
            return;
        }

        const text = messageInput ? messageInput.value.trim() : "";
        if (!text && !selectedFile) return;

        let payloadText = text;
        if (selectedFile) {
            payloadText += (payloadText ? "\n\n" : "") + "[Attachment selected in UI: " + selectedFile.name + "]";
        }

        logMessage("Sending message...", "info");
        sendButton.disabled = true;

        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/message", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: payloadText }),
            });

            if (!resp.ok) {
                console.error("Send message failed HTTP", resp.status);
                logMessage("Failed to send message. Please try again.", "error");
                return;
            }

            logMessage("Message sent.", "success");
            if (messageInput) messageInput.value = "";
            clearSelectedFile();
        } catch (err) {
            console.error("Error sending message:", err);
            logMessage("Error sending message. Please try again.", "error");
        } finally {
            updateSendButton();
        }
    }

    function handleFileSelect(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) {
            clearSelectedFile();
            return;
        }

        selectedFile = file;

        if (filePreview && previewImage) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImage.src = ev.target.result;
                filePreview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }

        updateSendButton();
    }

    function clearSelectedFile() {
        selectedFile = null;
        if (fileInput) fileInput.value = "";
        if (filePreview) filePreview.classList.add("hidden");
        updateSendButton();
    }

    function updateSendButton() {
        if (!sendButton) return;
        const canSend = (messageInput && messageInput.value.trim() !== "") || selectedFile !== null;
        sendButton.disabled = !canSend;
    }

    function logMessage(msg, type) {
        if (!messageLog) return;
        const entry = document.createElement("div");
        entry.className = "text-sm mb-1";

        if (type === "error") {
            entry.classList.add("text-red-500");
        } else if (type === "success") {
            entry.classList.add("text-green-500");
        } else {
            entry.classList.add("text-gray-600");
        }

        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = "[" + timestamp + "] " + msg;

        const placeholder = messageLog.querySelector(".text-gray-500");
        if (placeholder) placeholder.remove();

        messageLog.appendChild(entry);
        messageLog.scrollTop = messageLog.scrollHeight;
    }
})();
</script>
</body>
</html>
