<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google API Client Library (no longer used for auth; safe to keep) -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400&family=Montserrat:wght@600&display=swap"
  rel="stylesheet"
/>

<style>
    /* --- General Body and Layout --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Custom font classes */
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-lato { font-family: 'Lato', sans-serif; }

    /* --- Scrollbar Styling --- */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    /* Utility class for disabled elements */
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main container for the entire application */
    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* --- Responsive Styles for Mobile (up to 480px wide) --- */
    @media (max-width: 480px) {
        .oauth-app-container {
            width: 100% !important;
        }
        .mobile-container {
            padding: 4px !important;
            gap: 4px !important;
        }
        .calendar-section, .messaging-section {
            width: 100% !important;
            height: auto !important;
            padding: 8px !important;
        }
        .mobile-heading { font-size: 20px !important; line-height: 1.2 !important; }
        .mobile-text { font-size: 14px !important; line-height: 1.1 !important; }
        .mobile-small-btn { padding: 4px 8px !important; font-size: 12px !important; }
        .mobile-text-btn { font-size: 16px !important; }
        .mobile-textarea { height: 60px !important; padding: 4px 8px !important; }

        .fc .fc-toolbar-title { font-size: 20px !important; line-height: 1.2 !important; }
        .fc .fc-button-primary { font-size: 12px !important; padding: 4px 6px !important; line-height: 1.2 !important; }

        .fc .fc-col-header-cell { font-size: 12px !important; }
        .fc .fc-daygrid-day-number { font-size: 12px !important; }

        .fc .fc-event { font-size: 10px !important; } /* * <- EVENT FONT SIZE (MOBILE) */
    }

    /* --- Responsive Styles for Tablet (481px to 768px) --- */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 720px; }  /* a bit taller to avoid scroll */
        .messaging-section { width: 481px; height: 316px; }
    }

    /* --- Responsive Styles for Desktop (769px and wider) --- */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 820px; }  /* tuned so no right scrollbar */
        .messaging-section { width: 800px; height: 360px; }
    }

    /* --- FullCalendar Light Mode Customization --- */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }
    .fc-daygrid-day.fc-day-today { background-color: rgba(59,130,246,0.1) !important; }
    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }

    /* Hide FullCalendar's built-in dot so we only show our custom one */
    .fc-daygrid-event-dot { display: none !important; }

    /* Let JS handle background/border per calendar, but force text to black */
    .fc .fc-event {
      border-color: transparent;
      background-color: transparent;
      color: #000000 !important;
      font-size: 12px;          /* * <- EVENT FONT SIZE (DESKTOP/TABLET). Change this as needed. */
      line-height: 1.2;
    }

    /* Force ALL event text to stay inside the day cell (no spillover) */
    .fc-daygrid-event-harness,
    .fc-daygrid-event,
    .fc-daygrid-event .fc-event-main,
    .fc-daygrid-event .fc-event-title,
    .fc-daygrid-event .fc-event-title-container,
    .fc-daygrid-event .fc-event-main-frame {
      max-width: 100% !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      box-sizing: border-box !important;
    }

    /* Also force inner text wrappers to black, to override any defaults */
    .fc .fc-event .fc-event-main,
    .fc .fc-event .fc-event-title {
      color: #000000 !important;
    }

    .fc .fc-toolbar-title {
      color: #1f2937 !important;
      font-size: 19px !important;  /* 1px larger per your request */
      line-height: 1.2 !important;
      font-weight: 600;
    }

    /* Make Today + arrows match title height */
    .fc .fc-toolbar .fc-button {
      font-size: 19px !important;     /* match title height */
      line-height: 1.2 !important;
      padding: 2px 8px !important;    /* tighter button */
      height: auto !important;
      border-radius: 6px !important;
    }

    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* Bullet dot in timed events */
    .mie-event-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 9999px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    /* 
     * ========================================
     * NEW: "+ X more events" indicator styling
     * ========================================
     */
    .mie-more-events {
      display: block;
      padding: 2px 6px;
      margin-top: 2px;
      font-size: 11px;
      font-weight: 600;
      color: #3b82f6;
      background-color: #eff6ff;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .mie-more-events:hover {
      background-color: #dbeafe;
      color: #2563eb;
    }

    /* --- Event Modal Styling --- */
    .event-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.5); 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
    }
    
    .event-modal-content { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      max-width: 400px; 
      width: 90%; 
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
      color: #1f2937; 
    }
    
    @media (max-width: 480px){ 
      .event-modal-content { 
        max-width: 320px !important; 
        padding: 16px !important; 
      } 
    }

    /* 
     * ========================================
     * NEW: Day Events Modal Styling
     * This modal shows all events for a specific day when clicking "+ X more"
     * ========================================
     */
    .day-events-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .day-events-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      color: #1f2937;
    }

    /* Scrollbar styling for day events modal */
    .day-events-modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .day-events-modal-content::-webkit-scrollbar-track {
      background-color: #f3f4f6;
      border-radius: 9999px;
    }

    .day-events-modal-content::-webkit-scrollbar-thumb {
      background-color: #9ca3af;
      border-radius: 9999px;
    }

    .day-events-modal-content::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    /* Event item in the day modal */
    .day-event-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #3b82f6;
      background-color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day-event-item:hover {
      background-color: #f3f4f6;
      transform: translateX(2px);
    }

    .day-event-time {
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .day-event-title {
      color: #1f2937;
      font-size: 14px;
      font-weight: 500;
    }

    .day-event-location {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .day-events-modal-content {
        max-width: 340px !important;
        padding: 16px !important;
      }

      .day-event-item {
        padding: 10px !important;
      }

      .day-event-time {
        font-size: 12px !important;
      }

      .day-event-title {
        font-size: 13px !important;
      }
    }

    /* --- Access Denied Styling --- */
    .access-denied { color: #dc2626; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px; }
</style>
</head>

<body class="bg-white">

<!-- Main App Container -->
<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <!-- ===== Calendar Section ===== -->
        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">

            <!-- Authentication Area (signed out / pre-consent) -->
            <div id="auth-area" class="flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />

                <h1 class="font-montserrat text-2xl font-semibold text-gray-800" style="font-size: 18pt;">Mie</h1>
                <p class="font-lato text-base text-gray-600 mt-1 mb-6" style="font-size: 12pt;">Remember your life</p>

                <!-- Connect CTA -->
                <button
                    id="connect-google-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full px-5 py-2 text-sm flex items-center shadow"
                    style="min-width:200px; justify-content:center;"
                >
                    Connect Google
                </button>

                <div class="mt-6 text-sm text-gray-500">
                    or
                    <a href="signup.html"
                       class="font-semibold text-green-600 hover:text-green-700 hover:underline">
                    Create an account
                    </a>
                </div>
            </div>

            <!-- Access Verification Area -->
            <div id="access-check-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-gray-800 mb-4">Verifying Access...</h2>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-4">Checking if youryour account has access to Mie dashboard</p>
            </div>

            <!-- Access Denied Area -->
            <div id="access-denied-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-red-600 mb-4">Access Denied</h2>
                <div class="access-denied text-center max-w-md">
                    <p class="mb-3">Your Gmail account doesn't have access to the Mie dashboard.</p>
                    <p class="mb-4">To get access, please sign up with the correct PIN code.</p>
                    <div class="space-y-3">
                        <a href="signup.html" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Sign Up for Access</a>
                        <br />
                        <button id="try-different-account" class="text-blue-600 hover:text-blue-700 underline text-sm">
                            Try a Different Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (signed in + approved) -->
            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-between items-center mb-2">
                    <span id="welcome-message" class="text-sm text-gray-600"></span>
                </div>
                <div id="calendar-container" class="flex-1 min-h-0 mt-1"></div>
            </div>
        </div>

        <!-- ===== Messaging Section ===== -->
        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 mobile-heading">Send a Message</h2>

            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2">
                <div class="text-sm mobile-text text-gray-500">Your sent messages will appear here...</div>
            </div>

            <textarea
                id="message-input"
                placeholder="Type your message..."
                class="rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"
            ></textarea>

            <div class="flex items-center space-x-2 mt-2">
                <label
                    for="file-input"
                    class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-sm py-1 px-3 rounded-full mobile-text"
                >
                    Attachment
                </label>
                <input id="file-input" type="file" class="hidden" accept="image/*" />
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-12 h-12 object-cover rounded border" alt="Preview" />
                    <button id="remove-file" class="text-red-500 text-sm mobile-text">Remove</button>
                </div>
            </div>

            <button
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2 mobile-text-btn"
                disabled
            >
                Send
            </button>

            <!-- Sign Out bottom-right with spacing -->
            <div class="mt-6 flex justify-end">
                <button
                    id="signout_button"
                    class="text-gray-500 text-xs font-semibold mobile-small-btn py-1 px-2 rounded-md"
                >
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Event Details Modal ===== -->
<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl font-semibold mobile-heading"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text"></p>
            <p id="event-description" class="text-gray-700 mobile-text"></p>
            <p id="event-location" class="text-gray-600 mobile-text"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a
                id="event-link"
                target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-btn"
            >
                Open in Google Calendar
            </a>
        </div>
    </div>
</div>

<!-- 
  ========================================
  NEW: Day Events Modal
  Shows all events for a specific day when user clicks "+ X more events"
  ========================================
-->
<div id="day-events-modal" class="day-events-modal hidden">
    <div class="day-events-modal-content">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 id="day-events-title" class="text-xl font-semibold mobile-heading text-gray-800"></h3>
                <p id="day-events-subtitle" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button id="close-day-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="day-events-list" class="space-y-2">
            <!-- Events will be dynamically inserted here -->
        </div>
    </div>
</div>

<script>
(function () {
    // ======== CONFIG =========
    // UPDATED: Use your custom domain (matches GOOGLE_REDIRECT_URI and avoids raw Cloud Run host showing)
    const BACKEND_BASE_URL = "https://api.mie.today";

    /* 
     * ========================================
     * NEW: Configuration for event display limiting
     * ========================================
     */
    const MAX_VISIBLE_EVENTS = 5; // Show only first 5 events per day

    // ======== STATE =========
    let calendar = null;
    let selectedFile = null;
    let userEmail = null;
    let userHasAccess = false;

    /* 
     * ========================================
     * NEW: Store all events by date for the day modal
     * Key format: "YYYY-MM-DD"
     * Value: Array of event objects
     * ========================================
     */
    let eventsByDate = {};

    // ======== DOM HOOKS =========
    const authArea = document.getElementById("auth-area");
    const accessCheckArea = document.getElementById("access-check-area");
    const accessDeniedArea = document.getElementById("access-denied-area");
    const calendarContent = document.getElementById("calendar-content");
    const calendarContainer = document.getElementById("calendar-container");
    const messagingSection = document.getElementById("messaging-section");
    const welcomeMessage = document.getElementById("welcome-message");
    const signoutButton = document.getElementById("signout_button");
    const tryDifferentAccountBtn = document.getElementById("try-different-account");
    const connectGoogleBtn = document.getElementById("connect-google-btn");

    const sendButton = document.getElementById("send-button");
    const messageLog = document.getElementById("message-log");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const removeFileButton = document.getElementById("remove-file");

    const eventModal = document.getElementById("event-modal");
    const closeModal = document.getElementById("close-modal");
    const eventTitle = document.getElementById("event-title");
    const eventTime = document.getElementById("event-time");
    const eventDescription = document.getElementById("event-description");
    const eventLocation = document.getElementById("event-location");
    const eventLink = document.getElementById("event-link");

    /* 
     * ========================================
     * NEW: Day events modal DOM elements
     * ========================================
     */
    const dayEventsModal = document.getElementById("day-events-modal");
    const closeDayModal = document.getElementById("close-day-modal");
    const dayEventsTitle = document.getElementById("day-events-title");
    const dayEventsSubtitle = document.getElementById("day-events-subtitle");
    const dayEventsList = document.getElementById("day-events-list");

    // ======== INIT ========
    document.addEventListener("DOMContentLoaded", () => {
        bindEventHandlers();
        initializeDashboard();
    });

    function bindEventHandlers() {
        if (connectGoogleBtn) {
            connectGoogleBtn.addEventListener("click", () => {
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (signoutButton) {
            signoutButton.addEventListener("click", () => handleSignOut(false));
        }

        if (tryDifferentAccountBtn) {
            tryDifferentAccountBtn.addEventListener("click", async () => {
                await handleSignOut(true);
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (sendButton) {
            sendButton.addEventListener("click", (e) => {
                e.preventDefault();
                sendMessage();
            });
        }

        if (messageInput) {
            messageInput.addEventListener("input", updateSendButton);
        }

        if (fileInput) {
            fileInput.addEventListener("change", handleFileSelect);
        }

        if (removeFileButton) {
            removeFileButton.addEventListener("click", (e) => {
                e.preventDefault();
                clearSelectedFile();
            });
        }

        if (closeModal) {
            closeModal.addEventListener("click", () => {
                eventModal.classList.add("hidden");
            });
        }
        if (eventModal) {
            eventModal.addEventListener("click", (e) => {
                if (e.target === eventModal) {
                    eventModal.classList.add("hidden");
                }
            });
        }

        /* 
         * ========================================
         * NEW: Day events modal event handlers
         * ========================================
         */
        if (closeDayModal) {
            closeDayModal.addEventListener("click", () => {
                dayEventsModal.classList.add("hidden");
            });
        }
        if (dayEventsModal) {
            dayEventsModal.addEventListener("click", (e) => {
                if (e.target === dayEventsModal) {
                    dayEventsModal.classList.add("hidden");
                }
            });
        }

        updateSendButton();
    }

    // ======== HIGH-LEVEL FLOW ========
    async function initializeDashboard() {
        showAccessCheck();
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/status", {
                method: "GET",
                credentials: "include",
            });

            if (!resp.ok) {
                console.warn("Status check failed with HTTP", resp.status);
                showAuthArea();
                return;
            }

            const data = await resp.json();

            if (data.connected) {
                userHasAccess = true;
                userEmail = data.userEmail || (data.user && (data.user.email || data.user.primaryEmail)) || "";

                if (welcomeMessage) {
                    const user = data.user || {};
                    let firstName = "";
                    if (user.given_name) {
                        firstName = user.given_name;
                    } else if (user.name) {
                        firstName = user.name.split(" ")[0];
                    }

                    const email = userEmail || "";
                    let label = "Welcome";
                    if (firstName || email) {
                        label += ", ";
                        if (firstName) label += firstName;
                        if (firstName && email) label += " ";
                        if (email) label += "&lt;" + email + "&gt;";
                    }
                    welcomeMessage.innerHTML = label;
                }

                showDashboard();
                displayMonthlyCalendar();
            } else {
                showAuthArea();
            }
        } catch (err) {
            console.error("Error during status check:", err);
            showAuthArea();
        }
    }

    // ======== UI STATE ========
    function showAuthArea() {
        authArea.classList.remove("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessCheck() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.remove("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessDenied() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.remove("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showDashboard() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.remove("hidden");
        messagingSection.classList.remove("hidden");
    }

    // ======== SIGN OUT (BACKEND SESSION) ========
    async function handleSignOut(silent) {
        try {
            await fetch(BACKEND_BASE_URL + "/auth/logout", {
                method: "POST",
                credentials: "include",
            });
        } catch (err) {
            console.error("Error during logout:", err);
        }

        // UPDATED: GitHub Pages typically serves static files; "/dashboard" may not exist as a real file.
        if (!silent) {
            window.location.href = "dashboard.html";
        }
    }

    // ======== CALENDAR ========
    function displayMonthlyCalendar() {
        if (!calendarContainer) return;
        if (calendar) {
            calendar.destroy();
            calendar = null;
        }

        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: "dayGridMonth",
            headerToolbar: {
                left: "today",
                center: "title",
                right: "prev,next",
            },
            fixedWeekCount: false,
            showNonCurrentDates: false,
            height: "100%",

            /* âœ… NEW: keeps late-night events (e.g., 11:35pâ€“12:05a) on the start day,
               preventing an empty "gap" at the top of the next day cell. */
            nextDayThreshold: "01:00:00",

            events: fetchCalendarEvents,

            /* 
             * ========================================
             * UPDATED: didMount callback to add "+ X more" indicator after calendar renders
             * This runs after FullCalendar has rendered all events
             * ========================================
             */
            eventDidMount: function(info) {
                // This function is called for each event as it's being mounted to the DOM
                // We'll use a separate mechanism to add the "+ X more" indicator
            },

            /* 
             * ========================================
             * NEW: After all events are mounted, add the "+ X more" indicators
             * We use the viewDidMount callback which fires after the view is fully rendered
             * ========================================
             */
            viewDidMount: function(info) {
                addMoreEventsIndicators();
            },

            eventContent: function(arg) {
                const event = arg.event;
                const isAllDay = event.allDay;

                const color =
                    (event.extendedProps && event.extendedProps.calendarColor) ||
                    arg.backgroundColor ||
                    arg.borderColor ||
                    "#3b82f6";

                const container = document.createElement("div");
                container.className = "flex items-center";
                container.style.maxWidth = "100%";
                container.style.overflow = "hidden";
                container.style.textOverflow = "ellipsis";
                container.style.whiteSpace = "nowrap";
                container.style.boxSizing = "border-box";

                if (isAllDay) {
                    container.textContent = event.title || "";
                    container.style.backgroundColor = color;
                    container.style.borderRadius = "4px";
                    container.style.padding = "0 4px";
                    container.style.display = "block";
                    container.style.color = "#000000";
                    return { domNodes: [container] };
                }

                const dot = document.createElement("span");
                dot.className = "mie-event-dot";
                dot.style.backgroundColor = color;
                container.appendChild(dot);

                const timeSpan = document.createElement("span");
                timeSpan.className = "mie-event-time font-semibold mr-1";
                timeSpan.textContent = arg.timeText || "";
                timeSpan.style.flexShrink = "0";
                container.appendChild(timeSpan);

                const titleSpan = document.createElement("span");
                titleSpan.className = "mie-event-title";
                titleSpan.textContent = event.title || "";
                titleSpan.style.minWidth = "0";
                titleSpan.style.flexShrink = "1";
                titleSpan.style.overflow = "hidden";
                titleSpan.style.textOverflow = "ellipsis";
                titleSpan.style.whiteSpace = "nowrap";
                container.appendChild(titleSpan);

                return { domNodes: [container] };
            },

            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showEventDetails(info.event);
            },
        });

        calendar.render();
    }

    /* 
     * ========================================
     * NEW: Function to add "+ X more events" indicators to day cells
     * This function runs after FullCalendar has rendered all events
     * It identifies days with more than MAX_VISIBLE_EVENTS and adds the indicator
     * ========================================
     */
    function addMoreEventsIndicators() {
        // Get all day cells in the calendar
        const dayCells = document.querySelectorAll('.fc-daygrid-day');
        
        dayCells.forEach(dayCell => {
            // Get the date for this cell
            const dateStr = dayCell.getAttribute('data-date');
            if (!dateStr) return;
            
            // Check if we have events for this date
            const eventsForDay = eventsByDate[dateStr];
            if (!eventsForDay || eventsForDay.length <= MAX_VISIBLE_EVENTS) return;
            
            // Calculate how many events are hidden
            const hiddenCount = eventsForDay.length - MAX_VISIBLE_EVENTS;
            
            // Find the events container within this day cell
            const eventsContainer = dayCell.querySelector('.fc-daygrid-day-events');
            if (!eventsContainer) return;
            
            // Hide events beyond the limit
            const eventElements = eventsContainer.querySelectorAll('.fc-daygrid-event-harness');
            eventElements.forEach((eventEl, index) => {
                if (index >= MAX_VISIBLE_EVENTS) {
                    eventEl.style.display = 'none';
                }
            });
            
            // Create the "+ X more events" indicator
            const moreIndicator = document.createElement('div');
            moreIndicator.className = 'mie-more-events';
            moreIndicator.textContent = `+ ${hiddenCount} more event${hiddenCount > 1 ? 's' : ''}`;
            moreIndicator.setAttribute('data-date', dateStr);
            
            // Add click handler to show the day events modal
            moreIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                showDayEventsModal(dateStr, eventsForDay);
            });
            
            // Append the indicator to the day cell's bottom area
            const dayBottom = dayCell.querySelector('.fc-daygrid-day-bottom');
            if (dayBottom) {
                dayBottom.appendChild(moreIndicator);
            } else {
                // If there's no bottom area, append to the events container
                eventsContainer.appendChild(moreIndicator);
            }
        });
    }

    /* 
     * ========================================
     * NEW: Function to show the day events modal
     * Displays all events for a specific day when user clicks "+ X more"
     * ========================================
     */
    function showDayEventsModal(dateStr, events) {
        // Format the date for display
        const date = new Date(dateStr + 'T12:00:00');
        const formattedDate = date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Set modal title
        dayEventsTitle.textContent = formattedDate;
        dayEventsSubtitle.textContent = `${events.length} event${events.length > 1 ? 's' : ''}`;
        
        // Clear previous events
        dayEventsList.innerHTML = '';
        
        // Sort events by start time
        const sortedEvents = [...events].sort((a, b) => {
            const aStart = new Date(a.start);
            const bStart = new Date(b.start);
            return aStart - bStart;
        });
        
        // Add each event to the modal
        sortedEvents.forEach(event => {
            const eventItem = document.createElement('div');
            eventItem.className = 'day-event-item';
            
            // Set border color from event's calendar color
            const color = event.extendedProps?.calendarColor || '#3b82f6';
            eventItem.style.borderLeftColor = color;
            
            // Format time
            let timeString = '';
            if (event.allDay) {
                timeString = 'All-day';
            } else {
                const startDate = new Date(event.start);
                const endDate = event.end ? new Date(event.end) : null;
                timeString = startDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                if (endDate) {
                    timeString += ' - ' + endDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                }
            }
            
            // Create event content
            const timeDiv = document.createElement('div');
            timeDiv.className = 'day-event-time';
            timeDiv.textContent = timeString;
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'day-event-title';
            titleDiv.textContent = event.title || 'No Title';
            
            eventItem.appendChild(timeDiv);
            eventItem.appendChild(titleDiv);
            
            // Add location if available
            if (event.extendedProps?.location) {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'day-event-location';
                locationDiv.textContent = 'ðŸ“ ' + event.extendedProps.location;
                eventItem.appendChild(locationDiv);
            }
            
            // Add click handler to show event details
            eventItem.addEventListener('click', () => {
                dayEventsModal.classList.add('hidden');
                showEventDetails(event);
            });
            
            dayEventsList.appendChild(eventItem);
        });
        
        // Show the modal
        dayEventsModal.classList.remove('hidden');
    }

    async function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/events", {
                method: "GET",
                credentials: "include",
            });

            if (resp.status === 401) {
                showAuthArea();
                if (failureCallback) failureCallback(new Error("NOT_CONNECTED"));
                return;
            }

            if (!resp.ok) {
                if (failureCallback) failureCallback(new Error("HTTP " + resp.status));
                return;
            }

            const data = await resp.json();
            const items = Array.isArray(data.events) ? data.events : [];

            /* 
             * ========================================
             * UPDATED: Build eventsByDate map as we process events
             * This allows us to track all events per day for the modal
             * ========================================
             */
            eventsByDate = {}; // Reset the map

            const events = items.map((e) => {
                const start = (e.start && (e.start.dateTime || e.start.date)) || null;
                const end = (e.end && (e.end.dateTime || e.end.date)) || null;
                const allDay = !!(e.start && e.start.date && !e.start.dateTime);

                const calColor =
                    e.mieCalendarColor ||
                    e._mieCalendarColor ||
                    null;

                const eventObj = {
                    id: e.id,
                    title: e.summary || "No Title",
                    start,
                    end,
                    allDay,
                    url: e.htmlLink || "",
                    extendedProps: {
                        description: e.description || "",
                        location: e.location || "",
                        calendarColor: calColor
                    },
                };

                // Extract date string (YYYY-MM-DD) from the start date
                if (start) {
                    let dateStr;
                    if (allDay) {
                        // For all-day events, the date is already in YYYY-MM-DD format
                        dateStr = start;
                    } else {
                        // For timed events, extract the date part
                        dateStr = start.split('T')[0];
                    }
                    
                    // Add this event to the eventsByDate map
                    if (!eventsByDate[dateStr]) {
                        eventsByDate[dateStr] = [];
                    }
                    eventsByDate[dateStr].push(eventObj);
                }

                return eventObj;
            });

            successCallback(events);
        } catch (err) {
            if (failureCallback) failureCallback(err);
        }
    }

    function showEventDetails(event) {
        eventTitle.textContent = event.title || "No Title";

        const startDate = event.start instanceof Date ? event.start : new Date(event.start);
        const endDate = event.end ? (event.end instanceof Date ? event.end : new Date(event.end)) : null;

        let timeString = "All-day";
        if (!event.allDay && startDate instanceof Date) {
            timeString = startDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            if (endDate) {
                timeString += " - " + endDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            }
        }

        eventTime.textContent =
            startDate.toLocaleDateString() + (event.allDay ? "" : " | " + timeString);

        eventDescription.textContent =
            (event.extendedProps && event.extendedProps.description) || "No description provided.";
        eventLocation.textContent =
            (event.extendedProps && event.extendedProps.location) || "No location provided.";

        if (event.url) {
            eventLink.href = event.url;
            eventLink.classList.remove("pointer-events-none", "opacity-50");
        } else {
            eventLink.href = "#";
            eventLink.classList.add("pointer-events-none", "opacity-50");
        }

        eventModal.classList.remove("hidden");
    }

    // ======== MESSAGING ========
    async function sendMessage() {
        if (!userHasAccess) {
            logMessage("Error: Not connected to Google.", "error");
            return;
        }

        const text = messageInput ? messageInput.value.trim() : "";
        if (!text && !selectedFile) return;

        let payloadText = text;
        if (selectedFile) {
            payloadText += (payloadText ? "\n\n" : "") + "[Attachment selected in UI: " + selectedFile.name + "]";
        }

        logMessage("Sending message...", "info");
        sendButton.disabled = true;

        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/message", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: payloadText }),
            });

            if (!resp.ok) {
                logMessage("Failed to send message. Please try again.", "error");
                return;
            }

            logMessage("Message sent.", "success");
            if (messageInput) messageInput.value = "";
            clearSelectedFile();
        } catch (err) {
            logMessage("Error sending message. Please try again.", "error");
        } finally {
            updateSendButton();
        }
    }

    function handleFileSelect(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) {
            clearSelectedFile();
            return;
        }

        selectedFile = file;

        if (filePreview && previewImage) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImage.src = ev.target.result;
                filePreview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }

        updateSendButton();
    }

    function clearSelectedFile() {
        selectedFile = null;
        if (fileInput) fileInput.value = "";
        if (filePreview) filePreview.classList.add("hidden");
        updateSendButton();
    }

    function updateSendButton() {
        if (!sendButton) return;
        const canSend = (messageInput && messageInput.value.trim() !== "") || selectedFile !== null;
        sendButton.disabled = !canSend;
    }

    function logMessage(msg, type) {
        if (!messageLog) return;
        const entry = document.createElement("div");
        entry.className = "text-sm mb-1";

        if (type === "error") {
            entry.classList.add("text-red-500");
        } else if (type === "success") {
            entry.classList.add("text-green-500");
        } else {
            entry.classList.add("text-gray-600");
        }

        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = "[" + timestamp + "] " + msg;

        const placeholder = messageLog.querySelector(".text-gray-500");
        if (placeholder) placeholder.remove();

        messageLog.appendChild(entry);
        messageLog.scrollTop = messageLog.scrollHeight;
    }
})();
</script>
</body>
</html>
