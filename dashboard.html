<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIE Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google APIs & Identity Services -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
  .dark body { background-color: #111827; color: #f9fafb; }
  .disabled { opacity: 0.5; cursor: not-allowed; }
  .oauth-app-container .flex-grow-scroll { overflow-y:auto; flex-grow:1; }
  .dark .fc { color: #f9fafb; }
  .dark .fc .fc-button-primary { background-color:#374151; border-color:#4b5563; }
  .dark .fc .fc-button-primary:hover { background-color:#4b5563; }
  .dark .fc-daygrid-day.fc-day-today { background-color: rgba(96,165,250,0.2); }
</style>
</head>
<body>
<div class="oauth-app-container p-4 md:p-8">
  <div class="flex flex-col lg:flex-row gap-6 w-full">

    <!-- Calendar Section -->
    <section id="calendar-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col flex-1 min-h-[400px]">
      <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
        <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-center">Sign in to view your Google Calendar</h2>
        <div id="g_id_onload"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"></div>
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="dark"
             data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
      </div>

      <div id="calendar-content" class="hidden flex flex-col flex-grow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg md:text-xl lg:text-2xl font-semibold">Your Calendar</h2>
          <button id="signout_button"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors">
            Sign Out
          </button>
        </div>
        <div id="calendar-container" class="flex-grow"></div>
      </div>
    </section>

    <!-- Messaging Section -->
    <section id="messaging-section" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col flex-1 min-h-[400px] hidden">
      <h2 class="text-lg md:text-xl lg:text-2xl font-semibold mb-4">Send a Message</h2>
      <div id="message-log"
           class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg flex-grow-scroll mb-4 min-h-[100px]">
        <div class="text-sm text-gray-500 dark:text-gray-400">Your sent messages will appear here...</div>
      </div>
      <div class="flex flex-col space-y-4">
        <textarea id="message-input" placeholder="Type your message..."
          class="rounded-2xl border border-gray-300 dark:border-gray-600 focus:outline-none
                 focus:ring-2 focus:ring-blue-500 px-4 py-2 bg-white dark:bg-gray-900
                 text-gray-900 dark:text-white resize-y min-h-[80px]"></textarea>

        <div class="flex items-center space-x-2">
          <label for="file-input"
            class="cursor-pointer bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600
                   text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-full transition-colors">
            Add Image
          </label>
          <input id="file-input" type="file" class="hidden" accept="image/*">
        </div>

        <button id="send-button"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full shadow transition-colors disabled:bg-blue-300 dark:disabled:bg-blue-900 disabled"
          disabled>Send</button>
      </div>
    </section>

  </div>
</div>

<script>
(function() {
    const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
    const API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send';

    let tokenClient, calendar, userEmail = null;

    // --- DOM Elements ---
    const authArea = document.getElementById('auth-area');
    const calendarContent = document.getElementById('calendar-content');
    const calendarContainer = document.getElementById('calendar-container');
    const messagingSection = document.getElementById('messaging-section');
    const signoutButton = document.getElementById('signout_button');
    const sendButton = document.getElementById('send-button');
    const messageLog = document.getElementById('message-log');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');

    signoutButton.addEventListener('click', handleSignOut);
    sendButton.addEventListener('click', sendEmail);
    messageInput.addEventListener('input', toggleSendButton);
    fileInput.addEventListener('change', toggleSendButton);

    function toggleSendButton() {
        const hasText = messageInput.value.trim() !== '';
        const hasFile = fileInput.files.length > 0;
        const enable = hasText || hasFile;
        sendButton.disabled = !enable;
        sendButton.classList.toggle('disabled', !enable);
    }

    // --- GAPI Initialization ---
    function initializeGapiClient() {
        gapi.client.init({
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
                "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
            ],
        }).then(() => console.log("GAPI client initialized."))
          .catch(err => console.error("Error initializing GAPI client:", err));
    }
    gapi.load('client', initializeGapiClient);

    // --- JWT Decoder ---
    function parseJwt (token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
    }

    // --- Sign-in Handler ---
    window.handleCredentialResponse = (response) => {
        const userInfo = parseJwt(response.credential);
        userEmail = userInfo.email;
        console.log("Signed in as:", userEmail);

        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: API_SCOPES,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    handleAuthSuccess();
                } else {
                    console.error('Failed to get access token.', tokenResponse);
                }
            },
        });
        tokenClient.requestAccessToken();
    };

    // --- Core Application Logic ---
    function handleAuthSuccess() {
        updateUIForSignIn();
        displayMonthlyCalendar();
    }

    function handleSignOut() {
        const token = gapi.client.getToken();
        if (token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                console.log('Access token revoked.');
                gapi.client.setToken(null);
                updateUIForSignOut();
            });
        }
        updateUIForSignOut();
    }

    function displayMonthlyCalendar() {
        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: 'dayGridMonth',
            headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
            events: async (fetchInfo, successCallback, failureCallback) => {
                try {
                    const calendarListResponse = await gapi.client.calendar.calendarList.list();
                    const calendars = calendarListResponse.result.items;
                    const eventPromises = calendars.map(cal =>
                        gapi.client.calendar.events.list({
                            'calendarId': cal.id,
                            'timeMin': fetchInfo.start.toISOString(),
                            'timeMax': fetchInfo.end.toISOString(),
                            'showDeleted': false,
                            'singleEvents': true,
                        }).then(response =>
                            response.result.items.map(event => ({ ...event, color: cal.backgroundColor }))
                        )
                    );
                    const allEventArrays = await Promise.all(eventPromises);
                    const allEvents = allEventArrays.flat().map(event => ({
                        title: event.summary,
                        start: event.start.dateTime || event.start.date,
                        end: event.end.dateTime || event.end.date,
                        url: event.htmlLink,
                        allDay: !event.start.dateTime,
                        backgroundColor: event.color,
                        borderColor: event.color
                    }));
                    successCallback(allEvents);
                } catch (err) {
                    console.error('Error fetching calendar data:', err);
                    failureCallback(err);
                }
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                if (info.event.url) window.open(info.event.url, "_blank");
            }
        });
        calendar.render();
    }

    async function sendEmail() {
        const messageText = messageInput.value;
        const file = fileInput.files[0];
        const boundary = "boundary_" + Math.random().toString(36).substring(2,15);
        const subject = `Message received from ${userEmail || "unknown@mie.today"}`;

        let email = "";
        if (file) {
            const base64File = await fileToBase64(file);
            email =
                `To: save@mie.today\r\n` +
                `From: me\r\n` +
                `Subject: ${subject}\r\n` +
                `MIME-Version: 1.0\r\n` +
                `Content-Type: multipart/mixed; boundary="${boundary}"\r\n\r\n` +

                `--${boundary}\r\n` +
                `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
                `${messageText}\r\n\r\n` +

                `--${boundary}\r\n` +
                `Content-Type: ${file.type}; name="${file.name}"\r\n` +
                `Content-Disposition: attachment; filename="${file.name}"\r\n` +
                `Content-Transfer-Encoding: base64\r\n\r\n` +
                `${base64File}\r\n\r\n` +

                `--${boundary}--`;
        } else {
            email =
                `To: save@mie.today\r\n` +
                `From: me\r\n` +
                `Subject: ${subject}\r\n` +
                `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
                `${messageText}`;
        }

        const base64EncodedEmail = btoa(unescape(encodeURIComponent(email)))
            .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

        logMessage("Sending email...", "info");
        sendButton.disabled = true;
        sendButton.classList.add('disabled');

        try {
            await gapi.client.gmail.users.messages.send({ userId: 'me', resource: { raw: base64EncodedEmail } });
            logMessage("Email sent successfully!", "success");
            messageInput.value = "";
            fileInput.value = "";
            toggleSendButton();
        } catch (err) {
            console.error("Failed to send email:", err);
            logMessage(`Failed to send email: ${err.result?.error?.message || 'Unknown error'}.`, "error");
            sendButton.disabled = false;
            sendButton.classList.remove('disabled');
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // --- UI Utilities ---
    function updateUIForSignIn() {
        authArea.classList.add('hidden');
        calendarContent.classList.remove('hidden');
        messagingSection.classList.remove('hidden');
    }
    function updateUIForSignOut() {
        authArea.classList.remove('hidden');
        calendarContent.classList.add('hidden');
        messagingSection.classList.add('hidden');
        calendarContainer.innerHTML = '';
        messageLog.innerHTML = `<div class="text-sm text-gray-500 dark:text-gray-400">Your sent messages will appear here...</div>`;
        messageInput.value = "";
        fileInput.value = "";
    }
    function logMessage(text, type = 'info') {
        if (messageLog.children.length === 1 && messageLog.firstChild.textContent.startsWith('Your sent messages')) {
            messageLog.innerHTML = '';
        }
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        const colors = { success: 'text-green-500', error: 'text-red-500', info: 'text-gray-900 dark:text-gray-200' };
        p.className = `text-sm mb-1 ${colors[type]}`;
        messageLog.appendChild(p);
        messageLog.scrollTop = messageLog.scrollHeight;
    }

    updateUIForSignOut();
})();
</script>
</body>
</html>
