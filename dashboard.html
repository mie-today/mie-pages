<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIE Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body { font-family:'Inter',sans-serif; margin:0; background:#f3f4f6; color:#1f2937; height:100vh; display:flex; justify-content:center; }
.oauth-app-container { width:100%; max-width:1200px; padding:1rem; box-sizing:border-box; display:flex; flex-direction:column; gap:1rem; height:100%; }
section { background:white; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.08); padding:1rem; display:flex; flex-direction:column; overflow:hidden; }
#calendar-container { flex:1 1 auto; min-height:300px; }
#message-log { max-height:180px; overflow-y:auto; background:#f9fafb; padding:0.5rem; border-radius:8px; }
#message-input { border-radius:8px; border:1px solid #d1d5db; padding:0.5rem; min-height:80px; resize:vertical; }
#send-button { margin-top:0.5rem; }
#file-preview { margin-top:0.5rem; max-height:120px; object-fit:contain; border-radius:8px; }
.disabled { opacity:.5; cursor:not-allowed; }
</style>
</head>
<body>
<div class="oauth-app-container">

  <!-- Calendar Section -->
  <section id="calendar-section">
    <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
      <h2 class="text-lg font-semibold text-center">Sign in to view your Google Calendar</h2>
      <div id="g_id_onload"
           data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
           data-context="signin"
           data-ux_mode="popup"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false"></div>
      <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="dark" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
    </div>

    <div id="calendar-content" class="hidden flex flex-col flex-1">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-semibold">Your Calendar</h2>
        <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Sign Out</button>
      </div>
      <div id="calendar-container"></div>
    </div>
  </section>

  <!-- Messaging Section -->
  <section id="messaging-section" class="hidden">
    <h2 class="text-lg font-semibold mb-2">Send a Message</h2>
    <div id="message-log"><div class="text-sm text-gray-500">Your sent messages will appear here...</div></div>

    <textarea id="message-input" placeholder="Type your message..."></textarea>

    <div class="flex items-center gap-2 mt-2">
      <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-full font-bold">Add Image</label>
      <input id="file-input" type="file" accept="image/*" class="hidden">
    </div>
    <img id="file-preview" class="hidden">

    <button id="send-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded disabled" disabled>Send</button>
  </section>

</div>

<script>
(function(){
  const CLIENT_ID="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
  const API_SCOPES="https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send";
  let tokenClient=null, calendar=null, userEmail=null;

  // DOM
  const authArea=document.getElementById('auth-area');
  const calendarContent=document.getElementById('calendar-content');
  const calendarContainer=document.getElementById('calendar-container');
  const messagingSection=document.getElementById('messaging-section');
  const signoutButton=document.getElementById('signout_button');
  const sendButton=document.getElementById('send-button');
  const messageLog=document.getElementById('message-log');
  const messageInput=document.getElementById('message-input');
  const fileInput=document.getElementById('file-input');
  const filePreview=document.getElementById('file-preview');

  signoutButton.addEventListener('click', handleSignOut);
  sendButton.addEventListener('click', sendEmail);
  messageInput.addEventListener('input', toggleSendButton);
  fileInput.addEventListener('change', handleFileChange);

  function toggleSendButton(){
    const hasText=messageInput.value.trim()!=="";
    const hasFile=fileInput.files && fileInput.files.length>0;
    sendButton.disabled=!(hasText||hasFile);
    sendButton.classList.toggle('disabled',!(hasText||hasFile));
  }

  function handleFileChange(){
    toggleSendButton();
    if(fileInput.files.length>0){
      const reader=new FileReader();
      reader.onload=e=>{
        filePreview.src=e.target.result;
        filePreview.classList.remove('hidden');
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else {
      filePreview.src="";
      filePreview.classList.add('hidden');
    }
  }

  let gapiInitResolve;
  const gapiInitPromise=new Promise(resolve=>{gapiInitResolve=resolve;});
  function initializeGapiClient(){
    gapi.client.init({
      discoveryDocs:[
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
      ]
    }).then(()=>gapiInitResolve()).catch(()=>gapiInitResolve());
  }
  gapi.load('client', initializeGapiClient);

  function parseJwt(token){
    try{
      const base64Url=token.split('.')[1];
      const base64=base64Url.replace(/-/g,'+').replace(/_/g,'/');
      return JSON.parse(decodeURIComponent(atob(base64).split('').map(c=>`%${('00'+c.charCodeAt(0).toString(16)).slice(-2)}`).join('')));
    }catch(e){return {};}
  }

  window.handleCredentialResponse=(response)=>{
    if(!response||!response.credential){console.error("No credential");return;}
    const info=parseJwt(response.credential);
    if(info.email) userEmail=info.email;
    tokenClient=google.accounts.oauth2.initTokenClient({
      client_id:CLIENT_ID,
      scope:API_SCOPES,
      callback:async(tokenResponse)=>{
        if(!tokenResponse||!tokenResponse.access_token){console.error("Token failed");return;}
        gapi.client.setToken(tokenResponse);
        await gapiInitPromise;
        await fetchUserEmail();
        handleAuthSuccess();
      }
    });
    tokenClient.requestAccessToken({prompt:'consent'});
  };

  async function fetchUserEmail(){
    if(userEmail) return userEmail;
    try{
      const resp=await gapi.client.gmail.users.getProfile({userId:'me'});
      userEmail=resp.result.emailAddress||userEmail;
    }catch(e){console.warn("Could not fetch email via Gmail API");}
    return userEmail;
  }

  function handleAuthSuccess(){
    authArea.classList.add('hidden');
    calendarContent.classList.remove('hidden');
    messagingSection.classList.remove('hidden');
    renderCalendar();
  }

  function handleSignOut(){
    const tok=gapi.client.getToken();
    if(tok&&tok.access_token){
      google.accounts.oauth2.revoke(tok.access_token,()=>{ gapi.client.setToken(null); resetUI(); });
    } else resetUI();
  }

  function resetUI(){
    authArea.classList.remove('hidden');
    calendarContent.classList.add('hidden');
    messagingSection.classList.add('hidden');
    if(calendar){calendar.destroy(); calendar=null;}
    messageLog.innerHTML=`<div class="text-sm text-gray-500">Your sent messages will appear here...</div>`;
    messageInput.value="";
    fileInput.value="";
    filePreview.src="";
    filePreview.classList.add('hidden');
    toggleSendButton();
  }

  function renderCalendar(){
    if(calendar) calendar.destroy();
    calendar=new FullCalendar.Calendar(calendarContainer,{
      initialView:'dayGridMonth',
      headerToolbar:{left:'
