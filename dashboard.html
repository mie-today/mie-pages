<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MIE Dashboard</title>

<!-- Tailwind (optional) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google APIs & Identity Services -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  /* Minimal styles kept from your version */
  body { font-family: 'Inter', sans-serif; background:#f3f4f6; color:#1f2937; margin:0; height:100vh; }
  .oauth-app-container { width:100%; max-width:1400px; margin:0 auto; padding:1rem; box-sizing:border-box; height:100%; }
  .flex-col-lg-row { display:flex; flex-direction:column; gap:1rem; height:100%; }
  @media(min-width:1280px){ .flex-col-lg-row { flex-direction:row; } }
  section { background:white; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.08); padding:1.25rem; display:flex; flex-direction:column; flex:1 1 0; min-height:320px; overflow:hidden; }
  #calendar-container { flex-grow:1; min-height:240px; }
  #message-log { max-height:220px; overflow-y:auto; }
  .disabled { opacity:.5; cursor:not-allowed; }
  /* Dark theme tweaks omitted for brevity (keep your original dark styles if needed) */
</style>
</head>
<body>
<div class="oauth-app-container">
  <div class="flex-col-lg-row">

    <!-- Calendar -->
    <section id="calendar-section">
      <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
        <h2 class="text-lg font-semibold text-center">Sign in to view your Google Calendar</h2>
        <div id="g_id_onload"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"></div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="dark"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left"></div>
      </div>

      <div id="calendar-content" class="hidden flex flex-col flex-grow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Your Calendar</h2>
          <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Sign Out</button>
        </div>
        <div id="calendar-container" class="flex-grow"></div>
      </div>
    </section>

    <!-- Messaging -->
    <section id="messaging-section" class="hidden">
      <h2 class="text-lg font-semibold mb-4">Send a Message</h2>
      <div id="message-log" class="bg-gray-50 p-3 rounded mb-4 min-h-[100px]">
        <div class="text-sm text-gray-500">Your sent messages will appear here...</div>
      </div>

      <textarea id="message-input" placeholder="Type your message..." class="rounded border px-3 py-2 min-h-[80px]"></textarea>

      <div class="flex items-center gap-2 mt-2">
        <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-full font-bold">Add Image</label>
        <input id="file-input" type="file" accept="image/*" class="hidden">
      </div>

      <button id="send-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full mt-4 disabled" disabled>Send</button>
    </section>

  </div>
</div>

<script>
/*
  Developer-mode audit & fixes applied:
  - ID token (JWT) parsing -> immediate userEmail set
  - gapi.client.init completion tracked with a Promise (gapiInitPromise)
  - tokenClient callback awaits gapiInitPromise (avoids race)
  - fetchUserEmail() best-effort fallback (non-fatal)
  - sendEmail() uses subject from userEmail || fallback; supports attachments; does not abort on missing email
*/

(function(){
  const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
  const API_SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send";

  let tokenClient = null;
  let calendar = null;
  let userEmail = null;

  // DOM
  const authArea = document.getElementById('auth-area');
  const calendarContent = document.getElementById('calendar-content');
  const calendarContainer = document.getElementById('calendar-container');
  const messagingSection = document.getElementById('messaging-section');
  const signoutButton = document.getElementById('signout_button');
  const sendButton = document.getElementById('send-button');
  const messageLog = document.getElementById('message-log');
  const messageInput = document.getElementById('message-input');
  const fileInput = document.getElementById('file-input');

  signoutButton.addEventListener('click', handleSignOut);
  sendButton.addEventListener('click', sendEmail);
  messageInput.addEventListener('input', toggleSendButton);
  fileInput.addEventListener('change', toggleSendButton);

  function toggleSendButton(){
    const hasText = messageInput.value.trim() !== "";
    const hasFile = fileInput.files && fileInput.files.length > 0;
    const enable = hasText || hasFile;
    sendButton.disabled = !enable;
    sendButton.classList.toggle('disabled', !enable);
  }

  // --- GAPI init flow with promise to avoid races ---
  let gapiInitResolve;
  const gapiInitPromise = new Promise((resolve) => { gapiInitResolve = resolve; });

  function initializeGapiClient(){
    gapi.client.init({
      discoveryDocs:[
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
      ]
    }).then(() => {
      console.log("GAPI client initialized.");
      gapiInitResolve();
    }).catch(err => {
      console.error("GAPI init error:", err);
      gapiInitResolve(); // resolve anyway so auth flow proceeds (we'll fail gracefully later)
    });
  }
  gapi.load('client', initializeGapiClient);

  // --- JWT decoder (ID token contains user's email) ---
  function parseJwt(token){
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c=>{
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch(e){
      console.warn("parseJwt failed", e);
      return {};
    }
  }

  // --- Handle the ID token returned by g_id_onload -->
  window.handleCredentialResponse = (response) => {
    if(!response || !response.credential){
      console.error('No credential present in handleCredentialResponse.');
      return;
    }

    // Decode JWT for quick email access
    const info = parseJwt(response.credential);
    if(info && info.email){
      userEmail = info.email;
      console.log("Signed in (from id_token):", userEmail);
    } else {
      console.log("ID token parsed but no email present.");
    }

    // Initialize token client and request access token
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: API_SCOPES,
      callback: async (tokenResponse) => {
        if(!tokenResponse || !tokenResponse.access_token){
          console.error("tokenClient callback failed:", tokenResponse);
          return;
        }
        console.log("Access token received.");
        gapi.client.setToken(tokenResponse);
        // ensure gapi client is initialized before proceeding (avoid race)
        await gapiInitPromise;
        // try to fetch canonical email via Gmail API as a best-effort (non-fatal)
        await fetchUserEmail().catch(err => console.warn('fetchUserEmail failed (non-fatal):', err));
        handleAuthSuccess();
      }
    });

    // This triggers the popup. Keep this call direct inside a user gesture.
    tokenClient.requestAccessToken({prompt: 'consent'}); // explicit consent ensures scopes granted
  };

  // Best-effort fetch of user's email via Gmail API if JWT missed it
  async function fetchUserEmail(){
    if(userEmail) return userEmail;
    try {
      const resp = await gapi.client.gmail.users.getProfile({ userId: 'me' });
      const emailAddr = resp.result && resp.result.emailAddress;
      if(emailAddr){
        userEmail = emailAddr;
        console.log("Fetched user email from Gmail API:", userEmail);
      }
      return userEmail;
    } catch (err){
      console.warn("Could not fetch profile via Gmail API (non-fatal).", err);
      return null;
    }
  }

  function handleAuthSuccess(){
    updateUIForSignIn();
    displayMonthlyCalendar();
  }

  function handleSignOut(){
    const tok = gapi.client.getToken();
    if(tok && tok.access_token){
      google.accounts.oauth2.revoke(tok.access_token, () => {
        console.log('Token revoked.');
        gapi.client.setToken(null);
        updateUIForSignOut();
      });
    } else {
      updateUIForSignOut();
    }
  }

  async function displayMonthlyCalendar(){
    if(calendar) calendar.destroy();

    calendar = new FullCalendar.Calendar(calendarContainer, {
      initialView: 'dayGridMonth',
      headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
      events: async (fetchInfo, successCallback, failureCallback) => {
        try {
          const listResp = await gapi.client.calendar.calendarList.list();
          const calendars = listResp.result.items || [];
          console.log("Calendars found:", calendars);

          const promises = calendars.map(cal => gapi.client.calendar.events.list({
            calendarId: cal.id,
            timeMin: fetchInfo.start.toISOString(),
            timeMax: fetchInfo.end.toISOString(),
            showDeleted: false,
            singleEvents: true,
          }).then(r => (r.result.items || []).map(ev => ({...ev, color: cal.backgroundColor || '#3788d8'}))));

          const allArrays = await Promise.all(promises);
          const allEvents = allArrays.flat().map(ev => ({
            title: ev.summary || "(No Title)",
            start: ev.start.dateTime || ev.start.date,
            end: ev.end && (ev.end.dateTime || ev.end.date),
            url: ev.htmlLink,
            allDay: !ev.start.dateTime,
            backgroundColor: ev.color,
            borderColor: ev.color
          }));
          successCallback(allEvents);
        } catch (err) {
          console.error("Calendar fetch error:", err);
          failureCallback(err);
        }
      },
      eventClick: function(info){
        info.jsEvent.preventDefault();
        if(info.event.url) window.open(info.event.url, "_blank");
      }
    });

    calendar.render();
  }

  // build and send email. supports single attachment
  async function sendEmail(){
    const text = messageInput.value || "";
    const file = fileInput.files && fileInput.files[0];
    const subject = `Message received from ${userEmail || "unknown@mie.today"}`;

    // Build MIME message
    let mimeParts = "";
    if(file){
      // prepare multipart/mixed with one attachment
      const boundary = "====boundary_" + Math.random().toString(36).slice(2,12);
      const fileBase64 = await fileToBase64(file); // standard base64

      mimeParts =
        `To: save@mie.today\r\n` +
        `From: me\r\n` +
        `Subject: ${subject}\r\n` +
        `MIME-Version: 1.0\r\n` +
        `Content-Type: multipart/mixed; boundary="${boundary}"\r\n\r\n` +

        `--${boundary}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${text}\r\n\r\n` +

        `--${boundary}\r\n` +
        `Content-Type: ${file.type || 'application/octet-stream'}; name="${file.name}"\r\n` +
        `Content-Disposition: attachment; filename="${file.name}"\r\n` +
        `Content-Transfer-Encoding: base64\r\n\r\n` +
        `${fileBase64}\r\n\r\n` +

        `--${boundary}--`;
    } else {
      mimeParts =
        `To: save@mie.today\r\n` +
        `From: me\r\n` +
        `Subject: ${subject}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${text}`;
    }

    // encode whole MIME as base64url as required by Gmail API
    const encoded = btoa(unescape(encodeURIComponent(mimeParts))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

    logMessage("Sending email...", "info");
    sendButton.disabled = true;
    sendButton.classList.add('disabled');

    try {
      await gapi.client.gmail.users.messages.send({ userId: 'me', resource: { raw: encoded } });
      logMessage("Email sent successfully!", "success");
      messageInput.value = "";
      fileInput.value = "";
      toggleSendButton();
    } catch (err) {
      console.error("Send email failed:", err);
      logMessage(`Failed to send email: ${err.result?.error?.message || err.message || 'Unknown error'}`, "error");
      sendButton.disabled = false;
      sendButton.classList.remove('disabled');
    }
  }

  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        // reader.result is "data:<mime>;base64,AAAA..."
        const parts = (reader.result || "").split(',');
        resolve(parts[1] || "");
      };
      reader.onerror = (e) => reject(e);
      reader.readAsDataURL(file);
    });
  }

  // UI helpers
  function updateUIForSignIn(){
    authArea.classList.add('hidden');
    calendarContent.classList.remove('hidden');
    messagingSection.classList.remove('hidden');
  }
  function updateUIForSignOut(){
    authArea.classList.remove('hidden');
    calendarContent.classList.add('hidden');
    messagingSection.classList.add('hidden');
    if(calendar) { calendar.destroy(); calendar = null; }
    messageLog.innerHTML = `<div class="text-sm text-gray-500">Your sent messages will appear here...</div>`;
    messageInput.value = "";
    fileInput.value = "";
    toggleSendButton();
  }

  function logMessage(text, type='info'){
    const p = document.createElement('div');
    p.className = "text-sm mb-1 " + (type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-gray-900');
    p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
    // remove placeholder if present
    if(messageLog.children.length === 1 && messageLog.firstChild.textContent.includes('Your sent messages')) messageLog.innerHTML = '';
    messageLog.appendChild(p);
    messageLog.scrollTop = messageLog.scrollHeight;
  }

  // initial state
  updateUIForSignOut();

})();
</script>
</body>
</html>
