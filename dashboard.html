<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard v2.5 - Mobile Fixed</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google API Client Library (no longer used for auth; safe to keep) -->
<script src="https://apis.google.com/js/api.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400&family=Montserrat:wght@600&display=swap"
  rel="stylesheet"
/>

<style>
    /* --- General Body and Layout --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Custom font classes */
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-lato { font-family: 'Lato', sans-serif; }

    /* --- Scrollbar Styling --- */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    /* Utility class for disabled elements */
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main container for the entire application */
    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* --- Responsive Styles for Mobile (up to 480px wide) --- */
    @media (max-width: 480px) {
        .oauth-app-container {
            width: 100% !important;
        }
        .mobile-container {
            padding: 4px !important;
            gap: 4px !important;
        }
        .calendar-section, .messaging-section {
            width: 100% !important;
            height: auto !important;
            padding: 8px !important;
        }
        .mobile-heading { font-size: 20px !important; line-height: 1.2 !important; }
        .mobile-text { font-size: 14px !important; line-height: 1.1 !important; }
        .mobile-small-btn { padding: 4px 8px !important; font-size: 12px !important; }
        .mobile-text-btn { font-size: 16px !important; }
        .mobile-textarea { height: 60px !important; padding: 4px 8px !important; }

        /* 
         * ========================================
         * MOBILE-SPECIFIC: Custom toolbar layout
         * Make it a single row with month centered, controls right
         * ========================================
         */
        
        /* Override FullCalendar's default toolbar flex layout */
        .fc .fc-header-toolbar {
            margin-bottom: 1em !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            gap: 10px !important;
        }
        
        /* Center the title and make it full width on its own line */
        .fc .fc-toolbar-chunk:nth-child(1),
        .fc .fc-toolbar-chunk:nth-child(2),
        .fc .fc-toolbar-chunk:nth-child(3) {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        
        /* Make the toolbar a single-row layout */
        .fc .fc-header-toolbar {
            display: grid !important;
            grid-template-columns: auto 1fr auto !important;
            gap: 10px !important;
            align-items: center !important;
        }
        
        /* First chunk (empty or hidden today button) - keep minimal */
        .fc .fc-toolbar-chunk:nth-child(1) {
            justify-self: start !important;
        }
        
        /* Second chunk (title) - center it */
        .fc .fc-toolbar-chunk:nth-child(2) {
            justify-self: center !important;
        }
        
        /* Third chunk (prev, next, view switcher) - align right */
        .fc .fc-toolbar-chunk:nth-child(3) {
            justify-self: end !important;
            display: flex !important;
            gap: 6px !important;
        }
        
        /* Hide desktop "today" button on mobile */
        .fc .fc-today-button {
            display: none !important;
        }
        
        /* Month title styling for mobile - larger and bold */
        .fc .fc-toolbar-title { 
            font-size: 20px !important; 
            line-height: 1.2 !important;
            font-weight: 700 !important;
            text-align: center !important;
            margin: 0 !important;
            color: #1f2937 !important;
        }
        
        /* Arrow buttons for mobile - bigger for touch */
        .fc .fc-button-primary { 
            font-size: 16px !important; 
            padding: 8px 12px !important; 
            line-height: 1 !important;
            min-width: 44px !important;
            height: 44px !important;
            border-radius: 8px !important;
        }
        
        /* Dropdown for mobile - bigger for touch */
        .view-switcher {
            display: inline-flex !important;
            align-items: center !important;
        }
        
        .view-switcher select {
            font-size: 16px !important;
            padding: 8px 32px 8px 12px !important;
            min-height: 44px !important;
            border-radius: 8px !important;
        }

        /* Calendar grid adjustments for mobile */
        .fc .fc-col-header-cell { 
            font-size: 11px !important;
            padding: 4px 2px !important;
        }
        
        .fc .fc-daygrid-day-number { 
            font-size: 13px !important;
            padding: 2px !important;
        }
        
        /* Smaller day cells for mobile */
        .fc .fc-daygrid-day-frame {
            min-height: 80px !important;
        }

        .fc .fc-event { 
            font-size: 9px !important;
            padding: 1px 2px !important;
        }
        
        /* Make "more" indicator smaller on mobile */
        .mie-more-events {
            font-size: 9px !important;
            padding: 2px 4px !important;
        }
    }

    /* --- Responsive Styles for Tablet (481px to 768px) --- */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 720px; }  /* a bit taller to avoid scroll */
        .messaging-section { width: 481px; height: 316px; }
    }

    /* --- Responsive Styles for Desktop (769px and wider) --- */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 820px; }  /* tuned so no right scrollbar */
        .messaging-section { width: 800px; height: 360px; }
    }

    /* --- FullCalendar Light Mode Customization --- */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }
    
    /* 
     * ========================================
     * UPDATED: Today's date with blue circle indicator
     * ========================================
     */
    .fc-daygrid-day.fc-day-today { background-color: transparent !important; }
    .fc-daygrid-day.fc-day-today .fc-daygrid-day-number {
      background-color: #3b82f6 !important;
      color: white !important;
      border-radius: 50% !important;
      width: 28px !important;
      height: 28px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: 600 !important;
    }
    
    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }

    /* 
     * ========================================
     * NEW: Custom view dropdown styling
     * ========================================
     */
    .view-switcher {
      position: relative;
      display: inline-block;
    }
    
    /* Hide the placeholder button that creates the blue line */
    .fc-customViewSwitcher-button {
      display: none !important;
    }
    
    .view-switcher select {
      appearance: none;
      background-color: #3b82f6;
      color: white;
      border: 1px solid #2563eb;
      border-radius: 6px;
      padding: 4px 32px 4px 12px;
      font-size: 10px;  /* * <- CHANGE THIS to adjust Daily/Weekly/Monthly dropdown size */
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .view-switcher select:hover {
      background-color: #2563eb;
    }
    
    .view-switcher::after {
      content: '‚ñº';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: white;
      font-size: 12px;
    }

    /* Hide FullCalendar's built-in dot so we only show our custom one */
    .fc-daygrid-event-dot { display: none !important; }

    /* Let JS handle background/border per calendar, but force text to black */
    .fc .fc-event {
      border-color: transparent;
      background-color: transparent;
      color: #000000 !important;
      font-size: 12px;          /* * <- EVENT FONT SIZE (DESKTOP/TABLET). Change this as needed. */
      line-height: 1.2;
    }

    /* Force ALL event text to stay inside the day cell (no spillover) */
    .fc-daygrid-event-harness,
    .fc-daygrid-event,
    .fc-daygrid-event .fc-event-main,
    .fc-daygrid-event .fc-event-title,
    .fc-daygrid-event .fc-event-title-container,
    .fc-daygrid-event .fc-event-main-frame {
      max-width: 100% !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      box-sizing: border-box !important;
    }

    /* Also force inner text wrappers to black, to override any defaults */
    .fc .fc-event .fc-event-main,
    .fc .fc-event .fc-event-title {
      color: #000000 !important;
    }

    .fc .fc-toolbar-title {
      color: #1f2937 !important;
      font-size: 19px !important;  /* 1px larger per your request */
      line-height: 1.2 !important;
      font-weight: 600;
    }

    /* Make Today + arrows match title height */
    .fc .fc-toolbar .fc-button {
      font-size: 10px !important;     /* * <- CHANGE THIS to adjust Today/Arrow button size */
      line-height: 1.2 !important;
      padding: 2px 8px !important;    /* tighter button */
      height: auto !important;
      border-radius: 6px !important;
    }

    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* Bullet dot in timed events */
    .mie-event-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 9999px;
      margin-right: 4px;
      flex-shrink: 0;
    }

    /* 
     * ========================================
     * NEW: "+ X more events" indicator styling
     * ========================================
     */
    .mie-more-events {
      display: block;
      padding: 2px 6px;
      margin-top: 2px;
      font-size: 11px;
      font-weight: 600;
      color: #3b82f6;
      background-color: #eff6ff;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .mie-more-events:hover {
      background-color: #dbeafe;
      color: #2563eb;
    }

    /* --- Event Modal Styling --- */
    .event-modal { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.5); 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      z-index: 1000; 
    }
    
    .event-modal-content { 
      background: white; 
      border-radius: 12px; 
      padding: 24px; 
      max-width: 400px; 
      width: 90%; 
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
      color: #1f2937; 
    }
    
    @media (max-width: 480px){ 
      .event-modal-content { 
        max-width: 320px !important; 
        padding: 16px !important; 
      } 
    }

    /* 
     * ========================================
     * NEW: Day Events Modal Styling
     * This modal shows all events for a specific day when clicking "+ X more"
     * ========================================
     */
    .day-events-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }

    .day-events-modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      color: #1f2937;
    }

    /* Scrollbar styling for day events modal */
    .day-events-modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .day-events-modal-content::-webkit-scrollbar-track {
      background-color: #f3f4f6;
      border-radius: 9999px;
    }

    .day-events-modal-content::-webkit-scrollbar-thumb {
      background-color: #9ca3af;
      border-radius: 9999px;
    }

    .day-events-modal-content::-webkit-scrollbar-thumb:hover {
      background-color: #6b7280;
    }

    /* Event item in the day modal */
    .day-event-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid #3b82f6;
      background-color: #f9fafb;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .day-event-item:hover {
      background-color: #f3f4f6;
      transform: translateX(2px);
    }

    .day-event-time {
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .day-event-title {
      color: #1f2937;
      font-size: 14px;
      font-weight: 500;
    }

    .day-event-location {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .day-events-modal-content {
        max-width: 340px !important;
        padding: 16px !important;
      }

      .day-event-item {
        padding: 10px !important;
      }

      .day-event-time {
        font-size: 12px !important;
      }

      .day-event-title {
        font-size: 13px !important;
      }
    }

    /* --- Access Denied Styling --- */
    .access-denied { color: #dc2626; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px; }
</style>
</head>

<body class="bg-white">

<!-- Main App Container -->
<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <!-- ===== Calendar Section ===== -->
        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">

            <!-- Authentication Area (signed out / pre-consent) -->
            <div id="auth-area" class="flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />

                <h1 class="font-montserrat text-2xl font-semibold text-gray-800" style="font-size: 18pt;">Mie</h1>
                <p class="font-lato text-base text-gray-600 mt-1 mb-6" style="font-size: 12pt;">Remember your life</p>

                <!-- Connect CTA -->
                <button
                    id="connect-google-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full px-5 py-2 text-sm flex items-center shadow"
                    style="min-width:200px; justify-content:center;"
                >
                    Connect Google
                </button>

                <div class="mt-6 text-sm text-gray-500">
                    or
                    <a href="signup.html"
                       class="font-semibold text-green-600 hover:text-green-700 hover:underline">
                    Create an account
                    </a>
                </div>
            </div>

            <!-- Access Verification Area -->
            <div id="access-check-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-gray-800 mb-4">Verifying Access...</h2>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-4">Checking if youryour account has access to Mie dashboard</p>
            </div>

            <!-- Access Denied Area -->
            <div id="access-denied-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img
                    src="https://raw.githubusercontent.com/mie-today/mie-pages/refs/heads/main/logo_white_70x70.png"
                    alt="Mie Logo"
                    class="rounded-full mb-4"
                />
                <h2 class="font-montserrat text-xl font-semibold text-red-600 mb-4">Access Denied</h2>
                <div class="access-denied text-center max-w-md">
                    <p class="mb-3">Your Gmail account doesn't have access to the Mie dashboard.</p>
                    <p class="mb-4">To get access, please sign up with the correct PIN code.</p>
                    <div class="space-y-3">
                        <a href="signup.html" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Sign Up for Access</a>
                        <br />
                        <button id="try-different-account" class="text-blue-600 hover:text-blue-700 underline text-sm">
                            Try a Different Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (signed in + approved) -->
            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-between items-center mb-2">
                    <span id="welcome-message" class="text-sm text-gray-600"></span>
                </div>
                <div id="calendar-container" class="flex-1 min-h-0 mt-1"></div>
            </div>
        </div>

        <!-- ===== Messaging Section ===== -->
        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 mobile-heading">Send a Message</h2>

            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2">
                <div class="text-sm mobile-text text-gray-500">Your sent messages will appear here...</div>
            </div>

            <textarea
                id="message-input"
                placeholder="Type your message..."
                class="rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"
            ></textarea>

            <div class="flex items-center space-x-2 mt-2">
                <label
                    for="file-input"
                    class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-sm py-1 px-3 rounded-full mobile-text"
                >
                    Attachment
                </label>
                <input id="file-input" type="file" class="hidden" accept="image/*" />
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-12 h-12 object-cover rounded border" alt="Preview" />
                    <button id="remove-file" class="text-red-500 text-sm mobile-text">Remove</button>
                </div>
            </div>

            <button
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2 mobile-text-btn"
                disabled
            >
                Send
            </button>

            <!-- Sign Out bottom-right with spacing -->
            <div class="mt-6 flex justify-end">
                <button
                    id="signout_button"
                    class="text-gray-500 text-xs font-semibold mobile-small-btn py-1 px-2 rounded-md"
                >
                    Sign Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Event Details Modal ===== -->
<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl font-semibold mobile-heading"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text"></p>
            <p id="event-description" class="text-gray-700 mobile-text"></p>
            <p id="event-location" class="text-gray-600 mobile-text"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a
                id="event-link"
                target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-btn"
            >
                Open in Google Calendar
            </a>
        </div>
    </div>
</div>

<!-- 
  ========================================
  NEW: Day Events Modal
  Shows all events for a specific day when user clicks "+ X more events"
  ========================================
-->
<div id="day-events-modal" class="day-events-modal hidden">
    <div class="day-events-modal-content">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 id="day-events-title" class="text-xl font-semibold mobile-heading text-gray-800"></h3>
                <p id="day-events-subtitle" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button id="close-day-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="day-events-list" class="space-y-2">
            <!-- Events will be dynamically inserted here -->
        </div>
    </div>
</div>

<script>
(function () {
    // ========================================
    // VERSION & DEBUG INFO
    // ========================================
    const VERSION = "2.5.0-MOBILE-FIXED";
    console.log("==========================================");
    console.log("üöÄ DASHBOARD VERSION:", VERSION);
    console.log("‚úÖ Event limiting feature ACTIVE (Monthly only)");
    console.log("üîÑ View switcher: Daily/Weekly/Monthly");
    console.log("üîµ Today indicator: Blue circle");
    console.log("üìè Font size: 10px (buttons & dropdown)");
    console.log("üì± Mobile optimized");
    console.log("==========================================");
    
    // ======== CONFIG =========
    const BACKEND_BASE_URL = "https://api.mie.today";
    
    // Detect if mobile (screen width <= 480px)
    const isMobile = window.innerWidth <= 480;
    const MAX_VISIBLE_EVENTS = isMobile ? 3 : 5; // 3 for mobile, 5 for desktop
    
    console.log(`üì± Device: ${isMobile ? 'Mobile' : 'Desktop'}`);
    console.log(`üìÖ Max visible events: ${MAX_VISIBLE_EVENTS}`);

    // ======== STATE =========
    let calendar = null;
    let selectedFile = null;
    let userEmail = null;
    let userHasAccess = false;
    let eventsByDate = {}; // Store all events by date for modal

    // ======== DOM HOOKS =========
    const authArea = document.getElementById("auth-area");
    const accessCheckArea = document.getElementById("access-check-area");
    const accessDeniedArea = document.getElementById("access-denied-area");
    const calendarContent = document.getElementById("calendar-content");
    const calendarContainer = document.getElementById("calendar-container");
    const messagingSection = document.getElementById("messaging-section");
    const welcomeMessage = document.getElementById("welcome-message");
    const signoutButton = document.getElementById("signout_button");
    const tryDifferentAccountBtn = document.getElementById("try-different-account");
    const connectGoogleBtn = document.getElementById("connect-google-btn");

    const sendButton = document.getElementById("send-button");
    const messageLog = document.getElementById("message-log");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const removeFileButton = document.getElementById("remove-file");

    const eventModal = document.getElementById("event-modal");
    const closeModal = document.getElementById("close-modal");
    const eventTitle = document.getElementById("event-title");
    const eventTime = document.getElementById("event-time");
    const eventDescription = document.getElementById("event-description");
    const eventLocation = document.getElementById("event-location");
    const eventLink = document.getElementById("event-link");

    const dayEventsModal = document.getElementById("day-events-modal");
    const closeDayModal = document.getElementById("close-day-modal");
    const dayEventsTitle = document.getElementById("day-events-title");
    const dayEventsSubtitle = document.getElementById("day-events-subtitle");
    const dayEventsList = document.getElementById("day-events-list");

    // ======== INIT ========
    document.addEventListener("DOMContentLoaded", () => {
        bindEventHandlers();
        initializeDashboard();
    });

    function bindEventHandlers() {
        if (connectGoogleBtn) {
            connectGoogleBtn.addEventListener("click", () => {
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (signoutButton) {
            signoutButton.addEventListener("click", () => handleSignOut(false));
        }

        if (tryDifferentAccountBtn) {
            tryDifferentAccountBtn.addEventListener("click", async () => {
                await handleSignOut(true);
                window.location.href = BACKEND_BASE_URL + "/auth/google";
            });
        }

        if (sendButton) {
            sendButton.addEventListener("click", (e) => {
                e.preventDefault();
                sendMessage();
            });
        }

        if (messageInput) {
            messageInput.addEventListener("input", updateSendButton);
        }

        if (fileInput) {
            fileInput.addEventListener("change", handleFileSelect);
        }

        if (removeFileButton) {
            removeFileButton.addEventListener("click", (e) => {
                e.preventDefault();
                clearSelectedFile();
            });
        }

        if (closeModal) {
            closeModal.addEventListener("click", () => {
                eventModal.classList.add("hidden");
            });
        }
        if (eventModal) {
            eventModal.addEventListener("click", (e) => {
                if (e.target === eventModal) {
                    eventModal.classList.add("hidden");
                }
            });
        }

        if (closeDayModal) {
            closeDayModal.addEventListener("click", () => {
                dayEventsModal.classList.add("hidden");
            });
        }
        if (dayEventsModal) {
            dayEventsModal.addEventListener("click", (e) => {
                if (e.target === dayEventsModal) {
                    dayEventsModal.classList.add("hidden");
                }
            });
        }

        updateSendButton();
    }

    // ======== HIGH-LEVEL FLOW ========
    async function initializeDashboard() {
        showAccessCheck();
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/status", {
                method: "GET",
                credentials: "include",
            });

            if (!resp.ok) {
                console.warn("Status check failed with HTTP", resp.status);
                showAuthArea();
                return;
            }

            const data = await resp.json();

            if (data.connected) {
                userHasAccess = true;
                userEmail = data.userEmail || (data.user && (data.user.email || data.user.primaryEmail)) || "";

                if (welcomeMessage) {
                    const user = data.user || {};
                    let firstName = "";
                    if (user.given_name) {
                        firstName = user.given_name;
                    } else if (user.name) {
                        firstName = user.name.split(" ")[0];
                    }

                    const email = userEmail || "";
                    let label = "Welcome";
                    if (firstName || email) {
                        label += ", ";
                        if (firstName) label += firstName;
                        if (firstName && email) label += " ";
                        if (email) label += "&lt;" + email + "&gt;";
                    }
                    welcomeMessage.innerHTML = label;
                }

                showDashboard();
                displayMonthlyCalendar();
            } else {
                showAuthArea();
            }
        } catch (err) {
            console.error("Error during status check:", err);
            showAuthArea();
        }
    }

    // ======== UI STATE ========
    function showAuthArea() {
        authArea.classList.remove("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessCheck() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.remove("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessDenied() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.remove("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showDashboard() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.remove("hidden");
        messagingSection.classList.remove("hidden");
    }

    // ======== SIGN OUT (BACKEND SESSION) ========
    async function handleSignOut(silent) {
        try {
            await fetch(BACKEND_BASE_URL + "/auth/logout", {
                method: "POST",
                credentials: "include",
            });
        } catch (err) {
            console.error("Error during logout:", err);
        }

        if (!silent) {
            window.location.href = "dashboard.html";
        }
    }

    // ========================================
    // CALENDAR WITH EVENT LIMITING
    // ========================================
    function displayMonthlyCalendar() {
        if (!calendarContainer) return;
        if (calendar) {
            calendar.destroy();
            calendar = null;
        }

        console.log("üîß Initializing calendar with event limiting...");

        // Simple header config that works on mobile
        // Mobile: empty left, title center, controls right
        // Desktop: today+arrows left, title center, view right
        const headerConfig = isMobile ? {
            left: "",
            center: "title",
            right: "prev,next customViewSwitcher",
        } : {
            left: "today prev,next",
            center: "title",
            right: "customViewSwitcher",
        };

        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: "dayGridMonth",
            headerToolbar: headerConfig,
            customButtons: {
                customViewSwitcher: {
                    text: '',
                    click: function() {
                        // Click handled by the select element
                    }
                }
            },
            fixedWeekCount: false,
            showNonCurrentDates: false,
            height: "100%",
            nextDayThreshold: "01:00:00",
            events: fetchCalendarEvents,

            // ========================================
            // KEY FIX: Hide events beyond limit as they mount
            // UPDATED: Only limit events in MONTHLY view, show all in Daily/Weekly
            // ========================================
            eventDidMount: function(info) {
                const el = info.el;
                const dayCell = el.closest('.fc-daygrid-day');
                
                if (!dayCell) {
                    console.warn("‚ö†Ô∏è  No dayCell for:", info.event.title);
                    return;
                }
                
                // Get current view type
                const currentView = calendar.view.type;
                
                // Only limit events in month view (dayGridMonth)
                // Show ALL events in day view (dayGridDay) and week view (dayGridWeek)
                if (currentView !== 'dayGridMonth') {
                    console.log(`   ‚úÖ Showing all events in ${currentView} view`);
                    return; // Don't hide anything in day/week view
                }
                
                // Track event count per day (only in month view)
                if (!dayCell._eventCount) {
                    dayCell._eventCount = 0;
                }
                
                const currentIndex = dayCell._eventCount;
                dayCell._eventCount++;
                
                // Hide if beyond limit (only in month view)
                if (currentIndex >= MAX_VISIBLE_EVENTS) {
                    el.style.display = 'none';
                    console.log(`   ‚ùå Hidden: "${info.event.title}" (event #${currentIndex + 1})`);
                } else {
                    console.log(`   ‚úÖ Visible: "${info.event.title}" (event #${currentIndex + 1})`);
                }
            },

            // Add indicators after all events loaded
            eventsSet: function(events) {
                console.log("üìä Events loaded:", events.length);
                setTimeout(() => addMoreEventsIndicators(), 0);
            },

            eventContent: function(arg) {
                const event = arg.event;
                const isAllDay = event.allDay;

                const color =
                    (event.extendedProps && event.extendedProps.calendarColor) ||
                    arg.backgroundColor ||
                    arg.borderColor ||
                    "#3b82f6";

                const container = document.createElement("div");
                container.className = "flex items-center";
                container.style.maxWidth = "100%";
                container.style.overflow = "hidden";
                container.style.textOverflow = "ellipsis";
                container.style.whiteSpace = "nowrap";
                container.style.boxSizing = "border-box";

                if (isAllDay) {
                    container.textContent = event.title || "";
                    container.style.backgroundColor = color;
                    container.style.borderRadius = "4px";
                    container.style.padding = "0 4px";
                    container.style.display = "block";
                    container.style.color = "#000000";
                    return { domNodes: [container] };
                }

                const dot = document.createElement("span");
                dot.className = "mie-event-dot";
                dot.style.backgroundColor = color;
                container.appendChild(dot);

                const timeSpan = document.createElement("span");
                timeSpan.className = "mie-event-time font-semibold mr-1";
                timeSpan.textContent = arg.timeText || "";
                timeSpan.style.flexShrink = "0";
                container.appendChild(timeSpan);

                const titleSpan = document.createElement("span");
                titleSpan.className = "mie-event-title";
                titleSpan.textContent = event.title || "";
                titleSpan.style.minWidth = "0";
                titleSpan.style.flexShrink = "1";
                titleSpan.style.overflow = "hidden";
                titleSpan.style.textOverflow = "ellipsis";
                titleSpan.style.whiteSpace = "nowrap";
                container.appendChild(titleSpan);

                return { domNodes: [container] };
            },

            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showEventDetails(info.event);
            },
        });

        calendar.render();
        console.log("‚úÖ Calendar rendered");
        
        // ========================================
        // Create custom view switcher dropdown
        // ========================================
        createViewSwitcher();
    }

    // ========================================
    // Create view switcher dropdown
    // ========================================
    function createViewSwitcher() {
        // Find the custom button placeholder in the toolbar
        const customButton = document.querySelector('.fc-customViewSwitcher-button');
        if (!customButton) {
            console.warn("‚ö†Ô∏è  Custom button not found");
            return;
        }
        
        // Create the dropdown container
        const switcherContainer = document.createElement('div');
        switcherContainer.className = 'view-switcher';
        
        // Create the select element
        const select = document.createElement('select');
        select.id = 'view-switcher-select';
        
        // Add options
        const views = [
            { value: 'dayGridDay', label: 'Daily' },
            { value: 'dayGridWeek', label: 'Weekly' },
            { value: 'dayGridMonth', label: 'Monthly' }
        ];
        
        // For mobile, show shorter labels in the dropdown
        const labelSuffix = isMobile ? ' ‚åÑ' : '';
        
        views.forEach(view => {
            const option = document.createElement('option');
            option.value = view.value;
            option.textContent = view.label;
            if (view.value === 'dayGridMonth') {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Add change event listener
        select.addEventListener('change', (e) => {
            const newView = e.target.value;
            console.log('üìÖ Switching to view:', newView);
            calendar.changeView(newView);
        });
        
        switcherContainer.appendChild(select);
        
        // Replace the button with our custom dropdown
        customButton.parentNode.replaceChild(switcherContainer, customButton);
        
        console.log("‚úÖ View switcher created");
    }

    // ========================================
    // Add "+ X more" indicators
    // UPDATED: Only show in monthly view
    // ========================================
    function addMoreEventsIndicators() {
        console.log("üîç Adding more events indicators...");
        
        // Check current view - only add indicators in month view
        const currentView = calendar.view.type;
        if (currentView !== 'dayGridMonth') {
            console.log("üìÖ Not in month view, skipping indicators");
            return;
        }
        
        // Remove old indicators
        document.querySelectorAll('.mie-more-events').forEach(el => el.remove());
        
        const dayCells = document.querySelectorAll('.fc-daygrid-day');
        let added = 0;
        
        dayCells.forEach(dayCell => {
            const dateStr = dayCell.getAttribute('data-date');
            if (!dateStr) return;
            
            const eventsForDay = eventsByDate[dateStr];
            if (!eventsForDay || eventsForDay.length <= MAX_VISIBLE_EVENTS) return;
            
            const hiddenCount = eventsForDay.length - MAX_VISIBLE_EVENTS;
            
            const indicator = document.createElement('div');
            indicator.className = 'mie-more-events';
            indicator.textContent = `+ ${hiddenCount} more event${hiddenCount > 1 ? 's' : ''}`;
            indicator.setAttribute('data-date', dateStr);
            
            indicator.addEventListener('click', (e) => {
                e.stopPropagation();
                showDayEventsModal(dateStr, eventsForDay);
            });
            
            const dayBottom = dayCell.querySelector('.fc-daygrid-day-bottom');
            const eventsContainer = dayCell.querySelector('.fc-daygrid-day-events');
            
            if (dayBottom) {
                dayBottom.appendChild(indicator);
                added++;
            } else if (eventsContainer) {
                eventsContainer.appendChild(indicator);
                added++;
            }
        });
        
        console.log(`‚úÖ Added ${added} indicators`);
    }

    // ========================================
    // Show day events modal
    // ========================================
    function showDayEventsModal(dateStr, events) {
        const date = new Date(dateStr + 'T12:00:00');
        const formattedDate = date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        dayEventsTitle.textContent = formattedDate;
        dayEventsSubtitle.textContent = `${events.length} event${events.length > 1 ? 's' : ''}`;
        
        dayEventsList.innerHTML = '';
        
        const sortedEvents = [...events].sort((a, b) => {
            return new Date(a.start) - new Date(b.start);
        });
        
        sortedEvents.forEach(event => {
            const item = document.createElement('div');
            item.className = 'day-event-item';
            
            const color = event.extendedProps?.calendarColor || '#3b82f6';
            item.style.borderLeftColor = color;
            
            let timeString = '';
            if (event.allDay) {
                timeString = 'All-day';
            } else {
                const startDate = new Date(event.start);
                const endDate = event.end ? new Date(event.end) : null;
                timeString = startDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                if (endDate) {
                    timeString += ' - ' + endDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                }
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'day-event-time';
            timeDiv.textContent = timeString;
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'day-event-title';
            titleDiv.textContent = event.title || 'No Title';
            
            item.appendChild(timeDiv);
            item.appendChild(titleDiv);
            
            if (event.extendedProps?.location) {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'day-event-location';
                locationDiv.textContent = 'üìç ' + event.extendedProps.location;
                item.appendChild(locationDiv);
            }
            
            item.addEventListener('click', () => {
                dayEventsModal.classList.add('hidden');
                showEventDetails(event);
            });
            
            dayEventsList.appendChild(item);
        });
        
        dayEventsModal.classList.remove('hidden');
    }

    // ========================================
    // Fetch events from backend
    // ========================================
    async function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/events", {
                method: "GET",
                credentials: "include",
            });

            if (resp.status === 401) {
                showAuthArea();
                if (failureCallback) failureCallback(new Error("NOT_CONNECTED"));
                return;
            }

            if (!resp.ok) {
                if (failureCallback) failureCallback(new Error("HTTP " + resp.status));
                return;
            }

            const data = await resp.json();
            const items = Array.isArray(data.events) ? data.events : [];

            console.log(`üì• Fetched ${items.length} events from backend`);

            // Build eventsByDate map
            eventsByDate = {};

            const events = items.map((e) => {
                const start = (e.start && (e.start.dateTime || e.start.date)) || null;
                const end = (e.end && (e.end.dateTime || e.end.date)) || null;
                const allDay = !!(e.start && e.start.date && !e.start.dateTime);

                const calColor =
                    e.mieCalendarColor ||
                    e._mieCalendarColor ||
                    null;

                const eventObj = {
                    id: e.id,
                    title: e.summary || "No Title",
                    start,
                    end,
                    allDay,
                    url: e.htmlLink || "",
                    extendedProps: {
                        description: e.description || "",
                        location: e.location || "",
                        calendarColor: calColor
                    },
                };

                // Add to eventsByDate map
                if (start) {
                    let dateStr;
                    if (allDay) {
                        dateStr = start;
                    } else {
                        dateStr = start.split('T')[0];
                    }
                    
                    if (!eventsByDate[dateStr]) {
                        eventsByDate[dateStr] = [];
                    }
                    eventsByDate[dateStr].push(eventObj);
                }

                return eventObj;
            });

            // Log days with many events
            Object.keys(eventsByDate).forEach(date => {
                const count = eventsByDate[date].length;
                if (count > MAX_VISIBLE_EVENTS) {
                    console.log(`üìÖ ${date}: ${count} events (${count - MAX_VISIBLE_EVENTS} will be hidden)`);
                }
            });

            successCallback(events);
        } catch (err) {
            console.error("Error fetching events:", err);
            if (failureCallback) failureCallback(err);
        }
    }

    function showEventDetails(event) {
        eventTitle.textContent = event.title || "No Title";

        const startDate = event.start instanceof Date ? event.start : new Date(event.start);
        const endDate = event.end ? (event.end instanceof Date ? event.end : new Date(event.end)) : null;

        let timeString = "All-day";
        if (!event.allDay && startDate instanceof Date) {
            timeString = startDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            if (endDate) {
                timeString += " - " + endDate.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
            }
        }

        eventTime.textContent =
            startDate.toLocaleDateString() + (event.allDay ? "" : " | " + timeString);

        eventDescription.textContent =
            (event.extendedProps && event.extendedProps.description) || "No description provided.";
        eventLocation.textContent =
            (event.extendedProps && event.extendedProps.location) || "No location provided.";

        if (event.url) {
            eventLink.href = event.url;
            eventLink.classList.remove("pointer-events-none", "opacity-50");
        } else {
            eventLink.href = "#";
            eventLink.classList.add("pointer-events-none", "opacity-50");
        }

        eventModal.classList.remove("hidden");
    }

    // ======== MESSAGING ========
    async function sendMessage() {
        if (!userHasAccess) {
            logMessage("Error: Not connected to Google.", "error");
            return;
        }

        const text = messageInput ? messageInput.value.trim() : "";
        if (!text && !selectedFile) return;

        let payloadText = text;
        if (selectedFile) {
            payloadText += (payloadText ? "\n\n" : "") + "[Attachment selected in UI: " + selectedFile.name + "]";
        }

        logMessage("Sending message...", "info");
        sendButton.disabled = true;

        try {
            const resp = await fetch(BACKEND_BASE_URL + "/api/me/message", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: payloadText }),
            });

            if (!resp.ok) {
                logMessage("Failed to send message. Please try again.", "error");
                return;
            }

            logMessage("Message sent.", "success");
            if (messageInput) messageInput.value = "";
            clearSelectedFile();
        } catch (err) {
            logMessage("Error sending message. Please try again.", "error");
        } finally {
            updateSendButton();
        }
    }

    function handleFileSelect(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) {
            clearSelectedFile();
            return;
        }

        selectedFile = file;

        if (filePreview && previewImage) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                previewImage.src = ev.target.result;
                filePreview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
        }

        updateSendButton();
    }

    function clearSelectedFile() {
        selectedFile = null;
        if (fileInput) fileInput.value = "";
        if (filePreview) filePreview.classList.add("hidden");
        updateSendButton();
    }

    function updateSendButton() {
        if (!sendButton) return;
        const canSend = (messageInput && messageInput.value.trim() !== "") || selectedFile !== null;
        sendButton.disabled = !canSend;
    }

    function logMessage(msg, type) {
        if (!messageLog) return;
        const entry = document.createElement("div");
        entry.className = "text-sm mb-1";

        if (type === "error") {
            entry.classList.add("text-red-500");
        } else if (type === "success") {
            entry.classList.add("text-green-500");
        } else {
            entry.classList.add("text-gray-600");
        }

        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = "[" + timestamp + "] " + msg;

        const placeholder = messageLog.querySelector(".text-gray-500");
        if (placeholder) placeholder.remove();

        messageLog.appendChild(entry);
        messageLog.scrollTop = messageLog.scrollHeight;
    }
})();
</script>
</body>
</html>
