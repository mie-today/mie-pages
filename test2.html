// Calendar functionality
    function displayMonthlyCalendar() {
        if (!userHasAccess) return;
        
        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(calendarContainer, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'today', center: 'title', right: 'prev,next' },
            fixedWeekCount: false,
            showNonCurrentDates: false,
            height: 'auto',
            events: async (fetchInfo, successCallback, failureCallback) => {
                try {
                    // First, get all calendars
                    const calendarListResponse = await gapi.client.calendar.calendarList.list();
                    const calendars = calendarListResponse.result.items;
                    
                    console.log(`Found ${calendars.length} calendars`);
                    
                    // Fetch events from all calendars
                    const eventPromises = calendars.map(async (cal) => {
                        try {
                            const res = await gapi.client.calendar.events.list({
                                'calendarId': cal.id,
                                'timeMin': fetchInfo.start.toISOString(),
                                'timeMax': fetchInfo.end.toISOString(),
                                'showDeleted': false,
                                'singleEvents': true,
                                'orderBy': 'startTime'
                            });
                            return res.result.items.map(e => ({
                                id: e.id,
                                title: e.summary || 'No Title',
                                start: e.start.dateTime || e.start.date,
                                end: e.end.dateTime || e.end.date,
                                url: e.htmlLink,
                                allDay: !e.start.dateTime,
                                description: e.description || '',
                                location: e.location || '',
                                backgroundColor: cal.backgroundColor || '#3b82f6',
                                borderColor: cal.backgroundColor || '#3b82f6',
                            }));
                        } catch (err) {
                            console.error(`Error fetching events from calendar ${cal.summary}:`, err);
                            return [];
                        }
                    });
                    
                    const eventArrays = await Promise.all(eventPromises);
                    const allEvents = eventArrays.flat();
                    
                    console.log(`Total events loaded: ${allEvents.length}`);
                    successCallback(allEvents);
                } catch (err) {
                    console.error("Error fetching calendar events: ", err);
                    failureCallback(err);
                }
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showEventDetails(info.event);
            }
        });
        calendar.render();
    }
