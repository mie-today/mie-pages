<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>
<!-- Google Identity Services -->
<script>
window.handleCredentialResponse = function(response) {
    console.log('GIS credential received', response);
    if (!response.credential) { console.error('No credential returned.'); return; }

    if (!window.tokenClient) {
        window.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com",
            scope: "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email",
            callback: async (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    gapi.client.setToken(tokenResponse);
                    document.dispatchEvent(new CustomEvent('gis-token-received', { detail: tokenResponse }));
                } else { console.error('Failed to get access token.', tokenResponse); }
            },
        });
    }
    window.tokenClient.requestAccessToken({ prompt: "" });
};
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1f2937; margin: 0; padding: 0; }
.oauth-app-container { max-width: 100%; margin: 0 auto; }

.oauth-app-container #message-log::-webkit-scrollbar,
.oauth-app-container #calendar-container::-webkit-scrollbar { width: 8px; height: 8px; }
.oauth-app-container #message-log::-webkit-scrollbar-track,
.oauth-app-container #calendar-container::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
.oauth-app-container #message-log::-webkit-scrollbar-thumb,
.oauth-app-container #calendar-container::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

.disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

/* Fixed height sections */
.auth-area { height: 525px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.calendar-section { height: 325px; }
.messaging-section { height: 200px; }

/* Sign out button outside calendar */
#signout_button { position: absolute; top: 8px; right: 8px; z-index: 10; }

/* FullCalendar adjustments for smaller size */
.fc { color: #1f2937 !important; background-color: #ffffff !important; }
.fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; font-size: 12px !important; padding: 2px 6px !important; }
.fc .fc-toolbar-title { font-size: 16px !important; }
.fc .fc-col-header-cell { font-size: 10px !important; }
.fc .fc-daygrid-day-number { font-size: 10px !important; }
.fc .fc-event { font-size: 9px !important; }

/* Messaging area small input & file button */
#message-input { height: 40px; font-size: 12px; padding: 4px 6px; }
label[for="file-input"] { font-size: 12px; padding: 2px 6px; }

/* Mobile responsiveness */
@media (max-width: 480px) {
    .oauth-app-container { width: 100%; min-height: 100vh; padding: 2px; overflow-y: auto; }
    .calendar-section, .messaging-section { width: 100%; }
}
@media (min-width: 481px) and (max-width: 768px) {
    .oauth-app-container { width: 481px; }
}
@media (min-width: 769px) {
    .oauth-app-container { width: 800px; }
}
</style>
</head>
<body>

<div class="oauth-app-container relative">

    <!-- Sign Out Button outside calendar -->
    <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white rounded-md py-1 px-2">Sign Out</button>

    <!-- Auth Area -->
    <div id="auth-area" class="auth-area bg-white rounded-xl shadow-lg w-full">
        <h2 class="text-lg font-semibold text-center text-gray-800">Sign in to view your Google Calendar</h2>
        <!-- Only one sign-in widget -->
        <div class="g_id_signin"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-type="standard"
             data-shape="pill"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left"
             data-auto_prompt="false"
             data-callback="handleCredentialResponse">
        </div>
    </div>

    <!-- Calendar Section -->
    <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg w-full mt-4 p-2 flex flex-col hidden">
        <div id="calendar-container" class="flex-1 min-h-0"></div>
    </div>

    <!-- Messaging Section -->
    <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg w-full mt-2 p-2 flex flex-col hidden">
        <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto">
            <div class="text-sm text-gray-500">Your sent messages will appear here...</div>
        </div>
        <textarea id="message-input" placeholder="Type your message..." class="rounded-2xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none"></textarea>
        <div class="flex items-center space-x-2 mt-2">
            <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-full">Add Image</label>
            <input id="file-input" type="file" class="hidden" accept="image/*">
            <div id="file-preview" class="hidden flex items-center space-x-2">
                <img id="preview-image" class="w-16 h-16 object-cover rounded border" alt="Preview">
                <button id="remove-file" class="text-red-500 text-sm">Remove</button>
            </div>
        </div>
        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2" disabled>Send</button>
    </div>

</div>

<script>
(async function(){
    const CLIENT_ID="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
    let calendar=null;
    const authArea=document.getElementById('auth-area');
    const calendarSection=document.getElementById('calendar-section');
    const messagingSection=document.getElementById('messaging-section');
    const calendarContainer=document.getElementById('calendar-container');
    const signoutButton=document.getElementById('signout_button');

    signoutButton.addEventListener('click',()=>{
        authArea.classList.remove('hidden');
        calendarSection.classList.add('hidden');
        messagingSection.classList.add('hidden');
        const token=gapi.client.getToken();
        if(token) google.accounts.oauth2.revoke(token.access_token,()=> gapi.client.setToken(null));
    });

    document.addEventListener('gis-token-received',()=> {
        authArea.classList.add('hidden');
        calendarSection.classList.remove('hidden');
        messagingSection.classList.remove('hidden');
        if(calendar) calendar.destroy();
        calendar=new FullCalendar.Calendar(calendarContainer,{
            initialView:'dayGridMonth',
            headerToolbar:{ left:'prev,next',center:'title',right:'today' },
            height:'325px'
        });
        calendar.render();
    });
})();
</script>

</body>
</html>
