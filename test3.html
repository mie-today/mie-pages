// CONFIGURATION
const SPREADSHEET_ID = "1T9qiDQa1DUwMF06V6M_TBO0Nc-36IKeTuIWkpdxh40U";
const SHEET_NAME = "Sheet1";

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    "status": "success", 
    "message": "Script is working! Use POST method to submit data."
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    console.log('Received POST request');
    const data = JSON.parse(e.postData.contents);
    console.log('Parsed data:', data);
    
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    const timestamp = new Date();
    
    const rowData = [
      timestamp,
      data.fullName || 'N/A',
      data.emailAddress || 'N/A', 
      data.phoneNumber || 'N/A',
      data.pin || 'N/A',
      "Yes" // Approved column
    ];
    
    sheet.appendRow(rowData);
    console.log('Data written to sheet successfully');
    
    // Send welcome notifications since user is auto-approved
    sendWelcomeNotifications(data.emailAddress, data.phoneNumber, data.fullName);
    
    return ContentService.createTextOutput(JSON.stringify({ 
      "status": "success", 
      "message": "Data saved and welcome messages sent" 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService.createTextOutput(JSON.stringify({ 
      "status": "error", 
      "message": error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function sendWelcomeNotifications(email, phoneNumber, fullName) {
  const firstName = fullName.split(' ')[0]; // Extract first name
  
  try {
    // Send Welcome Email
    sendWelcomeEmail(email, firstName);
    console.log('Welcome email sent to:', email);
    
    // Send Welcome SMS
    sendWelcomeSMS(phoneNumber, firstName);
    console.log('Welcome SMS sent to:', phoneNumber);
    
  } catch (error) {
    console.error('Error sending notifications:', error);
    // Don't throw error - we still want the signup to succeed even if notifications fail
  }
}

function sendWelcomeEmail(email, firstName) {
  const subject = "Welcome to Mie - Access Granted!";
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: #4CAF50; color: white; pad
