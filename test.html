<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    color: #1f2937;
    margin: 0;
    padding: 0;
  }
  .dark body {
    background-color: #111827;
    color: #f9fafb;
  }

  /* Scrollbar fix */
  .oauth-app-container #message-log::-webkit-scrollbar, .oauth-app-container #event-list::-webkit-scrollbar { width:8px; height:8px; }
  .oauth-app-container #message-log::-webkit-scrollbar-track, .oauth-app-container #event-list::-webkit-scrollbar-track { background-color:#e5e7eb; border-radius:9999px; }
  .oauth-app-container #message-log::-webkit-scrollbar-thumb, .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color:#9ca3af; border-radius:9999px; }
  .dark .oauth-app-container #message-log::-webkit-scrollbar-track, .dark .oauth-app-container #event-list::-webkit-scrollbar-track { background-color:#374151; }
  .dark .oauth-app-container #message-log::-webkit-scrollbar-thumb, .dark .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color:#6b7280; }

  .oauth-app-container .flex-grow-scroll { overflow-y:auto; flex-grow:1; }
  .disabled { opacity: 0.5; cursor: not-allowed; }

  .oauth-app-container { max-width: 100%; margin: 0 auto; }

  /* --- Mobile: fit 350x500 exactly --- */
  @media (max-width: 480px) {
    .oauth-app-container {
      width: 350px !important;
      height: 500px !important;
      overflow: hidden !important;
      margin: 0 auto !important;
    }
    .mobile-container { padding: 4px !important; gap: 4px !important; height: 100% !important; }
    .calendar-section { width: 100% !important; height: 300px !important; overflow: hidden !important; }
    .messaging-section { width: 100% !important; height: 180px !important; overflow: hidden !important; }
  }

  /* Tablet preserved */
  @media (min-width: 481px) and (max-width: 768px) {
    .oauth-app-container { width: 481px; }
    .calendar-section { width: 481px; height: 632px; }
    .messaging-section { width: 481px; height: 316px; }
  }

  /* Desktop preserved */
  @media (min-width: 769px) {
    .oauth-app-container { width: 800px; }
    .calendar-section { width: 800px; height: 860px; }
    .messaging-section { width: 800px; height: 360px; }
  }

  /* --- FullCalendar Dark Mode Fix --- */
  .fc {
    background-color: #ffffff !important;
    color: #1f2937 !important;
  }
  .dark .fc {
    background-color: #1f2937 !important;
    color: #f9fafb !important;
  }
  .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
  .dark .fc .fc-col-header-cell { background-color: #374151 !important; color: #f9fafb !important; }
  .fc .fc-daygrid-day-number { color: inherit !important; }
  .fc .fc-event { background-color: #3b82f6 !important; border-color: #2563eb !important; color: #fff !important; }
  .fc .fc-toolbar-title { color: inherit !important; }

  /* --- Mobile Calendar Controls Sizing (annotations) --- */
  @media (max-width: 480px) {
    /* Toolbar title font-size ~17pt (22.67px) */
    .fc .fc-toolbar-title { font-size: 22.67px !important; }
    /* Nav buttons font-size smaller ~12pt (16px) */
    .fc .fc-button-primary { font-size: 16px !important; padding: 4px 8px !important; }
    /* Day headers smaller */
    .fc .fc-col-header-cell { font-size: 14px !important; }
    /* Day numbers smaller */
    .fc .fc-daygrid-day-number { font-size: 14px !important; }
    /* Events tiny */
    .fc .fc-event { font-size: 11px !important; }
  }

  /* Hide non-current month dates */
  .fc .fc-daygrid-day.fc-day-other { display: none !important; }
</style>
</head>
<body>
<div class="oauth-app-container">
  <div class="flex flex-col p-4 space-y-4 w-full mobile-container">
    <!-- Calendar Section -->
    <div id="calendar-section" class="calendar-section bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col">
      <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
        <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-center">Sign in to view your Google Calendar</h2>
        <div id="g_id_onload"
             data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="dark" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
      </div>
      <div id="calendar-content" class="hidden flex flex-col h-full">
        <div class="flex justify-end items-center mb-4">
          <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-2 rounded-md">Sign Out</button>
        </div>
        <div id="calendar-container" class="flex-1 min-h-0"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
  const API_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email';

  let calendar, tokenClient, userEmail = null;
  let cachedCalendars = null;

  const authArea = document.getElementById('auth-area');
  const calendarContent = document.getElementById('calendar-content');
  const calendarContainer = document.getElementById('calendar-container');
  const signoutButton = document.getElementById('signout_button');

  signoutButton.addEventListener('click', handleSignOut);

  gapi.load('client', () => {
    gapi.client.init({
      discoveryDocs: [
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
      ]
    });
  });

  window.handleCredentialResponse = (response) => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: API_SCOPES,
      callback: async (tokenResponse) => {
        if(tokenResponse && tokenResponse.access_token){
          gapi.client.setToken(tokenResponse);
          await onSignedIn();
        }
      }
    });
    tokenClient.requestAccessToken();
  };

  async function onSignedIn(){
    authArea.classList.add('hidden');
    calendarContent.classList.remove('hidden');
    await getUserEmail();
    displayCalendar();
  }

  async function getUserEmail(){
    try {
      const token = gapi.client.getToken();
      const res = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token.access_token}` }
      });
      if(res.ok){
        const data = await res.json();
        userEmail = data.email;
      }
    }catch(e){ console.error("Email fetch failed", e); }
  }

  function handleSignOut(){
    const token = gapi.client.getToken();
    if(token){
      google.accounts.oauth2.revoke(token.access_token, () => {
        gapi.client.setToken(null);
      });
    }
    authArea.classList.remove('hidden');
    calendarContent.classList.add('hidden');
  }

  function displayCalendar(){
    if(calendar) calendar.destroy();
    calendar = new FullCalendar.Calendar(calendarContainer, {
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
      fixedWeekCount: false,
      showNonCurrentDates: false,
      events: async (info, success, fail) => {
        try{
          if(!cachedCalendars){
            const list = await gapi.client.calendar.calendarList.list();
            cachedCalendars = list.result.items;
          }
          const promises = cachedCalendars.map(cal =>
            gapi.client.calendar.events.list({
              calendarId: cal.id,
              timeMin: info.start.toISOString(),
              timeMax: info.end.toISOString(),
              singleEvents: true,
              showDeleted: false
            }).then(r=> r.result.items.map(e=>({
              id:e.id,title:e.summary||'No Title',start:e.start.dateTime||e.start.date,
              end:e.end.dateTime||e.end.date, url:e.htmlLink, allDay:!e.start.dateTime,
              backgroundColor: cal.backgroundColor, borderColor: cal.backgroundColor,
              description: e.description||''
            })))
          );
          const all = (await Promise.all(promises)).flat();
          success(all);
        }catch(err){ fail(err); }
      }
    });
    calendar.render();
  }

  /* Safe UTF-8 to Base64 */
  function utf8ToBase64(str){
    return btoa(new TextEncoder().encode(str).reduce((d, b) => d+String.fromCharCode(b), ''));
  }
})();
</script>
</body>
</html>
