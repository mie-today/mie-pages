<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://apis.google.com/js/api.js"></script>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lato:wght@400&family=Montserrat:wght@600&display=swap"
  rel="stylesheet"
/>

<style>
    /* --- General Body and Layout --- */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #ffffff;
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Custom font classes */
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-lato { font-family: 'Lato', sans-serif; }

    /* --- Scrollbar Styling --- */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    /* Utility class for disabled elements */
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    /* Main container for the entire application */
    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* --- Responsive Styles for Mobile (up to 480px wide) --- */
    @media (max-width: 480px) {
        .oauth-app-container {
            width: 100% !important;
        }
        .mobile-container {
            padding: 4px !important;
            gap: 4px !important;
        }
        .calendar-section, .messaging-section {
            width: 100% !important;
            height: auto !important;
            padding: 8px !important;
        }
        .mobile-heading { font-size: 20px !important; line-height: 1.2 !important; }
        .mobile-text { font-size: 14px !important; line-height: 1.1 !important; }
        .mobile-small-btn { padding: 4px 8px !important; font-size: 12px !important; }
        .mobile-text-btn { font-size: 16px !important; }
        .mobile-textarea { height: 60px !important; padding: 4px 8px !important; }
        .fc .fc-toolbar-title { font-size: 20px !important; }
        .fc .fc-button-primary { font-size: 12px !important; padding: 4px 6px !important; }
        .fc .fc-col-header-cell { font-size: 12px !important; }
        .fc .fc-daygrid-day-number { font-size: 12px !important; }
        .fc .fc-event { font-size: 10px !important; }
    }

    /* --- Responsive Styles for Tablet (481px to 768px) --- */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 632px; }
        .messaging-section { width: 481px; height: 316px; }
    }

    /* --- Responsive Styles for Desktop (769px and wider) --- */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 860px; }
        .messaging-section { width: 800px; height: 360px; }
    }

    /* --- FullCalendar Light Mode Customization --- */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }
    .fc-daygrid-day.fc-day-today { background-color: rgba(59,130,246,0.1) !important; }
    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }
    .fc .fc-event { border-color: #3b82f6 !important; background-color: #3b82f6 !important; color: white !important; }
    .fc .fc-toolbar-title { color: #1f2937 !important; }
    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* --- Event Modal Styling --- */
    .event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .event-modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); color: #1f2937; }
    @media (max-width: 480px){ .event-modal-content { max-width: 320px !important; padding: 16px !important; } }

    /* --- Access Denied Styling --- */
    .access-denied { color: #dc2626; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-top: 16px; }
</style>
</head>
<body class="bg-white">

<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">

            <div id="auth-area" class="flex flex-col items-center justify-start h-full p-4">
                <img src="https://github.com/rylhong/mie-pages/blob/main/logo_white_70x70.png?raw=true" alt="Mie Logo" class="rounded-full mb-4">
                <h1 class="font-montserrat text-2xl font-semibold text-gray-800" style="font-size: 18pt;">Mie</h1>
                <p class="font-lato text-base text-gray-600 mt-1 mb-6" style="font-size: 12pt;">Remember your life</p>

                <button
                    id="connect-google-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full px-5 py-2 text-sm flex items-center shadow"
                    style="min-width:200px; justify-content:center;"
                >
                    Connect Google
                </button>

                <div class="mt-6 text-sm text-gray-500">
                    or
                    <a href="signup.html"
                       class="font-semibold text-green-600 hover:text-green-700 hover:underline">
                    Create an account
                    </a>
                </div>
            </div>

            <div id="access-check-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img src="https://github.com/rylhong/mie-pages/blob/main/logo_white_70x70.png?raw=true" alt="Mie Logo" class="rounded-full mb-4">
                <h2 class="font-montserrat text-xl font-semibold text-gray-800 mb-4">Verifying Access...</h2>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-4">Checking if your account has access to Mie dashboard</p>
            </div>

            <div id="access-denied-area" class="hidden flex flex-col items-center justify-start h-full p-4">
                <img src="https://github.com/rylhong/mie-pages/blob/main/logo_white_70x70.png?raw=true" alt="Mie Logo" class="rounded-full mb-4">
                <h2 class="font-montserrat text-xl font-semibold text-red-600 mb-4">Access Denied</h2>
                <div class="access-denied text-center max-w-md">
                    <p class="mb-3">Your Gmail account doesn't have access to the Mie dashboard.</p>
                    <p class="mb-4">To get access, please sign up with the correct PIN code.</p>
                    <div class="space-y-3">
                        <a href="signup.html" class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Sign Up for Access</a>
                        <br />
                        <button id="try-different-account" class="text-blue-600 hover:text-blue-700 underline text-sm">
                            Try a Different Account
                        </button>
                    </div>
                </div>
            </div>

            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-between items-center">
                    <span id="welcome-message" class="text-sm text-gray-600"></span>
                    <button
                        id="signout_button"
                        class="bg-white text-red-600 border border-red-600 hover:bg-red-50 text-xs font-semibold mobile-small-btn py-1 px-2 rounded-md"
                    >
                        Sign Out
                    </button>
                </div>
                <div id="calendar-container" class="flex-1 min-h-0 mt-1"></div>
            </div>
        </div>

        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 mobile-heading">Send a Message</h2>

            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2">
                <div class="text-sm mobile-text text-gray-500">Your sent messages will appear here...</div>
            </div>

            <textarea
                id="message-input"
                placeholder="Type your message..."
                class="rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"
            ></textarea>

            <div class="flex items-center space-x-2 mt-2">
                <label
                    for="file-input"
                    class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold text-sm py-1 px-3 rounded-full mobile-text"
                >
                    Attachment
                </label>
                <input id="file-input" type="file" class="hidden" accept="image/*" />
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-12 h-12 object-cover rounded border" alt="Preview" />
                    <button id="remove-file" class="text-red-500 text-sm mobile-text">Remove</button>
                </div>
            </div>

            <button
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mt-2 mobile-text-btn"
                disabled
            >
                Send
            </button>
        </div>
    </div>
</div>

<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl font-semibold mobile-heading"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text"></p>
            <p id="event-description" class="text-gray-700 mobile-text"></p>
            <p id="event-location" class="text-gray-600 mobile-text"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a
                id="event-link"
                target="_blank"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-btn"
            >
                Open in Google Calendar
            </a>
        </div>
    </div>
</div>

<script>
/*
    MODIFIED SCRIPT (Nov 2025)

    High-level auth model:

    MODE A: Browser (desktop/mobile web)
    - User clicks "Connect Google"
    - We redirect to Google OAuth (AUTHORIZATION CODE flow, response_type=code)
    - We get a one-time 'code' back in the URL query parameters
    - We POST this 'code' to our backend (Google Apps Script)
    - Backend exchanges 'code' + 'client_secret' for an 'access_token' and 'refresh_token'
    - Backend securely stores 'refresh_token' (e.g., in PropertiesService)
    - Backend returns the short-lived 'access_token' to this script
    - We call Google Calendar + Gmail APIs directly from JS using this 'access_token'

    MODE B: Android WebView (native bridge)
    - (This flow is unchanged and remains separate)
*/

(async function () {
    // ======== CONFIG =========
    const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";

    // *** MODIFIED: Updated scopes for Calendar write access ***
    const SCOPES = [
        "https://www.googleapis.com/auth/calendar.events", // <-- GRANTS WRITE ACCESS
        "https://www.googleapis.com/auth/gmail.send",
        "https://www.googleapis.com/auth/userinfo.email"
    ].join(" ");

    // Your allowlist check endpoint
    const ACCESS_CHECK_URL =
        "https://script.google.com/macros/s/AKfycbzhXov8noDHtO-aNZTbzsuzuf_QdRuRAs9_yjzFMjhEvK9qw5XVS_ROILyibzGw2w5F/exec";

    // *** NEW: Endpoint for exchanging the code. This is the *same* as your ACCESS_CHECK_URL ***
    const TOKEN_EXCHANGE_URL = ACCESS_CHECK_URL; 

    // Where outbound messages get sent
    const RECIPIENT_EMAIL = "save@mie.today";

    // ======== STATE =========
    let calendar = null;
    let selectedFile = null;
    let userEmail = null;
    let gapi_loaded = false;
    let userHasAccess = false;

    // This token is now a short-lived *session* token provided by our backend
    let sessionAccessToken = null; // <-- Renamed from accessToken

    // ======== DOM HOOKS =========
    const authArea = document.getElementById("auth-area");
    const accessCheckArea = document.getElementById("access-check-area");
    const accessDeniedArea = document.getElementById("access-denied-area");
    const calendarContent = document.getElementById("calendar-content");
    const calendarContainer = document.getElementById("calendar-container");
    const messagingSection = document.getElementById("messaging-section");
    const welcomeMessage = document.getElementById("welcome-message");
    const signoutButton = document.getElementById("signout_button");
    const tryDifferentAccountBtn = document.getElementById("try-different-account");
    const connectGoogleBtn = document.getElementById("connect-google-btn");
    const sendButton = document.getElementById("send-button");
    const messageLog = document.getElementById("message-log");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const previewImage = document.getElementById("preview-image");
    const removeFileButton = document.getElementById("remove-file");
    const eventModal = document.getElementById("event-modal");
    const closeModal = document.getElementById("close-modal");
    const eventTitle = document.getElementById("event-title");
    const eventTime = document.getElementById("event-time");
    const eventDescription = document.getElementById("event-description");
    const eventLocation = document.getElementById("event-location");
    const eventLink = document.getElementById("event-link");

    // ======== EVENT LISTENERS =========
    signoutButton.addEventListener("click", handleSignOut);
    tryDifferentAccountBtn.addEventListener("click", handleSignOut);
    connectGoogleBtn.addEventListener("click", onGoogleSignInClick); 
    sendButton.addEventListener("click", sendEmail);
    messageInput.addEventListener("input", updateSendButton);
    fileInput.addEventListener("change", handleFileSelect);
    removeFileButton.addEventListener("click", removeFile);
    closeModal.addEventListener("click", () => eventModal.classList.add("hidden"));
    eventModal.addEventListener("click", (e) => {
        if (e.target === eventModal) eventModal.classList.add("hidden");
    });

    // ======== ANDROID BRIDGE ENTRY POINT (Unchanged) ========
    async function onGoogleSignInClick() { 
        if (window.AndroidBridge && AndroidBridge.triggerGoogleSignIn) {
            AndroidBridge.triggerGoogleSignIn();
            return;
        }
        // We're in normal browser. Use the NEW redirect flow.
        beginGoogleAuthRedirect(); // <-- This function is now modified
    }

    // (Android callback functions __onAndroidGoogleSignIn and __onAndroidGoogleSignInError remain unchanged)
    window.__onAndroidGoogleSignIn = async function (data) { 
        try {
            const res = await fetch("/auth/google/native-login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include", 
                body: JSON.stringify(data),
            });
            if (res.ok) {
                window.location.reload();
                return;
            }
            console.error("native-login failed with HTTP", res.status);
            alert("Sign-in failed. Please try again.");
        } catch (err) {
            console.error("native-login network error", err);
            alert("Network error while signing in.");
        }
    };
    window.__onAndroidGoogleSignInError = function (statusCode) { 
        console.warn("Android Google Sign-In failed:", statusCode);
        alert("Google Sign-In was cancelled or failed (code " + statusCode + ").");
    };


    // ======== AUTH FLOW (BROWSER MODE / AUTH CODE FLOW) =========
    
    // Step 1: init GAPI client library (must happen before checking code)
    await initGapiClient();

    // Step 2: check URL query params for an auth 'code' from Google redirect.
    const authCode = parseAuthCodeFromUrlParams(); // <-- MODIFIED

    // Step 3: If we have a code, exchange it. Otherwise, show login.
    if (authCode) {
        // We just returned from Google. 
        // Show "Verifying..." while we exchange the code.
        showAccessCheck(); 
        try {
            // Exchange code for an access_token via our backend
            const token = await exchangeCodeForToken(authCode); // <-- NEW
            
            if (token) {
                sessionAccessToken = token;
                gapi.client.setToken({ access_token: sessionAccessToken });
                // Now that we have a token, proceed to check access list
                handleAuthSuccess();
            } else {
                throw new Error("Token exchange failed, no access token received.");
            }
        } catch (err) {
            console.error("Failed to exchange auth code:", err);
            logMessage("Sign-in failed during token exchange.", "error");
            showAuthArea(); // Send back to login
        }
    } else {
        // No code in URL -> show unauth state
        showAuthArea();
    }

    /**
     * *** MODIFIED ***
     * Build Google OAuth URL (Auth Code flow) and redirect.
     */
    function beginGoogleAuthRedirect() {
        const redirectUri = window.location.origin + window.location.pathname;

        const params = new URLSearchParams({
            client_id: CLIENT_ID,
            redirect_uri: redirectUri,
            response_type: "code", // <-- MODIFIED: 'code' instead of 'token'
            scope: SCOPES,
            include_granted_scopes: "true",
            access_type: "offline", // <-- NEW: Request offline access to get a Refresh Token
            prompt: "consent", // <-- IMPORTANT: Ensures refresh token is granted
            state: "mie_oauth_state_" + Date.now()
        });

        const oauthUrl = "https://accounts.google.com/o/oauth2/v2/auth?" + params.toString();
        window.location = oauthUrl;
    }

    /**
     * *** NEW FUNCTION ***
     * Pulls 'code' from URL query parameters (e.g., ?code=...).
     * Then cleans the code out of the URL.
     */
    function parseAuthCodeFromUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");
        
        if (code) {
            // Clean URL so the code isn't re-used on refresh
            window.history.replaceState(
                {},
                document.title,
                window.location.pathname // Remove all query params
            );
        }
        return code;
    }

    /**
     * *** NEW FUNCTION ***
     * Sends the one-time auth code to our backend (Apps Script)
     * to be exchanged for an access_token and refresh_token.
     * The backend stores the refresh_token and returns the access_token.
     */
    async function exchangeCodeForToken(code) {
        console.log("Exchanging code for token...");
        // Use your existing Apps Script URL
        const exchangeUrl = `${TOKEN_EXCHANGE_URL}?action=exchangeCode&code=${encodeURIComponent(code)}`;

        try {
            const response = await fetch(exchangeUrl, {
                method: "GET", // Apps Script web apps use GET by default
                mode: "cors",
            });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.access_token) {
                console.log("Access token received from backend.");
                return data.access_token;
            } else {
                throw new Error(data.error || "Backend did not return an access_token.");
            }
        } catch (error) {
            console.error("Error during token exchange fetch:", error);
            throw error; // Re-throw to be caught by the caller
        }
    }


    /**
     * Initialize gapi client discovery docs (Calendar + Gmail)
     * (Unchanged)
     */
    async function initGapiClient() {
        return new Promise((resolve) => {
            gapi.load("client", () => {
                gapi.client
                    .init({
                        discoveryDocs: [
                            "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
                            "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"
                        ]
                    })
                    .then(() => {
                        gapi_loaded = true;
                        resolve();
                    });
            });
        });
    }

    // ======== UI STATE MGMT (Unchanged) =========
    function showAuthArea() {
        authArea.classList.remove("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessCheck() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.remove("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showAccessDenied() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.remove("hidden");
        calendarContent.classList.add("hidden");
        messagingSection.classList.add("hidden");
    }

    function showDashboard() {
        authArea.classList.add("hidden");
        accessCheckArea.classList.add("hidden");
        accessDeniedArea.classList.add("hidden");
        calendarContent.classList.remove("hidden");
        messagingSection.classList.remove("hidden");
    }

    // ======== AUTH SUCCESS HANDLER (Mostly Unchanged) =========
    async function handleAuthSuccess() {
        // This function is now called *after* the token has been
        // fetched from our backend and set in gapi.
        
        if (!gapi_loaded || !gapi.client.getToken()) { // <-- Modified check
            console.error("Auth success path hit without gapi/token");
            showAccessDenied();
            return;
        }

        // UI is already showing "Verifying Access..."
        // showAccessCheck(); // This was already called

        try {
            // 1. Resolve the user's email
            userEmail = await getUserEmail();
            console.log("User email:", userEmail);

            // 2. Check allowlist
            const hasAccess = await checkUserAccess(userEmail);

            if (hasAccess) {
                userHasAccess = true;
                welcomeMessage.textContent = `Welcome, ${userEmail}`;
                showDashboard();
                displayMonthlyCalendar(); // <-- This will now work
            } else {
                userHasAccess = false;
                showAccessDenied();
            }
        } catch (e) {
            console.error("Error during auth process:", e);
            showAccessDenied();
        }
    }

    // ======== USER EMAIL RESOLUTION (Unchanged) =========
    async function getUserEmail() {
        try {
            const token = gapi.client.getToken();
            if (!token || !token.access_token) throw new Error("No token in gapi client");

            // Try userinfo endpoint first
            const resp = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
                headers: { Authorization: `Bearer ${token.access_token}` }
            });

            if (resp.ok) {
                const data = await resp.json();
                if (data.email) {
                    return data.email;
                }
            }

            // Fallback via Gmail profile
            const gmailResp = await gapi.client.gmail.users.getProfile({
                userId: "me"
            });
            return gmailResp.result.emailAddress;
        } catch (e) {
            console.error("Error getting user email:", e);
            throw e;
        }
    }

    // ======== ACCESS CONTROL (Unchanged) =========
    async function checkUserAccess(email) {
        try {
            console.log("Checking access for:", email);

            const response = await fetch(
                `${ACCESS_CHECK_URL}?action=checkAccess&email=${encodeURIComponent(email)}`,
                {
                    method: "GET",
                    mode: "cors"
                }
            );

            if (!response.ok) {
                console.error("Access check request failed:", response.status);
                return false;
            }

            const data = await response.json();
            console.log("Access check response:", data);

            return data.hasAccess === true;
        } catch (error) {
            console.error("Error checking user access:", error);
            return false;
        }
    }

    // ======== SIGN OUT (Unchanged, but note on refresh token) =========
    function handleSignOut() {
        // NOTE: This revokes the access_token. 
        // For full sign-out, you should ALSO revoke the refresh_token
        // This requires *another* backend call. For simplicity,
        // we are just revoking the client-side token.
        // The refresh token will remain stored in your Apps Script.

        const tokenObj = gapi.client.getToken();
        const tokenToRevoke = tokenObj && tokenObj.access_token;

        if (tokenToRevoke) {
            fetch(
                "https://oauth2.googleapis.com/revoke?token=" +
                    encodeURIComponent(tokenToRevoke),
                {
                    method: "POST",
                    headers: {
                        "Content-type": "application/x-www-form-urlencoded"
                    }
                }
            ).catch((err) => {
                console.warn("Token revoke failed (non-blocking):", err);
            });
        }

        // Clear local app state
        gapi.client.setToken(null);
        sessionAccessToken = null; // <-- Use new variable name
        userEmail = null;
        userHasAccess = false;

        showAuthArea();
    }

    // ======== FILE ATTACHMENT / MESSAGE UI (Unchanged) =========
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e2) => {
                previewImage.src = e2.target.result;
                filePreview.classList.remove("hidden");
                updateSendButton();
            };
            reader.readAsDataURL(file);
        }
    }

    function removeFile() {
        selectedFile = null;
        filePreview.classList.add("hidden");
        fileInput.value = "";
        updateSendButton();
    }

    function updateSendButton() {
        const canSend =
            messageInput.value.trim() !== "" || selectedFile !== null;
        sendButton.disabled = !canSend;
    }

    // ======== EMAIL SEND VIA GMAIL API (Unchanged) =========
    async function sendEmail() {
        if (!userEmail || !userHasAccess) {
            logMessage("Error: Access denied or not signed in.", "error");
            return;
        }
        if (!messageInput.value.trim() && !selectedFile) return;

        logMessage(`Sending email...`, "info");
        sendButton.disabled = true;

        const boundary = "----boundary_" + Date.now();
        const headers = [
            `To: ${RECIPIENT_EMAIL}`,
            `From: ${userEmail}`,
            `Subject: Message from ${userEmail}`,
            `MIME-Version: 1.0`,
            `Content-Type: multipart/mixed; boundary="${boundary}"`
        ];

        let emailContent = headers.join("\r\n") + "\r\n\r\n";

        if (messageInput.value.trim()) {
            emailContent +=
                `--${boundary}\r\n` +
                `Content-Type: text/plain; charset=utf-8\r\n\r\n` +
                `${messageInput.value.trim()}\r\n\r\n`;
        }

        if (selectedFile) {
            const fileData = await fileToBase64(selectedFile);
            emailContent +=
                `--${boundary}\r\n` +
                `Content-Type: ${selectedFile.type}; name="${selectedFile.name}"\r\n` +
                `Content-Disposition: attachment; filename="${selectedFile.name}"\r\n` +
                `Content-Transfer-Encoding: base64\r\n\r\n` +
                `${fileData.split(",")[1]}\r\n\r\n`;
        }

        emailContent += `--${boundary}--`;

        // Base64URL encode per Gmail API spec
        const base64Encoded = btoa(unescape(encodeURIComponent(emailContent)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/, "");

        try {
            await gapi.client.gmail.users.messages.send({
                userId: "me",
                resource: { raw: base64Encoded }
            });
            logMessage("Message sent", "success");
            messageInput.value = "";
            removeFile();
        } catch (err) {
            logMessage(
                `Failed to send email: ${
                    err.result?.error?.message || "Unknown error"
                }`,
                "error"
            );
        } finally {
            updateSendButton();
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = (err) => reject(err);
        });
    }

    function logMessage(msg, type) {
        // Clear placeholder
        if (messageLog.children.length === 1 && messageLog.children[0].textContent.includes("...")) {
            messageLog.innerHTML = "";
        }
        
        const div = document.createElement("div");
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        div.className = `text-sm mb-1 ${
            type === "error"
                ? "text-red-600"
                : type === "success"
                ? "text-green-600"
                : "text-gray-700"
        }`;
        messageLog.appendChild(div);
        messageLog.scrollTop = messageLog.scrollHeight;
    }

    // ======== CALENDAR DISPLAY (Unchanged) =========
    function displayMonthlyCalendar() {
        if (!gapi_loaded || !userHasAccess) return;

        const calendarEl = document.getElementById("calendar-container");

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,timeGridWeek"
            },
            navLinks: true,
            editable: false, // Set to true if you want drag-and-drop (requires write scope)
            dayMaxEvents: true,
            events: fetchGoogleCalendarEvents,
            eventClick: handleEventClick,
            height: "100%",
            eventTimeFormat: {
                hour: 'numeric',
                minute: '2-digit',
                meridiem: 'short'
            }
        });

        calendar.render();
    }

    async function fetchGoogleCalendarEvents(fetchInfo, successCallback, failureCallback) {
        try {
            const response = await gapi.client.calendar.events.list({
                calendarId: "primary",
                timeMin: fetchInfo.start.toISOString(),
                timeMax: fetchInfo.end.toISOString(),
                showDeleted: false,
                singleEvents: true,
                maxResults: 250,
                orderBy: "startTime"
            });

            const events = response.result.items.map((event) => ({
                id: event.id,
                title: event.summary || "No Title",
                start: event.start.dateTime || event.start.date,
                end: event.end.dateTime || event.end.date,
                allDay: !!event.start.date,
                url: event.htmlLink,
                description: event.description,
                location: event.location,
            }));
            successCallback(events);
        } catch (err) {
            logMessage(`Failed to fetch calendar events: ${err.result?.error?.message}`, "error");
            failureCallback(err);
        }
    }

    function handleEventClick(clickInfo) {
        eventTitle.textContent = clickInfo.event.title;
        
        const start = clickInfo.event.start;
        const end = clickInfo.event.end;
        let timeString = "";
        
        if (clickInfo.event.allDay) {
            timeString = "All-day";
            // FullCalendar all-day events end date is exclusive, so subtract one day for display
            if (end) {
                const endDate = new Date(end);
                endDate.setDate(endDate.getDate() - 1);
                if (endDate.getTime() > start.getTime()) {
                     timeString = `All-day, ${start.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
                } else {
                     timeString = `All-day, ${start.toLocaleDateString()}`;
                }
            } else {
                 timeString = `All-day, ${start.toLocaleDateString()}`;
            }
        } else {
             timeString = start.toLocaleString(undefined, {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
            if (end) {
                timeString += ` - ${end.toLocaleTimeString(undefined, { timeStyle: 'short' })}`;
            }
        }

        eventTime.textContent = timeString;
        
        eventDescription.textContent = clickInfo.event.extendedProps.description || "No description provided.";
        eventDescription.style.display = clickInfo.event.extendedProps.description ? "block" : "none";

        eventLocation.textContent = clickInfo.event.extendedProps.location || "No location provided.";
        eventLocation.style.display = clickInfo.event.extendedProps.location ? "block" : "none";
        
        eventLink.href = clickInfo.event.url;
        eventModal.classList.remove("hidden");
    }
})();
</script>

</body>
</html>
