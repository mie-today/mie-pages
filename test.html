<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
    // This function is called when the user signs in.
    window.handleCredentialResponse = function(response) {
        console.log('GIS credential received', response);
        if (!response.credential) {
            console.error('No credential returned.');
            return;
        }
        // The rest of the logic to get an access token will be handled
        // by the main script block after GAPI is initialized.
        document.dispatchEvent(new CustomEvent('gis-credential-received'));
    };
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6; /* full light mode */
        color: #1f2937;
        margin: 0;
        padding: 0;
    }

    /* Scrollbars - light mode */
    .oauth-app-container #message-log::-webkit-scrollbar,
    .oauth-app-container #event-list::-webkit-scrollbar { width: 8px; height: 8px; }
    .oauth-app-container #message-log::-webkit-scrollbar-track,
    .oauth-app-container #event-list::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 9999px; }
    .oauth-app-container #message-log::-webkit-scrollbar-thumb,
    .oauth-app-container #event-list::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 9999px; }

    .oauth-app-container .flex-grow-scroll { overflow-y: auto; flex-grow: 1; }
    .disabled, :disabled { opacity: 0.5; cursor: not-allowed; }

    .oauth-app-container { max-width: 100%; margin: 0 auto; }

    /* MOBILE 350x860 */
    @media (max-width: 480px) {
        .oauth-app-container { width: 350px !important; height: 660px !important; overflow: hidden !important; margin: 0 auto !important; }
        .mobile-container { padding: 1px !important; gap: 1px !important; height: 100% !important; display: flex; flex-direction: column; }
        .calendar-section { width: 100% !important; height: 300px !important; padding: 4px !important; overflow: hidden !important; flex-shrink: 0; }
        .messaging-section { width: 100% !important; height: 280px !important; padding: 4px !important; overflow: hidden !important; flex-shrink: 0; }
        .mobile-heading-17pt { font-size: 22.67px !important; line-height: 1.2 !important; }
        .mobile-text-14pt { font-size: 18.67px !important; line-height: 1.2 !important; }
        .mobile-text-12pt { font-size: 16px !important; line-height: 1.1 !important; }
        .mobile-textarea { height: 50px !important; padding: 4px 8px !important; }
        .mobile-message-log { height: 70px !important; padding: 4px !important; }
        .mobile-small-btn { padding: 3px 6px !important; font-size: 12px !important; }
        .mobile-text-14pt-btn { font-size: 18.67px !important; }
        .fc .fc-toolbar-title { font-size: 22.67px !important; }
        .fc .fc-button-primary { font-size: 16px !important; padding: 4px 8px !important; }
        .fc .fc-col-header-cell { font-size: 14px !important; }
        .fc .fc-daygrid-day-number { font-size: 14px !important; }
        .fc .fc-event { font-size: 11px !important; }
    }

    /* Tablet */
    @media (min-width: 481px) and (max-width: 768px) {
        .oauth-app-container { width: 481px; }
        .calendar-section { width: 481px; height: 632px; }
        .messaging-section { width: 481px; height: 316px; }
    }

    /* Desktop */
    @media (min-width: 769px) {
        .oauth-app-container { width: 800px; }
        .calendar-section { width: 800px; height: 860px; }
        .messaging-section { width: 800px; height: 360px; }
    }

    /* FullCalendar light mode */
    .fc { color: #1f2937 !important; background-color: #ffffff !important; }
    .fc .fc-button-primary { background-color: #3b82f6 !important; border-color: #2563eb !important; color: white !important; }
    .fc .fc-button-primary:hover { background-color: #2563eb !important; }
    .fc .fc-button-primary:disabled { background-color: #9ca3af !important; border-color: #6b7280 !important; }
    .fc-daygrid-day.fc-day-today { background-color: rgba(59, 130, 246, 0.1) !important; }
    .fc .fc-daygrid-day-frame { background-color: white !important; }
    .fc .fc-col-header-cell { background-color: #f8fafc !important; color: #1f2937 !important; }
    .fc .fc-daygrid-day-number { color: #1f2937 !important; }
    .fc .fc-event { border-color: #3b82f6 !important; background-color: #3b82f6 !important; color: white !important; }
    .fc .fc-toolbar-title { color: #1f2937 !important; }
    .fc .fc-daygrid-day.fc-day-other { display: none !important; }

    /* Event modal - light mode */
    .event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .event-modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); color: #1f2937; }
    @media (max-width: 480px){ .event-modal-content { max-width: 320px !important; padding: 16px !important; } }
</style>
</head>
<body>

<div class="oauth-app-container">
    <div class="flex flex-col space-y-4 p-4 mobile-container">

        <div id="calendar-section" class="calendar-section bg-white rounded-xl shadow-lg p-4 flex flex-col">
            <div id="auth-area" class="flex flex-col items-center justify-center space-y-4 h-full">
                <h2 class="text-lg md:text-xl lg:text-2xl mobile-heading-17pt font-semibold text-center">Sign in to view your Google Calendar</h2>
                <div id="g_id_onload"
                     data-client_id="514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com"
                     data-context="signin"
                     data-ux_mode="popup"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
            </div>
            <div id="calendar-content" class="hidden flex flex-col h-full">
                <div class="flex justify-end mb-2">
                    <button id="signout_button" class="bg-red-600 hover:bg-red-700 text-white text-xs mobile-small-btn py-1 px-2 rounded-md">Sign Out</button>
                </div>
                <div id="calendar-container" class="flex-1 min-h-0"></div>
            </div>
        </div>

        <div id="messaging-section" class="messaging-section bg-white rounded-xl shadow-lg p-4 flex flex-col hidden">
            <h2 class="text-lg md:text-xl lg:text-2xl mobile-heading-17pt font-semibold mb-2">Send a Message</h2>
            <div id="message-log" class="bg-gray-50 p-2 rounded-lg flex-1 overflow-y-auto mb-2 mobile-message-log">
                <div class="text-sm mobile-text-12pt text-gray-500">Your sent messages will appear here...</div>
            </div>
            <textarea id="message-input" placeholder="Type your message..." class="rounded-2xl border border-gray-300 px-3 py-2 bg-white text-gray-900 resize-none h-20 mobile-textarea"></textarea>
            <div class="flex items-center space-x-2 mt-2">
                <label for="file-input" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-full mobile-text-12pt">Add Image</label>
                <input id="file-input" type="file" class="hidden" accept="image/*">
                <div id="file-preview" class="hidden flex items-center space-x-2">
                    <img id="preview-image" class="w-16 h-16 object-cover rounded border" alt="Preview">
                    <button id="remove-file" class="text-red-500 text-sm mobile-text-12pt">Remove</button>
                </div>
            </div>
            <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:bg-blue-300 w-full mobile-text-14pt-btn mt-2" disabled>Send</button>
        </div>

    </div>
</div>

<div id="event-modal" class="event-modal hidden">
    <div class="event-modal-content">
        <div class="flex justify-between items-start mb-4">
            <h3 id="event-title" class="text-xl mobile-heading-17pt font-semibold"></h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl mobile-heading-17pt">&times;</button>
        </div>
        <div id="event-details" class="space-y-2">
            <p id="event-time" class="text-gray-600 mobile-text-14pt"></p>
            <p id="event-description" class="text-gray-700 mobile-text-14pt"></p>
            <p id="event-location" class="text-gray-600 mobile-text-14pt"></p>
        </div>
        <div class="mt-4 flex justify-end">
            <a id="event-link" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mobile-text-14pt-btn">Open in Google Calendar</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CONFIGURATION ---
    const CLIENT_ID = "514922143683-ja02ef5sm7ppsv79l216l5c18tlvtmg5.apps.googleusercontent.com";
    // IMPORTANT: Add your API Key here. Get it from Google Cloud Console.
    const API_KEY = "YOUR_API_KEY"; 
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email";

    // --- DOM ELEMENTS ---
    const authArea = document.getElementById('auth-area');
    const calendarContent = document.getElementById('calendar-content');
    const messagingSection = document.getElementById('messaging-section');
    const signoutButton = document.getElementById('signout_button');
    const sendButton = document.getElementById('send-button');
    const messageInput = document.getElementById('message-input');
    const messageLog = document.getElementById('message-log');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const previewImage = document.getElementById('preview-image');
    const removeFileButton = document.getElementById('remove-file');
    const eventModal = document.getElementById('event-modal');
    const closeModalButton = document.getElementById('close-modal');

    let tokenClient;
    let calendar;
    let attachedFile = null;
    let userEmail = '';

    // --- INITIALIZATION ---
    gapi.load('client', initializeGapiClient);

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: tokenCallback,
        });
        // Listen for the custom event from the head script
        document.addEventListener('gis-credential-received', () => {
             tokenClient.requestAccessToken({ prompt: '' });
        });
    }
    
    // --- AUTHENTICATION ---
    async function tokenCallback(tokenResponse) {
        if (tokenResponse && tokenResponse.access_token) {
            gapi.client.setToken(tokenResponse);
            toggleUI(true); // User is authenticated
            const userInfo = await gapi.client.oauth2.userinfo.get();
            userEmail = userInfo.result.email;
            console.log('User signed in:', userEmail);
            loadCalendarEvents();
        } else {
            console.error('Failed to get access token.', tokenResponse);
        }
    }

    signoutButton.onclick = () => {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                toggleUI(false); // User is signed out
                userEmail = '';
                console.log('User signed out.');
            });
        }
    };

    // --- UI MANAGEMENT ---
    function toggleUI(isAuthenticated) {
        if (isAuthenticated) {
            authArea.classList.add('hidden');
            calendarContent.classList.remove('hidden');
            messagingSection.classList.remove('hidden');
        } else {
            authArea.classList.remove('hidden');
            calendarContent.classList.add('hidden');
            messagingSection.classList.add('hidden');
            if (calendar) calendar.removeAllEvents();
        }
    }

    // --- CALENDAR LOGIC ---
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar-container');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            eventClick: handleEventClick,
            height: '100%',
        });
        calendar.render();
    }
    
    async function loadCalendarEvents() {
        try {
            const response = await gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 250,
                'orderBy': 'startTime'
            });

            const events = response.result.items.map(event => ({
                title: event.summary,
                start: event.start.dateTime || event.start.date,
                end: event.end.dateTime || event.end.date,
                extendedProps: {
                    description: event.description,
                    location: event.location,
                    link: event.htmlLink,
                }
            }));
            
            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(events);
            }

        } catch (err) {
            console.error('Error fetching calendar events:', err);
        }
    }

    // --- EVENT MODAL ---
    function handleEventClick(info) {
        const { title, extendedProps } = info.event;
        const start = info.event.start;

        document.getElementById('event-title').textContent = title;
        document.getElementById('event-time').textContent = `When: ${start.toLocaleString()}`;
        document.getElementById('event-description').innerHTML = extendedProps.description ? `Description: ${extendedProps.description}` : 'No description provided.';
        document.getElementById('event-location').textContent = extendedProps.location ? `Location: ${extendedProps.location}` : '';
        document.getElementById('event-link').href = extendedProps.link;
        
        eventModal.classList.remove('hidden');
    }

    closeModalButton.onclick = () => eventModal.classList.add('hidden');
    eventModal.onclick = (e) => {
        if (e.target === eventModal) eventModal.classList.add('hidden');
    };

    // --- MESSAGING LOGIC ---
    messageInput.addEventListener('input', () => {
        sendButton.disabled = messageInput.value.trim() === '';
    });

    sendButton.onclick = async () => {
        const messageText = messageInput.value.trim();
        if (messageText === '' || !userEmail) return;

        sendButton.disabled = true;
        sendButton.textContent = 'Sending...';

        try {
            await sendMessage(messageText, attachedFile);
            logMessage(messageText, 'sent');
            messageInput.value = '';
            removeAttachment();
        } catch (error) {
            console.error('Error sending message:', error);
            logMessage('Failed to send message.', 'error');
        } finally {
            sendButton.disabled = false;
            sendButton.textContent = 'Send';
        }
    };
    
    function sendMessage(body, file) {
        const to = userEmail; // Sending to self as an example
        const subject = 'Message from My Dashboard';
        
        const boundary = "-------314159265358979323846";
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        let message = `To: ${to}\r\n`;
        message += `Subject: ${subject}\r\n`;
        message += "MIME-Version: 1.0\r\n";
        message += `Content-Type: multipart/mixed; boundary="${boundary}"\r\n\r\n`;

        message += delimiter;
        message += 'Content-Type: text/plain; charset="UTF-8"\r\n\r\n';
        message += body;

        if (file) {
             message += delimiter;
             message += `Content-Type: ${file.type}; name="${file.name}"\r\n`;
             message += "Content-Transfer-Encoding: base64\r\n\r\n";
             message += file.data;
        }

        message += close_delim;

        const rawMessage = btoa(message).replace(/\+/g, '-').replace(/\//g, '_');

        return gapi.client.gmail.users.messages.send({
            'userId': 'me',
            'resource': { 'raw': rawMessage }
        });
    }
    
    function logMessage(text, type) {
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        logEntry.className = 'text-sm mobile-text-12pt p-1 rounded';
        logEntry.style.color = type === 'error' ? '#ef4444' : '#1f2937';
        messageLog.appendChild(logEntry);
        // Clear placeholder text
        if (messageLog.children.length === 2 && messageLog.children[0].textContent.includes('appear here')) {
            messageLog.children[0].remove();
        }
        messageLog.scrollTop = messageLog.scrollHeight;
    }

    // --- FILE ATTACHMENT ---
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            previewImage.src = event.target.result;
            filePreview.classList.remove('hidden');
            attachedFile = {
                name: file.name,
                type: file.type,
                data: event.target.result.split(',')[1] // Get base64 part
            };
        };
        reader.readAsDataURL(file);
    };

    removeFileButton.onclick = removeAttachment;

    function removeAttachment() {
        fileInput.value = ''; // Reset the file input
        filePreview.classList.add('hidden');
        previewImage.src = '';
        attachedFile = null;
    }
    
    // --- STARTUP ---
    initializeCalendar();
});
</script>

</body>
</html>
